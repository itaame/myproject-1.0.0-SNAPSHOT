import{a as C,b as A}from"./chunk-SAZ6MTOG.js";var Yu=class{writeInfo(t){console.log(t)}writeError(t){console.error(t)}writeWarning(t){console.warn(t)}},Xu=class{openConfirmDialog(t,e){return confirm(e)}openInformationDialog(t,e){alert(e)}openWarningDialog(t,e){alert(e)}openErrorDialog(t,e){alert(e)}openPasswordDialog(t,e,i){let r=prompt(e);return r?r===i:!1}},m=class X{constructor(e,i,r,s=255){this.red=e,this.green=i,this.blue=r,this.alpha=s}static TRANSPARENT=new X(0,0,0,0);static BLACK=new X(0,0,0);static BLUE=new X(0,0,255);static CYAN=new X(0,255,255);static DARK_GRAY=new X(150,150,150);static GRAY=new X(200,200,200);static GREEN=new X(0,255,0);static LIGHT_BLUE=new X(153,186,243);static ORANGE=new X(255,128,0);static PINK=new X(255,0,255);static PURPLE=new X(128,0,255);static RED=new X(255,0,0);static WHITE=new X(255,255,255);static YELLOW=new X(255,255,0);static BUTTON=new X(239,240,241);static BUTTON_DARKER=new X(164,168,172);static BUTTON_DARKEST=X.BLACK;static BUTTON_LIGHTEST=X.WHITE;withAlpha(e){return new X(this.red,this.green,this.blue,e)}mixWith(e,i){let r=Math.floor(this.red*i+e.red*(1-i)),s=Math.floor(this.green*i+e.green*(1-i)),o=Math.floor(this.blue*i+e.blue*(1-i));return new X(r,s,o)}brighter(){let{red:e,green:i,blue:r}=this,s=Math.floor(1/(1-.7));return e===0&&i===0&&r===0?new X(s,s,s):(e>0&&e<s&&(e=s),i>0&&i<s&&(i=s),r>0&&r<s&&(r=s),new X(Math.min(Math.floor(this.red/.7),255),Math.min(Math.floor(this.green/.7),255),Math.min(Math.floor(this.blue/.7),255)))}darker(){return new X(Math.max(Math.floor(this.red*.7),0),Math.max(Math.floor(this.green*.7),0),Math.max(Math.floor(this.blue*.7),0))}contrast(){return new X(this.red,255-this.green,255-this.blue)}hex(){let e=this.red.toString(16);e=e.length==1?"0"+e:e;let i=this.green.toString(16);i=i.length==1?"0"+i:i;let r=this.blue.toString(16);r=r.length==1?"0"+r:r;let s=this.alpha.toString(16);return s=s.length==1?"0"+s:s,`#${e}${i}${r}${s}`}getRGBValue(){return this}equals(e){return e&&this.toString()===e.toString()}toString(){return`rgba(${this.red},${this.green},${this.blue},${this.alpha})`}},We=t=>(document.removeEventListener("click",We,!0),t.preventDefault(),t.stopPropagation(),!1);function ye(t){return(t.buttons&1)===1||t.buttons===void 0&&t.which==1}var gi=5;function Ku(t,e,i,r){return Math.sqrt((i-t)*(i-t)+(r-e)*(r-e))}function mi(t,e){return t&&e&&t.id===e.id}var ju=class{constructor(t,e,i){this.display=t,this.canvas=e,this.hitCanvas=i,e.addEventListener("click",r=>this.onCanvasClick(r),!1),e.addEventListener("mousedown",r=>this.onCanvasMouseDown(r),!1),e.addEventListener("mouseup",r=>this.onCanvasMouseUp(r),!1),e.addEventListener("mouseout",r=>this.onCanvasMouseOut(r),!1),e.addEventListener("mousemove",r=>this.onCanvasMouseMove(r),!1)}grabbing=!1;grabTarget;grabPoint;documentMouseMoveListener=t=>this.onDocumentMouseMove(t);documentMouseUpListener=t=>this.onDocumentMouseUp(t);prevEnteredRegion;toPoint(t){let e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}onCanvasClick(t){this.display.clearSelection();let e=this.toPoint(t);if(this.display.editMode)this.selectSingleWidget(e.x,e.y);else{let i=this.hitCanvas.getActiveRegion(e.x,e.y);i&&i.click&&i.click({clientX:t.clientX,clientY:t.clientY,point:e})}}onCanvasMouseDown(t){if(!this.display.editMode&&(document.removeEventListener("click",We,!0),ye(t))){let e=this.toPoint(t),i=this.hitCanvas.getActiveRegion(e.x,e.y);return i&&i.mouseDown&&i.mouseDown({clientX:t.clientX,clientY:t.clientY,point:e}),i&&i.grab&&(this.grabPoint=C({},e),this.grabTarget=i),t.preventDefault(),t.stopPropagation(),!1}}onCanvasMouseUp(t){if(this.display.editMode)return;let e=this.toPoint(t),i=this.hitCanvas.getActiveRegion(e.x,e.y);i&&i.mouseUp&&i.mouseUp()}onCanvasMouseOut(t){this.prevEnteredRegion&&this.prevEnteredRegion.mouseOut&&this.prevEnteredRegion.mouseOut(),this.prevEnteredRegion=void 0,t.preventDefault(),t.stopPropagation()}onCanvasMouseMove(t){let e=this.toPoint(t),i=this.hitCanvas.getActiveRegion(e.x,e.y);this.prevEnteredRegion&&this.prevEnteredRegion.mouseOut&&(mi(this.prevEnteredRegion,i)||this.prevEnteredRegion.mouseOut()),i&&i.mouseEnter&&(mi(this.prevEnteredRegion,i)||i.mouseEnter()),this.prevEnteredRegion=i;let r=i&&i.cursor?i.cursor:"auto";if(r!=this.canvas.style.cursor&&(this.canvas.style.cursor=r),!this.grabbing&&i&&i.tooltip?this.display.setTooltip(i.tooltip()):this.display.setTooltip(void 0),this.grabPoint&&!this.grabbing&&ye(t)){let s=Ku(this.grabPoint.x,this.grabPoint.y,e.x,e.y);Math.abs(s)>gi&&(this.initiateGrab(),gi>0&&this.grabPoint&&(this.grabPoint=e))}this.grabbing&&this.grabTarget&&ye(t)&&this.grabTarget.grab({clientX:t.clientX,clientY:t.clientY,point:e,dx:e.x-this.grabPoint.x,dy:e.y-this.grabPoint.y})}initiateGrab(){document.addEventListener("click",We,!0),document.addEventListener("mouseup",this.documentMouseUpListener),document.addEventListener("mousemove",this.documentMouseMoveListener),this.grabbing=!0}onDocumentMouseUp(t){if(this.grabbing){document.removeEventListener("mouseup",this.documentMouseUpListener),document.removeEventListener("mousemove",this.documentMouseMoveListener);let e=this.grabTarget;this.grabbing=!1,this.grabPoint=void 0,this.grabTarget=void 0,e?.grabEnd&&e.grabEnd()}}onDocumentMouseMove(t){this.onCanvasMouseMove(t)}selectSingleWidget(t,e){let i=this.display.instance;if(i)for(let r of i.widgets.slice().reverse()){let s=r.holderX,o=r.holderY,a=r.holderX+r.holderWidth,h=r.holderY+r.holderHeight;if(s<t&&t<a&&o<e&&e<h)return this.display.selection=[r.wuid],!1}}},Zu=class{constructor(t){this.utc=t}formatDate(t,e){let i=this.utc,r="";if(e.year&&(r+=i?t.getUTCFullYear():t.getFullYear()),e.month){e.year&&(r+="-");let s=(i?t.getUTCMonth():t.getMonth())+1;r+=(s<10?"0":"")+s}if(e.day){e.month&&(r+="-");let s=i?t.getUTCDate():t.getDate();r+=(s<10?"0":"")+s}return r}formatTime(t,e){let i=this.utc,r="";if(e.hours){let s=i?t.getUTCHours():t.getHours();r+=(s<10?"0":"")+s}if(e.minutes){e.hours&&(r+=":");let s=i?t.getUTCMinutes():t.getMinutes();r+=(s<10?"0":"")+s}if(e.seconds){e.minutes&&(r+=":");let s=i?t.getUTCSeconds():t.getSeconds();r+=(s<10?"0":"")+s}if(e.milliseconds){e.seconds&&(r+=".");let s=i?t.getUTCMilliseconds():t.getMilliseconds();r+=(s<10?"00":s<100?"0":"")+s}return r}},fi="rgb(255,255,255)",Ju=!!navigator.brave,Qu=class Ad{constructor(e,i,r){this.parent=e;let s=document.createElement("canvas");s.width=i??s.width,s.height=r??s.height,this.ctx=s.getContext("2d",{willReadFrequently:!0}),this.root=e?.root||e}ctx;regionsByColor=new Map;root;clear(){this.regionsByColor.clear(),this.ctx.fillStyle=fi,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}beginHitRegion(e){let i=(this.root||this).generateUniqueColor(e);return this.ctx.beginPath(),this.ctx.fillStyle=i,i}getActiveRegion(e,i){let r=this.ctx.getImageData(e,i,1,1).data,s=`rgb(${r[0]},${r[1]},${r[2]})`;return this.regionsByColor.get(s)||void 0}createChild(e,i){return new Ad(this,e,i)}transferToParent(e,i,r,s){if(!this.parent)throw new Error("No parent to transfer to");this.parent.ctx.drawImage(this.ctx.canvas,e,i,r,s)}generateUniqueColor(e){for(;;){let i=Math.round(Math.random()*255),r=Math.round(Math.random()*255),s=Math.round(Math.random()*255),o=`rgb(${i},${r},${s})`;if(!this.regionsByColor.has(o)&&o!==fi)return Ju?(this.regionsByColor.set(`rgb(${i-1},${r-1},${s-1})`,e),this.regionsByColor.set(`rgb(${i-1},${r-1},${s})`,e),this.regionsByColor.set(`rgb(${i-1},${r-1},${s+1})`,e),this.regionsByColor.set(`rgb(${i-1},${r},${s-1})`,e),this.regionsByColor.set(`rgb(${i-1},${r},${s})`,e),this.regionsByColor.set(`rgb(${i-1},${r},${s+1})`,e),this.regionsByColor.set(`rgb(${i-1},${r+1},${s-1})`,e),this.regionsByColor.set(`rgb(${i-1},${r+1},${s})`,e),this.regionsByColor.set(`rgb(${i-1},${r+1},${s+1})`,e),this.regionsByColor.set(`rgb(${i},${r-1},${s-1})`,e),this.regionsByColor.set(`rgb(${i},${r-1},${s})`,e),this.regionsByColor.set(`rgb(${i},${r-1},${s+1})`,e),this.regionsByColor.set(`rgb(${i},${r},${s-1})`,e),this.regionsByColor.set(`rgb(${i},${r},${s})`,e),this.regionsByColor.set(`rgb(${i},${r},${s+1})`,e),this.regionsByColor.set(`rgb(${i},${r+1},${s-1})`,e),this.regionsByColor.set(`rgb(${i},${r+1},${s})`,e),this.regionsByColor.set(`rgb(${i},${r+1},${s+1})`,e),this.regionsByColor.set(`rgb(${i+1},${r-1},${s-1})`,e),this.regionsByColor.set(`rgb(${i+1},${r-1},${s})`,e),this.regionsByColor.set(`rgb(${i+1},${r-1},${s+1})`,e),this.regionsByColor.set(`rgb(${i+1},${r},${s-1})`,e),this.regionsByColor.set(`rgb(${i+1},${r},${s})`,e),this.regionsByColor.set(`rgb(${i+1},${r},${s+1})`,e),this.regionsByColor.set(`rgb(${i+1},${r+1},${s-1})`,e),this.regionsByColor.set(`rgb(${i+1},${r+1},${s})`,e),this.regionsByColor.set(`rgb(${i+1},${r+1},${s+1})`,e)):this.regionsByColor.set(o,e),o}}};function Ft(t,e,i,r,s){return U({x:t,y:e,width:i,height:r},s/2)}function $t(t,e,i,r,s){let o=Math.sin(s),a=Math.cos(s),h=t-i,l=e-r;return{x:h*a-l*o+i,y:h*o+l*a+r}}function U(t,e,i){return i===void 0&&(i=e),{x:t.x+i,y:t.y+e,width:t.width-(i+i),height:t.height-(e+e)}}function xi(t){return{x:Math.round(t.x)+.5,y:Math.round(t.y)+.5,width:Math.round(t.width),height:Math.round(t.height)}}function tp(t,e){let i=t.x,r=t.y,s=i+t.width,o=r+t.height;if(s<i){let g=i;i=s,s=g}if(o<r){let g=r;r=o,o=g}let a=e.x,h=e.y,l=a+e.width,d=h+e.height;if(l<a){let g=a;a=l,l=g}if(d<h){let g=h;h=d,d=g}let n=Math.max(i,a),p=Math.max(r,h);return{x:n,y:p,width:Math.min(s,l)-n,height:Math.min(o,d)-p}}function Pt(t,e,i){return{x:t.x+e,y:t.y+i}}function se(t,e,i){return t.map(r=>Pt(r,e,i))}function $(t){return t*Math.PI/180}function xt(t,e,i){let r=Math.floor(t*Math.cos(e)),s=Math.floor(-t*Math.sin(e));return{x:i.x+i.width/2+r,y:i.y+i.height/2+s}}function _d(t,e){let i=e.x-t.x,r=e.y-t.y,s=Math.sqrt(Math.pow(i,2)+Math.pow(r,2)),o=Math.acos(i/s);return r>0&&(o=2*Math.PI-o),new kt(Math.floor(s),o)}var kt=class{constructor(t,e){this.r=t,this.theta=e}toPoint(){let t=Math.floor(this.r*Math.cos(this.theta)),e=Math.floor(-this.r*Math.sin(this.theta));return{x:t,y:e}}};function oe(t,e){return t.map(i=>({x:i.x*e,y:i.y*e}))}function ve(t,e,i,r,s,o,a){t.beginPath(),!o&&!a?t.rect(e,i,r,s):(r<2*o&&(o=r/2),s<2*a&&(a=s/2),t.moveTo(e+o,i),t.lineTo(e+r-o,i),t.quadraticCurveTo(e+r,i,e+r,i+a),t.lineTo(e+r,i+s-a),t.quadraticCurveTo(e+r,i+s,e+r-o,i+s),t.lineTo(e+o,i+s),t.quadraticCurveTo(e,i+s,e,i+s-a),t.lineTo(e,i+a),t.quadraticCurveTo(e,i,e+o,i))}function ae(t,e,i){return t===null?"":typeof t=="string"?t:typeof t=="number"?i===-1?wi(e,t,void 0,3):wi(e,t,i,i):t instanceof Date?t.toISOString().replace("T"," ").replace("Z",""):String(t)}function wi(t,e,i,r){if(e==null||e==null)return"";switch(t){case 0:case 1:let s={minimumFractionDigits:i,maximumFractionDigits:r,useGrouping:!1,roundingMode:"halfEven"};return Intl.NumberFormat("en-US",s).format(e);case 2:return e.toExponential(r).replace("e+","E").toUpperCase();case 3:return"0x"+e.toString(16).toUpperCase();default:return console.warn(`Unexpected format type ${t}`),String(e)}}var ep=class Ld{constructor(e,i){this.canvas=e,this.ctx=e.getContext("2d"),this.hitCanvas=i||new Qu,this.hitCtx=this.hitCanvas.ctx}ctx;hitCanvas;hitCtx;createChild(e,i){let r=this.hitCanvas.createChild(e,i),s=document.createElement("canvas");return s.width=e,s.height=i,new Ld(s,r)}translate(e,i){this.ctx.translate(e,i),this.hitCtx.translate(e,i)}copy(e,i,r){this.ctx.drawImage(e.canvas,i,r),e.hitCanvas.transferToParent(i,r,e.canvas.width,e.canvas.height)}copyFitted(e,i,r,s,o){let{width:a,height:h}=e.canvas,l=a/h,d=s,n=d/l;n>o&&(n=o,d=n*l),this.copyScaled(e,i,r,d,n)}copyScaled(e,i,r,s,o){this.ctx.drawImage(e.canvas,i,r,s,o),e.hitCanvas.transferToParent(i,r,s,o)}clearHitCanvas(){this.hitCanvas.clear()}fillCanvas(e){this.ctx.fillStyle=e.toString(),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}clearCanvas(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}scaleCanvas(e,i){this.ctx.canvas.style.width=e+"px",this.ctx.canvas.style.height=i+"px"}resize(e,i){(this.ctx.canvas.width!=e||this.ctx.canvas.height!=i)&&(this.ctx.canvas.width=e,this.ctx.canvas.height=i,this.hitCanvas.ctx.canvas.width=e,this.hitCanvas.ctx.canvas.height=i)}fillRect(e){"color"in e?this.ctx.fillStyle=e.color.toString():this.ctx.fillStyle=e.gradient,e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),e.rx||e.ry?(ve(this.ctx,e.x,e.y,e.width,e.height,e.rx||0,e.ry||0),this.ctx.fill()):this.ctx.fillRect(e.x,e.y,e.width,e.height),e.opacity!==void 0&&(this.ctx.globalAlpha=1)}fillText(e){this.ctx.textBaseline=e.baseline,this.ctx.textAlign=e.align,this.ctx.font=e.font.getFontString(),this.ctx.fillStyle=e.color.toString(),this.ctx.fillText(e.text,e.x,e.y)}fillEllipse(e){this.ctx.beginPath();let i=e.startAngle||0,r=e.endAngle===void 0?2*Math.PI:e.endAngle;this.ctx.ellipse(e.cx,e.cy,e.rx,e.ry,0,i,r,e.anticlockwise),"color"in e?this.ctx.fillStyle=e.color.toString():this.ctx.fillStyle=e.gradient,e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),this.ctx.fill(),e.opacity!==void 0&&(this.ctx.globalAlpha=1)}strokeEllipse(e){e.dash&&this.ctx.setLineDash(e.dash),this.ctx.lineWidth=e.lineWidth||1,this.ctx.beginPath();let i=e.startAngle||0,r=e.endAngle===void 0?2*Math.PI:e.endAngle;this.ctx.ellipse(e.cx,e.cy,e.rx,e.ry,0,i,r,e.anticlockwise),"color"in e?this.ctx.strokeStyle=e.color.toString():this.ctx.strokeStyle=e.gradient,this.ctx.stroke(),e.dash&&this.ctx.setLineDash([])}measureText(e,i){this.ctx.font=i.getFontString();let r=this.ctx.measureText(e).width,s=i.height;return{width:r,height:s}}createLinearGradient(e,i,r,s){return this.ctx.createLinearGradient(e,i,r,s)}strokeRect(e){e.dash&&this.ctx.setLineDash(e.dash);let i=e.lineWidth||1;if(this.ctx.lineWidth=i,this.ctx.strokeStyle=e.color.toString(),e.crispen&&i){let r=U(e,i/2,i/2);e.rx||e.ry?(ve(this.ctx,r.x,r.y,r.width,r.height,e.rx||0,e.ry||0),this.ctx.stroke()):this.ctx.strokeRect(r.x,r.y,r.width,r.height)}else e.rx||e.ry?(ve(this.ctx,e.x,e.y,e.width,e.height,e.rx||0,e.ry||0),this.ctx.stroke()):this.ctx.strokeRect(e.x,e.y,e.width,e.height);e.dash&&this.ctx.setLineDash([])}strokePath(e){e.dash&&this.ctx.setLineDash(e.dash),this.ctx.beginPath();for(let i of e.path.segments)i.line?this.ctx.lineTo(i.x,i.y):this.ctx.moveTo(i.x,i.y);this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color.toString(),e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),this.ctx.stroke(),e.opacity!==void 0&&(this.ctx.globalAlpha=1),e.dash&&this.ctx.setLineDash([])}fillPath(e){this.ctx.beginPath();for(let i of e.path.segments)i.line?this.ctx.lineTo(i.x,i.y):this.ctx.moveTo(i.x,i.y);"color"in e?this.ctx.fillStyle=e.color.toString():this.ctx.fillStyle=e.gradient,e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),this.ctx.fill("evenodd"),e.opacity!==void 0&&(this.ctx.globalAlpha=1)}addHitRegion(e){return this.hitCanvas.beginHitRegion(e),new ip(this.hitCanvas.ctx)}},S=class Be{segments=[];constructor(e,i){this.segments.push({x:e,y:i,line:!1})}static fromPoints(e){let i=e.findIndex(s=>s.y!==null);if(i===-1){let s=new Be(0,0);return s.segments.length=0,s}let r=new Be(e[i].x,e[i].y);for(let s=i+1;s<e.length;s++){let{x:o,y:a}=e[s];a!==null&&(s>0&&e[s-1].y===null?r.moveTo(o,a):r.lineTo(o,a))}return r}getBoundingBox(){let e={x:this.segments[0].x,y:this.segments[0].y},i={x:this.segments[0].x,y:this.segments[0].y};for(let r=0;r<this.segments.length;r++){let s=this.segments[r];s.x<e.x&&(e.x=s.x),s.x>i.x&&(i.x=s.x),s.y<e.y&&(e.y=s.y),s.y>i.y&&(i.y=s.y)}return{x:e.x,y:e.y,width:i.x-e.x,height:i.y-e.y}}lineTo(e,i){return this.segments.push({x:e,y:i,line:!0}),this}moveTo(e,i){return this.segments.push({x:e,y:i,line:!1}),this}closePath(){let e=this.segments[0];return this.segments.push({x:e.x,y:e.y,line:!0}),this}translate(e,i){for(let r of this.segments)r.x+=e,r.y+=i;return this}},ip=class{constructor(t){this.ctx=t}addRect(t,e,i,r){return this.ctx.fillRect(t,e,i,r),this}addEllipse(t,e,i,r,s,o,a,h){this.ctx.beginPath(),this.ctx.ellipse(t,e,i,r,s,o,a,h),this.ctx.fill()}addPath(t){this.ctx.beginPath();for(let e of t.segments)e.line?this.ctx.lineTo(e.x,e.y):this.ctx.moveTo(e.x,e.y);this.ctx.fill()}},Pd=class{constructor(t,e=[]){this.widget=t;for(let i of e)this.properties.set(i.name,i)}properties=new Map;generators=[];clear(){this.properties.clear()}add(t){this.properties.set(t.name,t)}addGenerator(t){this.generators.push(t)}all(){return this.properties.values()}loadProperty(t,e){if(t.hasNode(e.name)){if(e instanceof kd)e.value=t.getActions(e.name);else if(e instanceof Wd)e.value=t.getAutoScaleWidgets(e.name);else if(e instanceof y)e.value=t.getBoolean(e.name);else if(e instanceof Fe)e.value=t.getColorMap(e.name);else if(e instanceof R)e.value=t.getColor(e.name);else if(e instanceof H)e.value=t.getFloat(e.name);else if(e instanceof O)e.value=t.getFont(e.name);else if(e instanceof b)e.value=t.getInt(e.name);else if(e instanceof $e)e.value=t.getMacros(e.name);else if(e instanceof ne)e.value=t.getPoints(e.name);else if(!(e instanceof Jt))if(e instanceof Rd)e.value=t.getRules(e.name);else if(e instanceof Ed)e.value=t.getScaleOptions(e.name);else if(e instanceof Md)e.value=t.getScripts(e.name);else if(e instanceof _)e.rawValue=t.getString(e.name);else if(e instanceof de)e.value=t.getStringList(e.name);else if(e instanceof Oe)e.value=t.getStringMap(e.name);else if(e instanceof Ie)e.value=t.getStringTable(e.name);else throw new Error(`Property ${e.name} has an unexpected type`)}}loadXMLValues(t){this.properties.forEach(e=>{this.loadProperty(t,e)}),this.resolveStringProperties();for(let e of this.generators)for(let i of e())this.properties.set(i.name,i),this.loadProperty(t,i);this.resolveStringProperties()}resolveStringProperties(){for(let t=0;t<2;t++)this.properties.forEach(e=>{if(e instanceof _){let i=e;i.rawValue!==void 0&&this.widget?e.value=this.widget.expandMacro(i.rawValue):e.value=i.rawValue}})}getProperty(t){return this.properties.get(t)}getValue(t,e=!1){let i=this.properties.get(t);if(i&&i.value!==void 0)return i.value;if(!e)throw new Error(`Missing property ${t}`)}setValue(t,e){let i=this.properties.get(t);if(!i)throw new Error(`Cannot set value of unknown property ${t}`);i.value=e}},Z=class{constructor(t,e){this.name=t,this.defaultValue=e,this.value=e}_value;listeners;get value(){return this._value}set value(t){if(this.value!==t){let e=this._value;if(this._value=t,this.listeners)for(let i of this.listeners)i(t,e)}}addListener(t){this.listeners=this.listeners||[],this.listeners.push(t)}removeListener(t){let e=this.listeners||[],i=e.indexOf(t);i!==-1&&e.splice(i,1)}printScriptValue(t){return String(t)}},_=class extends Z{rawValue;printScriptValue(t){return`"${t.replace('"','\\"')}"`}},Jt=class extends Z{constructor(t,e){super(t),this.pvPropertyName=e}},b=class extends Z{},H=class extends Z{},y=class extends Z{},R=class extends Z{printScriptValue(t){let{red:e,green:i,blue:r}=C({},t);return`ColorFontUtil.getColorFromRGB(${e}, ${i}, ${r})`}},O=class extends Z{printScriptValue(t){let{name:e,height:i,style:r}=C({},t);return`ColorFontUtil.getFont("${e}", ${i}, ${r})`}},Fe=class extends Z{printScriptValue(t){return`${t.code}`}},ne=class extends Z{},kd=class extends Z{},$e=class extends Z{},Md=class extends Z{},de=class extends Z{},Oe=class extends Z{},Ie=class extends Z{},Rd=class extends Z{},Ed=class extends Z{},Wd=class extends Z{},Bd=class{actions=[];hookFirstActionToClick=!1;hookAllActionsToClick=!1;add(t){this.actions.push(t)}isClickable(){return this.actions.length&&(this.hookFirstActionToClick||this.hookAllActionsToClick)}getAction(t){if(!(t>=this.actions.length))return this.actions[t]}toString(){return this.actions.length===1?String(this.actions[0]):`${this.actions.length} actions`}},yi="description",ct=class{properties;constructor(){this.properties=new Pd(null,[new _(yi,"")])}parseNode(t){this.properties.loadXMLValues(t)}get description(){return this.properties.getValue(yi)}},vi="command",bi="command_directory",Ti="wait_time",rp=class extends ct{constructor(){super(),this.properties.add(new _(vi,"")),this.properties.add(new _(bi,"$(user.home)")),this.properties.add(new b(Ti,10))}execute(t){throw new Error("Unsupported action EXECUTE_CMD")}get command(){return this.properties.getValue(vi)}get commandDirectory(){return this.properties.getValue(bi)}get waitTime(){return this.properties.getValue(Ti)}toString(){return`Execute Command ${this.command}`}},sp=["Arial","Arial Black","Courier New","Helvetica","Tahoma","Verdana"],it=class Nt{constructor(e,i,r,s){this.name=e,this.style=r,s?this.height=i:this.height=Math.round(i*16/15)}static ARIAL_9=new Nt("Arial",9,0,!1);static ARIAL_10=new Nt("Arial",10,0,!1);static ARIAL_11=new Nt("Arial",11,0,!1);static ARIAL_12_BOLD=new Nt("Arial",12,1,!1);height;scale(e){return new Nt(this.name,e*this.height,this.style,!0)}getFontString(){return this.style===1?`bold ${this.height}px ${this.name}`:this.style===2?`italic ${this.height}px ${this.name}`:this.style===3?`italic bold ${this.height}px ${this.name}`:(this.style!==0&&console.warn(`Unsupported font style ${this.style}`),`normal ${this.height}px ${this.name}`)}get bold(){return this.style===1||this.style===3}get italic(){return this.style===2||this.style===3}isWebSafe(){return sp.indexOf(this.name)!==-1}},op=class{BLACK=m.BLACK;BLUE=m.BLUE;CYAN=m.CYAN;DARK_GRAY=m.DARK_GRAY;GRAY=m.GRAY;GREEN=m.GREEN;LIGHT_BLUE=m.LIGHT_BLUE;ORANGE=m.ORANGE;PINK=m.PINK;PURPLE=m.PURPLE;RED=m.RED;WHITE=m.WHITE;YELLOW=m.YELLOW;getColorFromRGB(t,e,i){return new m(t,e,i)}getFont(t,e,i){return new it(t,e,i,!1)}},ap=class{constructor(t){this.display=t}writeInfo(t){this.display.getConsoleHandler().writeInfo(t)}writeError(t){this.display.getConsoleHandler().writeError(t)}writeWarning(t){this.display.getConsoleHandler().writeWarning(t)}},hp=class{createDoubleArray(t){return Array(t).fill(0)}createIntArray(t){return Array(t).fill(0)}toJavaDoubleArray(t){return[...t]}toJavaIntArray(t){return[...t]}},lp=class{constructor(t,e){this.spreadsheet=t,this.scriptEngine=e}addModifiedListener(t){}addSelectionChangedListener(t){this.spreadsheet.addSelectionChangedListener(()=>{this.scriptEngine.schedule(()=>{let e=t.selectionChanged;e(this.spreadsheet.getSelection())})})}appendRow(){return this.spreadsheet.appendRow()}deleteColumn(t){this.spreadsheet.deleteColumn(t)}deleteRow(t){this.spreadsheet.deleteRow(t)}getCellText(t,e){return this.spreadsheet.getCellText(t,e)}getColumnCount(){return this.spreadsheet.getColumnCount()}getContent(){return this.spreadsheet.getContent()}getRowCount(){return this.spreadsheet.getRowCount()}getSelection(){return this.spreadsheet.getSelection()}insertColumn(t){this.spreadsheet.insertColumn(t)}insertRow(t){this.spreadsheet.insertRow(t)}isEmpty(){return this.spreadsheet.isEmpty()}refresh(){this.spreadsheet.refresh()}setCellBackground(t,e,i){this.spreadsheet.setCellBackground(t,e,i)}setCellForeground(t,e,i){this.spreadsheet.setCellForeground(t,e,i)}setCellText(t,e,i){this.spreadsheet.setCellText(t,e,i)}setColumnCellEditorData(t,e){this.spreadsheet.setColumnCellEditorData(t,e)}setColumnsCount(t){this.spreadsheet.setColumnsCount(t)}setContent(t){this.spreadsheet.setContent(t)}setRowBackground(t,e){this.spreadsheet.setRowBackground(t,e)}setRowForeground(t,e){this.spreadsheet.setRowForeground(t,e)}revealRow(t){}},He=class{constructor(t,e,i){this.code=t,this.interpolate=e,this.autoscale=i,t===0||(t===1?(this.values=[0,1],this.colors=[[0,0,0],[255,255,255]]):t===2?(this.values=[0,.111,.365,.619,.873,1],this.colors=[[0,0,143],[0,0,255],[0,255,255],[255,255,0],[255,0,0],[128,0,0]]):t===3?(this.values=[0,.126,.251,.375,.5,.625,.749,.874,1],this.colors=[[0,0,0],[255,0,255],[0,0,255],[0,255,255],[0,255,0],[255,255,0],[255,128,0],[255,0,0],[255,255,255]]):t===4?(this.values=[0,.365,.746,1],this.colors=[[11,0,0],[255,0,0],[255,255,0],[255,255,255]]):t===5?(this.values=[0,1],this.colors=[[0,255,255],[255,0,255]]):t===6&&(this.values=[0,.5,1],this.colors=[[0,0,0],[255,0,0],[255,255,255]]))}values=[];colors=[];entries=[];dirty=!0;addMapping(t,e,i,r){this.values.push(t),this.colors.push([e,i,r]),this.dirty=!0}compile(){this.entries.length=0;for(let t=0;t<this.values.length;t++)this.entries.push([this.values[t],this.colors[t]]);this.entries.sort((t,e)=>t[0]<e[0]?-1:t[0]>e[0]?1:0)}lookup(t){this.dirty&&(this.compile(),this.dirty=!1);let e=this.binarySearch(t);if(e>=0)return this.entries[e][1];if(e=-e-1,e===0)return this.entries[e][1];if(e===this.entries.length)return this.entries[e-1][1];if(this.interpolate){let[i,r]=this.entries[e-1],[s,o]=this.entries[e],a=(t-i)/(s-i),h=Math.floor((o[0]-r[0])*a+r[0]),l=Math.floor((o[1]-r[1])*a+r[1]),d=Math.floor((o[2]-r[2])*a+r[2]);return[h,l,d]}else return this.entries[e-1][1]}getMinMax(){let t=Math.min.apply(Math,this.values),e=Math.max.apply(Math,this.values);return[t,e]}binarySearch(t){let e=0,i=this.entries.length-1;for(;e<=i;){let r=i+e>>1;if(t>this.entries[r][0])e=r+1;else if(t<this.entries[r][0])i=r-1;else return r}return-e-1}},np=class{constructor(t,e){this.action=t,this.widget=e}getPropertyValue(t){let e=this.action.properties.getProperty(t);return e?e.value:null}setPropertyValue(t,e){let i=this.action.properties.getProperty(t);if(!i)throw new Error(`Cannot set value of unknown property ${t}`);i instanceof _?(e=e!==void 0?String(e):e,this.action.properties.setValue(t,e)):this.action.properties.setValue(t,e),this.widget.requestRepaint()}},dp=class{constructor(t){this.array=t}get(t){return this.array[t]}},Ge=class{constructor(t){this._pv=t}getName(){return this._pv.name}getValue(){return this._pv.value??null}setValue(t,e){this._pv.pvEngine.setValue(new Date,this._pv.name,t)}isConnected(){return!this._pv.disconnected}isWriteAllowed(){return this._pv.writable}addListener(t){this._pv.addListener(()=>{t.valueChanged(this)})}removeListener(t){this._pv.removeListener(t)}},ze=class{constructor(t){this.widget=t}executeAction(t){this.widget.executeActionByIndex(t)}getPVByName(t){let e=this.widget.display.getPV(t);return e?new Ge(e):null}getPV(t="pv_name"){let e=this.getPropertyValue(t);return e?this.getPVByName(e):null}getHookedActions(){let t=this.widget.getHookedActions().map(e=>new np(e,this.widget));return new dp(t)}getVar(t){return this.widget.vars.get(t)??null}setVar(t,e){this.widget.vars.set(t,e)}getPropertyValue(t){let e=this.widget.properties.getProperty(t);return e?e.value:null}setPropertyValue(t,e){let i=this.widget.properties.getProperty(t);if(!i)throw new Error(`Cannot set value of unknown property ${t}`);if(i instanceof _)e=e!==void 0?String(e):e,this.widget.properties.setValue(t,e);else if(i instanceof Fe){let r=0;switch(e){case"GrayScale":r=1;break;case"JET":r=2;break;case"ColorSpectrum":r=3;break;case"Hot":r=4;break;case"Cool":r=5;break;case"Shaded":r=6;break}let s=new He(r,!0,!0);this.widget.properties.setValue(t,s)}else this.widget.properties.setValue(t,e);this.widget.requestRepaint()}getName(){return this.getPropertyValue("name")}setX(t){this.setPropertyValue("x",t)}setY(t){this.setPropertyValue("y",t)}setWidth(t){this.setPropertyValue("width",t)}setHeight(t){this.setPropertyValue("height",t)}setEnabled(t){this.setPropertyValue("enabled",t)}setVisible(t){this.setPropertyValue("visible",t)}getValue(){return this.widget.value??null}setValue(t){this.widget.value=t}setValueInUIThread(t){this.setValue(t)}},up=class extends ze{table;spreadSheetTable;constructor(t,e){super(t),this.table=t,this.spreadSheetTable=new lp(this.table.spreadsheet,e)}getTable(){return this.spreadSheetTable}},pp=class extends ze{xyGraph;constructor(t){super(t),this.xyGraph=t}clearGraph(){this.xyGraph.clearGraph()}getXBuffer(t){return this.xyGraph.getTrace(t).snapshot().map(e=>e.x)}getYBuffer(t){return this.xyGraph.getTrace(t).snapshot().map(e=>e.y)}};function Id(t,e){switch(t.widgetType){case"Table":return new up(t,e);case"XY Graph":return new pp(t);default:return new ze(t)}}var cp=class{constructor(t,e){this.display=t,this.scriptEngine=e}isActive(){return!0}getWidget(t){let e=this.display.findWidgetByName(t);if(e)return Id(e,this.scriptEngine)}},gp=class{constructor(t){this.display=t}readTextFile(t){let e=this.display.resolvePath(t);var i=new XMLHttpRequest;if(i.open("GET",e,!1),i.send(null),i.status===200)return i.responseText;throw Error(`Cannot open ${e}`)}},mp=class{constructor(t){this.display=t}fullScreen(){document.documentElement.requestFullscreen()}openConfirmDialog(t){return this.display.getDialogHandler().openConfirmDialog("Confirm Dialog",t)}openInformationDialog(t){this.display.getDialogHandler().openInformationDialog("Information",t)}openWarningDialog(t){this.display.getDialogHandler().openWarningDialog("Warning",t)}openErrorDialog(t){this.display.getDialogHandler().openErrorDialog("Error",t)}openPasswordDialog(t,e){return this.display.getDialogHandler().openPasswordDialog("Password Input Dialog",t,e)}},fp=class{constructor(t){this.display=t}openInformation(t,e,i){this.display.getDialogHandler().openInformationDialog(e,i)}openConfirm(t,e,i){return this.display.getDialogHandler().openConfirmDialog(e,i)}openError(t,e,i){this.display.getDialogHandler().openErrorDialog(e,i)}},Hd=class{constructor(t,e){this.name=t,this.pvEngine=e}_writable=!1;_units;_lowerDisplayLimit;_lowerAlarmLimit;_lowerWarningLimit;_upperWarningLimit;_upperAlarmLimit;_upperDisplayLimit;_time;_value;_severity="NONE";_indexValue;_precision=-1;_disconnected=!1;navigable=!1;get units(){return this._units}set units(t){this._units=t,this.pvEngine.requestRepaint()}get lowerDisplayLimit(){return this._lowerDisplayLimit}set lowerDisplayLimit(t){this._lowerDisplayLimit=t,this.pvEngine.requestRepaint()}get lowerAlarmLimit(){return this._lowerAlarmLimit}set lowerAlarmLimit(t){this._lowerAlarmLimit=t,this.pvEngine.requestRepaint()}get lowerWarningLimit(){return this._lowerWarningLimit}set lowerWarningLimit(t){this._lowerWarningLimit=t,this.pvEngine.requestRepaint()}get upperWarningLimit(){return this._upperWarningLimit}set upperWarningLimit(t){this._upperWarningLimit=t,this.pvEngine.requestRepaint()}get upperAlarmLimit(){return this._upperAlarmLimit}set upperAlarmLimit(t){this._upperAlarmLimit=t,this.pvEngine.requestRepaint()}get upperDisplayLimit(){return this._upperDisplayLimit}set upperDisplayLimit(t){this._upperDisplayLimit=t,this.pvEngine.requestRepaint()}get precision(){return this._precision}set precision(t){this._precision=t,this.pvEngine.requestRepaint()}get writable(){return this._writable}set writable(t){this._writable=t,this.pvEngine.requestRepaint()}get disconnected(){return this._disconnected}set disconnected(t){this._disconnected=t,this.pvEngine.requestRepaint()}get time(){return this._time}get value(){return this._value}get indexValue(){return this._indexValue}get severity(){return this._severity}get alarmName(){let t=this.toNumber();return t==null?"NONE":t<=(this.lowerAlarmLimit??NaN)?"LOLO":t>=(this.upperAlarmLimit??NaN)?"HIHI":t<=(this.lowerWarningLimit??NaN)?"LOW":t>=(this.upperWarningLimit??NaN)?"HIGH":"NONE"}toNumber(){if(this.value===null)return null;if(typeof this.value=="number")return this.value;if(typeof this.value=="boolean")return this.value?1:0;if(typeof this.indexValue!==void 0)return this.indexValue}setSample(t){this._time=t.time,this._value=t.value,this._indexValue=t.valueIndex,this._severity=t.severity,this._units=t.units,this.pvEngine.requestRepaint()}addListener(t){this.pvEngine.addListener(this.name,t)}removeListener(t){this.pvEngine.addListener(this.name,t)}toString(){if(this.value!==void 0)return String(this.value)}},xp=(t=>(t.NONE="NONE",t.MINOR="MINOR",t.MAJOR="MAJOR",t.INVALID="INVALID",t.UNDEFINED="UNDEFINED",t))(xp||{}),wp=["yyyy","MM","dd","HH","mm","ss","nnnnnnnnn"],yp=class{constructor(t){this.display=t,this.pvEngine=t.pvEngine}pvEngine;checkPVValue(t){if(t.getValue()===null)throw new Error(`PV ${t.getName()} has no value.`)}createPV(t,e){let i=this.pvEngine.createPV(t);return new Ge(i)}writePV(t,e,i){this.pvEngine.createPV(t),this.pvEngine.setValue(new Date,t,e)}getDouble(t){this.checkPVValue(t);let e=t._pv.toNumber();return parseFloat(e??t.getValue())}getLong(t){this.checkPVValue(t);let e=t._pv.toNumber();return typeof e=="number"&&(e=Math.floor(e)),parseInt(e??t.getValue(),10)}getString(t){return this.checkPVValue(t),ae(t._pv.value,0,-1)}getStringArray(t){this.checkPVValue(t);let e=t.getValue();return Array.isArray(e)?e.map(i=>String(i)):[String(e)]}getTimeInMilliseconds(t){return this.checkPVValue(t),t._pv.time?.getTime()??0}getTimeString(t,e="yyyy-MM-dd HH:mm:ss.nnnnnnnnn"){this.checkPVValue(t);let i=t._pv.time;if(i){let r=e;for(let s of wp)r=r.replace(s,this.formatDate(i,s));return r}return null}getSeverity(t){switch(this.checkPVValue(t),t._pv.severity){case"NONE":return 0;case"MAJOR":return 1;case"MINOR":return 2;default:return-1}}getSeverityString(t){return this.checkPVValue(t),String(t._pv.severity)}getStatus(t){return this.checkPVValue(t),t._pv.alarmName}getUnits(t){return this.checkPVValue(t),t._pv.units||null}formatDate(t,e){let{utc:i}=this.display;if(e==="yyyy")return String(i?t.getUTCFullYear():t.getFullYear());if(e==="MM"){let r=(i?t.getUTCMonth():t.getMonth())+1;return r<10?"0"+r:""+r}else if(e==="dd"){let r=i?t.getUTCDate():t.getDate();return r<10?"0"+r:""+r}else if(e==="HH"){let r=i?t.getUTCHours():t.getHours();return r<10?"0"+r:""+r}else if(e==="mm"){let r=i?t.getUTCMinutes():t.getMinutes();return r<10?"0"+r:""+r}else if(e==="ss"){let r=i?t.getUTCSeconds():t.getSeconds();return r<10?"0"+r:""+r}else if(e==="nnnnnnnnn"){let r=i?t.getUTCMilliseconds():t.getMilliseconds();return r<10?"00"+r:r<100?"0"+r:""+r}else throw new Error(`Unexpected format '${e}'`)}},vp=class{constructor(t){this.display=t}openOPI(t,e,i,r){if(i===0){let s={path:e,replace:i===0};this.display.fireEvent("opendisplay",s)}else throw new Error(`Unsupported target ${i}`)}closeCurrentOPI(){this.display.fireEvent("closedisplay",{})}};function bp(t){let e=t.widget,i=t.widget.display,r=function(l){this.run=l.run},s=function(l){this.runnable=l};s.prototype.start=function(){t.schedule(()=>this.runnable.run())},s.sleep=function(l){let d=Date.now(),n=0;for(;Date.now()<d+l;)n++;n||console.trace("Should not happen")};let o=function(){};o.prototype.schedule=function(l,d){t.schedule(l,d)};let a=function(l){this.valueChanged=d=>{t.schedule(()=>{let n=l.valueChanged;n(d)})}},h={ITableModifiedListener:function(l){this.modified=d=>{let n=l.modified;n(d)}},ITableSelectionChangedListener:function(l){this.selectionChanged=d=>{let n=l.selectionChanged;n(d)}}};return{display:new cp(e.display,t),widget:Id(e,t),java:{lang:{Runnable:r,Thread:s},util:{Timer:o}},org:{csstudio:{swt:{widgets:{natives:{SpreadSheetTable:h}}}},yamcs:{studio:{data:{IPVListener:a}}}},ColorFontUtil:new op,ConsoleUtil:new ap(i),DataUtil:new hp,FileUtil:new gp(i),GUIUtil:new mp(i),MessageDialog:new fp(i),PVUtil:new yp(i),ScriptUtil:new vp(i),SpreadSheetTable:h,Java:{type:function(l){switch(l){case"java.lang.Runnable":return r;case"java.lang.Thread":return s;case"java.util.Timer":return o;case"org.csstudio.swt.widgets.natives.SpreadSheetTable":return h;case"org.yamcs.studio.data.IPVListener":return a;default:throw new Error("Unexpected class name: "+l)}},to:function(l,d){return l}}}}var _t,rt,re;function Tp(){_t=document.createElement("iframe"),_t.id="script-e",_t.style.display="none",document.body.appendChild(_t),rt=_t.contentWindow,re=rt.eval,!re&&rt.execScript&&(rt.execScript.call(rt,"null"),re=rt.eval)}var he=class{constructor(t,e,i=[]){this.widget=t,this.scriptText=e,_t||Tp(),this.scriptText=e.replace(/importClass\([^\)]*\)\s*\;?/gi,"").replace(/importPackage\([^\)]*\)\s*\;?/gi,"").trim(),this.context=C(C({pvs:i.map(r=>new Ge(r)),triggerPV:null},t.display.pvEngine.scriptLibraries),bp(this))}context;run(t){window.setTimeout(()=>{if(this.context.triggerPV=null,t)for(let e of this.context.pvs)e._pv===t&&(this.context.triggerPV=e);this.runWithContext(()=>{re.call(rt,this.scriptText)})})}schedule(t,e){window.setTimeout(()=>this.runWithContext(t),e)}runWithContext(t){let e=[];for(let i in _t.contentWindow)e.push(i);try{for(let r in this.context)this.context.hasOwnProperty(r)&&(rt[r]=this.context[r]);t();let i={};for(let r in rt)e.indexOf(r)===-1&&(i[r]=rt[r]);this.context=i}finally{for(let i in rt)e.indexOf(i)===-1&&delete rt[i]}}},Si="path",Vi="embedded",Ci="scriptText",Sp=class extends ct{constructor(){super(),this.properties.add(new _(Si,"")),this.properties.add(new y(Vi,!1)),this.properties.add(new _(Ci,""))}execute(t){this.embedded?new he(t,this.scriptText).run():fetch(t.display.resolvePath(this.path),{credentials:"same-origin"}).then(e=>{e.ok&&e.text().then(i=>{new he(t.display.instance,i).run()})})}get path(){return this.properties.getValue(Si)}get embedded(){return this.properties.getValue(Vi)}get scriptText(){return this.properties.getValue(Ci)}toString(){return"Execute JavaScript"}},Ai="macros",_i="mode",Li="path",Vp=class extends ct{constructor(){super(),this.properties.add(new _(Li,"")),this.properties.add(new $e(Ai)),this.properties.add(new b(_i,0))}execute(t){let e=C({},this.macros.macros),i={path:this.path,replace:this.mode===0,args:e};t.display.fireEvent("opendisplay",i)}get macros(){return this.properties.getValue(Ai)}get path(){return this.properties.getValue(Li)}get mode(){return this.properties.getValue(_i)}toString(){return`Open ${this.path}`}},Pi="path",Cp=class extends ct{constructor(){super(),this.properties.add(new _(Pi,""))}execute(t){throw new Error("Unsupported action OPEN_FILE")}get path(){return this.properties.getValue(Pi)}toString(){return`Open ${this.path}`}},ki="hyperlink",Ap=class extends ct{constructor(){super(),this.properties.add(new _(ki,"http://"))}execute(t){this.hyperlink&&(window.location.href=this.hyperlink)}get hyperlink(){return this.properties.getValue(ki)}toString(){return`Open Webpage ${this.hyperlink}`}},Mi="path",_p=class extends ct{constructor(){super(),this.properties.add(new _(Mi,""))}execute(t){this.path&&new Audio(t.display.resolvePath(this.path)).play()}get path(){return this.properties.getValue(Mi)}toString(){return`Play WAV File ${this.path}`}},Ri="command",Ei="args",Wi="confirm_message",Lp=class extends ct{constructor(){super(),this.properties.add(new _(Ri,"")),this.properties.add(new Oe(Ei,{})),this.properties.add(new _(Wi,""))}execute(t){if(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))return;let e=t.expandMacro(this.command),i={};for(let s in this.args)i[s]=t.expandMacro(this.args[s]);let r={command:e,args:i};t.display.fireEvent("runcommand",r)}get command(){return this.properties.getValue(Ri)}get args(){return this.properties.getValue(Ei)}get confirmMessage(){return this.properties.getValue(Wi)}toString(){return`Run ${this.command}`}},Bi="procedure",Ii="args",Hi="confirm_message",Pp=class extends ct{constructor(){super(),this.properties.add(new _(Bi,"")),this.properties.add(new Oe(Ii,{})),this.properties.add(new _(Hi,""))}execute(t){if(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))return;let e={procedure:this.procedure,args:this.args};t.display.fireEvent("runprocedure",e)}get procedure(){return this.properties.getValue(Bi)}get args(){return this.properties.getValue(Ii)}get confirmMessage(){return this.properties.getValue(Hi)}toString(){return`Run ${this.procedure}`}},Di="pv_name",Ni="value",Fi="timeout",$i="confirm_message",kp=class extends ct{constructor(){super(),this.properties.add(new _(Di,"$(pv_name)")),this.properties.add(new _(Ni,"")),this.properties.add(new b(Fi,10)),this.properties.add(new _($i,""))}execute(t){if(!(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))&&this.pvName){let e=t.expandMacro(this.pvName);t.display.pvEngine.createPV(e),t.display.pvEngine.setValue(new Date,e,this.value)}}get pvName(){return this.properties.getValue(Di)}get value(){return this.properties.getValue(Ni)}get timeout(){return this.properties.getValue(Fi)}get confirmMessage(){return this.properties.getValue($i)}toString(){return`Write ${this.value} to ${this.pvName}`}},Mp=class{includeParentMacros=!0;macros={};clear(){this.macros={}}set(t,e){this.macros[t]=e}get(t){if(t in this.macros)return this.macros[t]}},Dd=class{rules=[]},Rp=class{constructor(t,e,i){this.autoScaleWidgets=t,this.minWidth=e,this.minHeight=i}},Ep=class{constructor(t,e,i){this.widthScalable=t,this.heightScalable=e,this.keepWidthHeightRatio=i}},Wp=class{scripts=[]},Nd=class Zt{constructor(e){this.node=e}get name(){return this.node.nodeName}static parseFromXML(e){let i=new DOMParser().parseFromString(e,"text/xml");return new Zt(i.documentElement)}getNode(e){let i=this.findChild(e);return new Zt(i)}getNodes(e){let i=[];for(let r=0;r<this.node.childNodes.length;r++){let s=this.node.childNodes[r];s.nodeType!==3&&(!e||s.nodeName===e)&&i.push(new Zt(s))}return i}hasNode(e){for(let i=0;i<this.node.childNodes.length;i++)if(this.node.childNodes[i].nodeName===e)return!0;return!1}hasAttribute(e){return this.node.hasAttribute(e)}getTextContent(e){return this.node.textContent||e||""}getString(e,i){for(let r=0;r<this.node.childNodes.length;r++){let s=this.node.childNodes[r];if(s.nodeName===e&&s.textContent!==null)return s.textContent}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getStringAttribute(e){let i=this.node.attributes.getNamedItem(e);if(i===null)throw new Error(`No attribute named ${e}`);return i.textContent||""}getFloat(e,i){for(let r=0;r<this.node.childNodes.length;r++){let s=this.node.childNodes[r];if(s.nodeName===e&&s.textContent!==null)return parseFloat(s.textContent)}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getInt(e,i){for(let r=0;r<this.node.childNodes.length;r++){let s=this.node.childNodes[r];if(s.nodeName===e&&s.textContent!==null)return parseInt(s.textContent,10)}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getIntAttribute(e){let i=this.node.attributes.getNamedItem(e);if(i===null)throw new Error(`No attribute named ${e}`);return parseInt(i.textContent||"",10)}getBoolean(e,i){for(let r=0;r<this.node.childNodes.length;r++){let s=this.node.childNodes[r];if(s.nodeName===e)return s.textContent==="true"}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getBooleanAttribute(e,i){let r=this.node.attributes.getNamedItem(e);if(r===null){if(i!==void 0)return i;throw new Error(`No attribute named ${e}`)}else return r.textContent==="true"}getColor(e,i){let r=this.findChild(e);for(let s=0;s<r.childNodes.length;s++){let o=r.childNodes[s];if(o.nodeName==="color")return this.parseColorNode(new Zt(o))}if(i!==void 0)return i;throw new Error("No child node named 'color' could be found")}getFont(e){let i=this.getNode(e);if(i.hasNode("opifont.name")){let r=i.getNode("opifont.name"),s=r.getStringAttribute("fontName"),o=r.getIntAttribute("height"),a=r.getIntAttribute("style"),h=!1;return r.hasAttribute("pixels")&&(h=r.getBooleanAttribute("pixels")),new it(s,o,a,h)}else{let r=i.getNode("fontdata"),s=r.getStringAttribute("fontName"),o=r.getIntAttribute("height"),a=r.getIntAttribute("style");return new it(s,o,a,!1)}}getPoints(e){let i=this.getNode(e),r=[];for(let s of i.getNodes("point"))r.push({x:s.getIntAttribute("x"),y:s.getIntAttribute("y")});return r}getStringList(e){let i=this.getNode(e),r=[];for(let s of i.getNodes("s"))r.push(s.getTextContent());return r}getStringMap(e){let i=this.getNode(e),r={};for(let s of i.getNodes())r[s.name]=i.getString(s.name);return r}getStringTable(e){let i=this.getNode(e),r=[];for(let s of i.getNodes("row")){let o=[];for(let a of s.getNodes("col"))o.push(a.getTextContent());r.push(o)}return r}getScripts(e){let i=this.getNode(e),r=new Wp;for(let s of i.getNodes("path")){let o=[];for(let h of s.getNodes("pv"))o.push({pvName:h.getTextContent(),trigger:h.getBooleanAttribute("trig")});let a=s.getStringAttribute("pathString");a==="EmbeddedJs"?r.scripts.push({embedded:!0,text:s.getString("scriptText"),checkConnect:s.getBooleanAttribute("checkConnect"),skipFirstExecution:s.getBooleanAttribute("sfe",!1),inputs:o}):a==="EmbeddedPy"?console.warn("Unsupported EmbeddedPy script"):r.scripts.push({embedded:!1,path:a,checkConnect:s.getBooleanAttribute("checkConnect"),skipFirstExecution:s.getBooleanAttribute("sfe",!1),inputs:o})}return r}getScaleOptions(e){let i=this.getNode(e);return new Ep(i.getBoolean("width_scalable"),i.getBoolean("height_scalable"),i.getBoolean("keep_wh_ratio"))}getAutoScaleWidgets(e){let i=this.getNode(e);return new Rp(i.getBoolean("auto_scale_widgets"),i.getInt("min_width"),i.getInt("min_height"))}getColorMap(e){let i=this.getNode(e);if(i.hasNode("e")){let r=new He(0,i.getBoolean("interpolate"),i.getBoolean("autoscale"));for(let s of i.getNodes("e")){let o=Number(s.getTextContent()),a=s.getIntAttribute("red"),h=s.getIntAttribute("green"),l=s.getIntAttribute("blue");r.addMapping(o,a,h,l)}}else return new He(i.getInt("map"),i.getBoolean("interpolate"),i.getBoolean("autoscale"))}getRules(e){let i=this.getNode(e),r=new Dd;for(let s of i.getNodes("rule")){let o=[];for(let h of s.getNodes("pv"))o.push({pvName:h.getTextContent(),trigger:h.getBooleanAttribute("trig")});let a=[];for(let h of s.getNodes("exp"))h.getNode("value").hasNode("color")?a.push({type:"color",expression:h.getStringAttribute("bool_exp"),outputValue:h.getColor("value")}):a.push({type:"string",expression:h.getStringAttribute("bool_exp"),outputValue:h.getString("value")});r.rules.push({name:s.getStringAttribute("name"),propertyName:s.getStringAttribute("prop_id"),outputExpression:s.getBooleanAttribute("out_exp"),inputs:o,expressions:a})}return r}getMacros(e){let i=this.getNode(e),r=new Mp;r.includeParentMacros=i.getBoolean("include_parent_macros");for(let s of i.getNodes())s.name!=="include_parent_macros"&&r.set(s.name,i.getString(s.name));return r}getActions(e){let i=this.getNode(e),r=new Bd;r.hookFirstActionToClick=i.getBooleanAttribute("hook"),r.hookAllActionsToClick=i.getBooleanAttribute("hook_all",!1);for(let s of i.getNodes("action")){let o=s.getStringAttribute("type");if(o==="OPEN_DISPLAY"){let a=new Vp;a.parseNode(s),r.add(a)}else if(o==="OPEN_FILE"){let a=new Cp;a.parseNode(s),r.add(a)}else if(o==="EXECUTE_CMD"){let a=new rp;a.parseNode(s),r.add(a)}else if(o==="EXECUTE_JAVASCRIPT"){let a=new Sp;a.parseNode(s),r.add(a)}else if(o==="WRITE_PV"){let a=new kp;a.parseNode(s),r.add(a)}else if(o==="PLAY_SOUND"){let a=new _p;a.parseNode(s),r.add(a)}else if(o==="OPEN_WEBPAGE"){let a=new Ap;a.parseNode(s),r.add(a)}else if(o==="RUN_COMMAND"){let a=new Lp;a.parseNode(s),r.add(a)}else if(o==="RUN_PROCEDURE"){let a=new Pp;a.parseNode(s),r.add(a)}else console.warn(`Unsupported action type ${o}`),r.add(null)}return r}parseColorNode(e){let i=e.getIntAttribute("red"),r=e.getIntAttribute("green"),s=e.getIntAttribute("blue");return new m(i,r,s)}findChild(e){for(let i=0;i<this.node.childNodes.length;i++){let r=this.node.childNodes[i];if(r.nodeName===e)return r}throw new Error(`No child node named ${e} could be found`)}},Oi="actions",Gi="background_color",zi="backcolor_alarm_sensitive",Ui="border_alarm_sensitive",qi="border_color",Yi="border_width",Xi="border_style",Ki="enabled",ji="foreground_color",Zi="forecolor_alarm_sensitive",be="height",Ji="name",Te="pv_name",Qi="pv_value",tr="rules",er="scale_options",ir="scripts",Se="text",rr="tooltip",sr="transparent",or="visible",ar="widget_type",Ve="width",hr="wuid",Ce="x",Ae="y",G=class{constructor(t,e){this.display=t,this.parent=e,this.properties=new Pd(this,[new kd(Oi,new Bd),new y(zi,!1),new R(Gi,m.TRANSPARENT),new y(Ui,!1),new R(qi),new b(Xi),new b(Yi),new y(Ki,!0),new y(Zi,!1),new R(ji),new b(be),new _(Ji),new _(Te),new Jt(Qi,Te),new Rd(tr,new Dd),new Md(ir),new _(Se,""),new _(rr,""),new y(sr,!1),new y(or),new _(ar),new b(Ve),new _(hr),new b(Ce),new b(Ae),new Ed(er)])}x=0;y=0;width=0;height=0;_value;fillRoundRectangleBackgroundBorder=!0;holderRegion;properties;vars=new Map;pvs=[];parseNode(t){this.properties.loadXMLValues(t);for(let e of this.properties.all())if(e instanceof O){let i=e.value;this.loadFont(i)}if(this.pvName){let e=this.display.pvEngine.createPV(this.pvName);this.pvs.push(e)}for(let e of this.scripts.scripts)if(e.embedded){let i=this.display.pvEngine.createScript(this,e,e.text);this.pvs.push(...i.pvs)}else fetch(this.display.resolvePath(e.path),{credentials:"same-origin"}).then(i=>{i.ok&&i.text().then(r=>{let s=this.display.pvEngine.createScript(this,e,r);this.pvs.push(...s.pvs)})});for(let e of this.rules.rules)this.properties.getProperty(e.propertyName)?this.display.pvEngine.createRule(this,e):console.warn(`Cannot create rule for unsupported property ${e.propertyName}`);this.actions.isClickable()&&(this.holderRegion={id:`${this.wuid}-holder`},this.tooltip&&(this.holderRegion.tooltip=()=>this.tooltip),this.actions.isClickable()&&(this.holderRegion.click=()=>{for(let e of this.getHookedActions())this.executeAction(e)},this.holderRegion.cursor="pointer")),this.init()}getHookedActions(){let{actions:t}=this,e=[];for(let i=0;i<t.actions.length;i++)i===0?(t.hookFirstActionToClick||t.hookAllActionsToClick)&&e.push(t.actions[i]):t.hookAllActionsToClick&&e.push(t.actions[i]);return e}drawHolder(t){let{scale:e}=this,i=[0,0,0,0],r=this.borderAlarmSensitive&&(this.pv?.severity==="MINOR"||this.pv?.severity==="MAJOR");if(!r)switch(this.borderStyle){case 0:break;case 1:i=[this.borderWidth,this.borderWidth,this.borderWidth,this.borderWidth];break;case 2:case 3:i=[1*e,1*e,1*e,1*e];break;case 4:case 5:case 6:i=[2*e,2*e,2*e,2*e];break;case 7:i=[2*e,2*e,1*e,1*e];break;case 8:case 9:case 10:case 11:i=[this.borderWidth,this.borderWidth,this.borderWidth,this.borderWidth];break;case 12:i=[17*e,1*e,1*e,1*e];break;case 13:i=[16*e,16*e,16*e,16*e];break;case 14:let s=this.borderWidth*2;i=[s,s,s,s];break}this.x=this.holderX+i[1],this.y=this.holderY+i[0],this.width=this.holderWidth-i[1]-i[3],this.height=this.holderHeight-i[0]-i[2],r||(this.beforeDrawBorder(t),this.drawBorderStyle(t)),this.holderRegion&&t.addHitRegion(this.holderRegion).addRect(this.holderX,this.holderY,this.holderWidth,this.holderHeight)}beforeDrawBorder(t){}drawBorderStyle(t){let{scale:e}=this;if(this.borderStyle!==0)if(this.borderStyle===1)t.strokeRect({x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight,color:this.borderColor,lineWidth:this.borderWidth,crispen:!0});else if(this.borderStyle===2){let i=1*e,r=this.holderY+i/2,s=this.holderX+i/2,o=this.holderY+this.holderHeight-i+i/2,a=this.holderX+this.holderWidth-i+i/2;t.strokePath({color:m.BLACK,path:new S(a,o).lineTo(a,r).moveTo(a,o).lineTo(s,o)}),t.strokePath({color:m.WHITE,path:new S(s,r).lineTo(a-i,r).moveTo(s,r).lineTo(s,o-i)})}else if(this.borderStyle===3){let i=1*e,r=this.holderY+i/2,s=this.holderX+i/2,o=this.holderY+this.holderHeight-i+i/2,a=this.holderX+this.holderWidth-i+i/2;t.strokePath({color:m.WHITE,path:new S(a,o).lineTo(a,r).moveTo(a,o).lineTo(s,o)}),t.strokePath({color:m.BLACK,path:new S(s,r).lineTo(a-i,r).moveTo(s,r).lineTo(s,o-i)})}else if(this.borderStyle===4)this.drawShadowBorder(t,m.BUTTON_LIGHTEST,m.BUTTON_DARKER,m.BUTTON_DARKER,m.BUTTON_LIGHTEST);else if(this.borderStyle===5)this.drawShadowBorder(t,m.BUTTON_DARKER,m.BUTTON_LIGHTEST,m.BUTTON_LIGHTEST,m.BUTTON_DARKER);else if(this.borderStyle===6)this.drawShadowBorder(t,m.BUTTON_DARKEST,m.BUTTON_DARKER,m.BUTTON,m.BUTTON_LIGHTEST);else if(this.borderStyle===7)this.drawShadowBorder(t,m.BUTTON_LIGHTEST,m.BUTTON_LIGHTEST,m.BUTTON_DARKEST,m.BUTTON_DARKER);else if(this.borderStyle===8)this.drawDashedBorder(t,[2*e,2*e]);else if(this.borderStyle===9)this.drawDashedBorder(t,[6*e,2*e]);else if(this.borderStyle===10)this.drawDashedBorder(t,[6*e,2*e,2*e,2*e]);else if(this.borderStyle===11)this.drawDashedBorder(t,[6*e,2*e,2*e,2*e,2*e,2*e]);else if(this.borderStyle===12)t.fillRect({x:this.holderX,y:this.holderY+1*e,width:this.holderWidth,height:16*e,color:this.borderColor}),t.fillText({x:this.holderX+1*e+3*e,y:this.holderY+1*e+16/2*e,baseline:"middle",align:"left",font:it.ARIAL_11.scale(e),color:m.BLACK,text:this.name}),t.strokeRect({x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight,color:m.BLACK,crispen:!0});else if(this.borderStyle===13){let i=t.measureText(this.name,it.ARIAL_11.scale(e)),r=1,s=Ft(this.holderX+8*e,this.holderY+8*e,this.holderWidth-16*e-r,this.holderHeight-16*e-r,r);this.transparent||(t.fillRect(A(C({},U(s,8*e)),{color:this.backgroundColor})),t.fillRect({x:this.holderX+16*e,y:this.holderY,width:i.width,height:16*e,color:this.backgroundColor})),t.fillText({x:this.holderX+16*e,y:this.holderY+8*e,baseline:"middle",align:"left",font:it.ARIAL_11.scale(e),color:this.borderColor,text:this.name}),t.strokePath({color:this.backgroundColor.darker(),path:new S(s.x,s.y).lineTo(s.x+8*e,s.y).moveTo(s.x+8*e+i.width,s.y).lineTo(s.x+s.width,s.y).lineTo(s.x+s.width,s.y+s.height).lineTo(s.x,s.y+s.height).lineTo(s.x,s.y)}),s=Ft(this.holderX+8*e+r,this.holderY+8*e+r,this.holderWidth-16*e-r,this.holderHeight-16*e-r,r),t.strokePath({color:this.backgroundColor.brighter(),path:new S(s.x,s.y).lineTo(s.x+8*e-r,s.y).moveTo(s.x+8*e-r+i.width,s.y).lineTo(s.x+s.width,s.y).lineTo(s.x+s.width,s.y+s.height).lineTo(s.x,s.y+s.height).lineTo(s.x,s.y)})}else if(this.borderStyle===14){let i=Ft(this.holderX,this.holderY,this.holderWidth,this.holderHeight,this.borderWidth);this.fillRoundRectangleBackgroundBorder&&t.fillRect(A(C({},i),{rx:4*e,ry:4*e,color:this.backgroundColor})),this.borderWidth&&t.strokeRect(A(C({},i),{rx:4*e,ry:4*e,color:this.borderColor,lineWidth:this.borderWidth}))}else this.borderStyle===15||console.warn(`Unsupported border style: ${this.borderStyle}`)}isDisconnected(){for(let t of this.pvs)if(t.value===void 0)return!0;return!1}drawDecoration(t){if(this.display.editMode)return;let{scale:e}=this;if(this.pvName&&(!this.pv||this.pv.disconnected)){let i=1*e;t.fillRect({x:this.holderX-i/2,y:this.holderY-i/2,width:this.holderWidth+i,height:this.holderHeight+i,color:m.PURPLE,opacity:.4}),t.strokeRect({x:this.holderX-i/2,y:this.holderY-i/2,width:this.holderWidth+i,height:this.holderHeight+i,color:m.PURPLE})}else this.pvs.length&&this.isDisconnected()&&t.strokeRect(A(C({},this.bounds),{dash:[2*e,2*e],lineWidth:2*e,color:m.PINK,crispen:!0}));if(this.borderAlarmSensitive){let i;this.borderStyle===8?i=[2*e,2*e]:this.borderStyle===9?i=[6*e,2*e]:this.borderStyle===10?i=[6*e,2*e,2*e,2*e]:this.borderStyle===11&&(i=[6*e,2*e,2*e,2*e,2*e,2*e]),this.pv?.severity==="MAJOR"?t.strokeRect(A(C({},this.bounds),{lineWidth:2*e,color:m.RED,crispen:!0,dash:i})):this.pv?.severity==="MINOR"?t.strokeRect(A(C({},this.bounds),{lineWidth:2*e,color:m.ORANGE,crispen:!0,dash:i})):this.pv?.severity==="INVALID"&&t.strokeRect(A(C({},this.bounds),{lineWidth:2*e,color:m.PINK,crispen:!0}))}}drawOverlay(t){}drawSelection(t){t.lineWidth=1,t.strokeStyle="black",t.strokeRect(this.holderX-.5,this.holderY-.5,this.holderWidth+1,this.holderHeight+1),t.fillStyle="black";let e=2;t.fillRect(this.holderX-e,this.holderY-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth/2-e,this.holderY-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth-e,this.holderY-e,e+e,e+e),t.fillRect(this.holderX-e,this.holderY+this.holderHeight/2-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth-e,this.holderY+this.holderHeight/2-e,e+e,e+e),t.fillRect(this.holderX-e,this.holderY+this.holderHeight-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth/2-e,this.holderY+this.holderHeight-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth-e,this.holderY+this.holderHeight-e,e+e,e+e),t.strokeStyle="white",e=3,t.strokeRect(this.holderX-e+.5,this.holderY-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth/2-e+.5,this.holderY-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth-e+.5,this.holderY-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX-e+.5,this.holderY+this.holderHeight/2-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth-e+.5,this.holderY+this.holderHeight/2-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX-e+.5,this.holderY+this.holderHeight-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth/2-e+.5,this.holderY+this.holderHeight-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth-e+.5,this.holderY+this.holderHeight-e+.5,e+e-1,e+e-1)}requestRepaint(){this.display.requestRepaint()}resolvePath(t){return this.display.resolvePath(t,this)}get bounds(){return{x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight}}get unscaledBounds(){return{x:this.properties.getValue(Ce),y:this.properties.getValue(Ae),width:this.properties.getValue(Ve),height:this.properties.getValue(be)}}get area(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawShadowBorder(t,e,i,r,s){let o=1*this.scale,a=this.holderY+o/2,h=this.holderX+o/2,l=this.holderY+this.holderHeight-o+o/2,d=this.holderX+this.holderWidth-o+o/2;t.strokePath({color:e,path:new S(d,l).lineTo(d,a).moveTo(d,l).lineTo(h,l)}),t.strokePath({color:i,path:new S(d-o,l-o).lineTo(d-o,a+o).moveTo(d-o,l-o).lineTo(h+o,l-o)}),t.strokePath({color:r,path:new S(h,a).lineTo(d-o,a).moveTo(h,a).lineTo(h,l-o)}),t.strokePath({color:s,path:new S(h+o,a+o).lineTo(d-o-o,a+o).moveTo(h+o,a+o).lineTo(h+o,l-o-o)})}drawDashedBorder(t,e){let i=Ft(this.holderX,this.holderY,this.holderWidth,this.holderHeight,this.borderWidth);t.strokePath({color:this.borderColor,lineWidth:this.borderWidth,dash:e,path:new S(i.x,i.y).lineTo(i.x+i.width,i.y).lineTo(i.x+i.width,i.y+i.height).lineTo(i.x,i.y+i.height).closePath()})}executeActionByIndex(t){let e=this.actions.getAction(t);e&&this.executeAction(e)}executeAction(t){t.execute(this)}expandMacro(t){if(t.indexOf("$")===-1)return t;for(let e of this.properties.all())if(e instanceof Jt){let i=this.properties.getProperty(e.pvPropertyName),r="",s=i?.value;s&&(r=this.display.getPV(s)?.value??""),t=t.replace(`$(${e.name})`,r),t=t.replace(`\${${e.name}}`,r)}else t=t.replace(`$(${e.name})`,e.value||""),t=t.replace(`\${${e.name}}`,e.value||"");return this.parent?this.parent.expandContainerMacros(t):t}loadFont(t){if(t.isWebSafe())return;let e=this.display.getFontResolver();if(!e){console.warn(`Failed to load font '${t.getFontString()}'.`);return}let i=e.resolve(t);if(!i){console.warn(`Failed to load font '${t.getFontString()}'.`);return}i.load().then(r=>{document.fonts.add(r),this.requestRepaint()}).catch(r=>{console.warn(`Failed to load font '${t.getFontString()}'.`,r)})}get pv(){if(this.pvName)return this.display.getPV(this.pvName)}isMinorSeverity(){return this.pv?.severity==="MINOR"}isMajorSeverity(){return this.pv?.severity==="MAJOR"}get alarm(){return this.pv?.severity==="MINOR"||this.pv?.severity==="MAJOR"||this.pv?.severity==="INVALID"}get alarmSensitiveBackgroundColor(){if(this.backgroundAlarmSensitive){if(this.isMajorSeverity())return m.RED;if(this.isMinorSeverity())return m.ORANGE;if(this.pv?.severity==="INVALID")return m.PINK}return this.backgroundColor}get alarmSensitiveForegroundColor(){if(this.foregroundAlarmSensitive){if(this.isMajorSeverity())return m.RED;if(this.isMinorSeverity())return m.ORANGE}return this.foregroundColor}get scale(){let t=this.display.scale,e=this.parent;for(;e;)t*=e.relativeScale,e=e.parent;return t}get value(){return this._value}set value(t){this._value=t,this.requestRepaint()}addPropertyListener(t,e){this.properties.getProperty(t).addListener(e)}removePropertyListener(t,e){this.properties.getProperty(t).removeListener(e)}toDataURL(t="image/png",e){let i=this.display.measureAbsoluteArea(this);return this.display.copyCanvas(i).toDataURL(t,e)}get wuid(){return this.properties.getValue(hr)}get name(){return this.properties.getValue(Ji)}get holderX(){return this.scale*this.properties.getValue(Ce)}get holderY(){return this.scale*this.properties.getValue(Ae)}get holderWidth(){return this.scale*this.properties.getValue(Ve)}get holderHeight(){return this.scale*this.properties.getValue(be)}get borderAlarmSensitive(){return this.properties.getValue(Ui)}get backgroundAlarmSensitive(){return this.properties.getValue(zi)}get foregroundAlarmSensitive(){return this.properties.getValue(Zi)}get pvName(){return this.properties.getValue(Te,!0)}get pvValue(){return this.properties.getValue(Qi,!0)}get borderColor(){return this.properties.getValue(qi)}get borderStyle(){return this.properties.getValue(Xi)}get borderWidth(){return this.scale*this.properties.getValue(Yi)}get backgroundColor(){return this.properties.getValue(Gi)}get enabled(){return this.properties.getValue(Ki)}get foregroundColor(){return this.properties.getValue(ji)}get tooltip(){let t=this.properties.getProperty(rr);if(t.rawValue)return this.expandMacro(t.rawValue)}get transparent(){return this.properties.getValue(sr)}get visible(){return this.properties.getValue(or)}get actions(){return this.properties.getValue(Oi)}get scripts(){return this.properties.getValue(ir)}get rules(){return this.properties.getValue(tr)}get scaleOptions(){return this.properties.getValue(er)}get widgetType(){return this.properties.getValue(ar,!0)}get text(){return this.display.editMode?(this.properties.getProperty(Se).rawValue||"").split(" ").join("\xA0"):this.properties.getValue(Se).split(" ").join("\xA0")}init(){}hide(){}destroy(){}},lr="macros",ue=class De extends G{_widgets=[];_connections=[];relativeScale=1;constructor(e,i){super(e,i),this.properties.add(new $e(lr))}expandContainerMacros(e){for(let i in this.macros.macros)e=e.replace(`$(${i})`,this.macros.macros[i]),e=e.replace(`\${${i}}`,this.macros.macros[i]);return this.parent&&this.macros.includeParentMacros&&(e=this.parent.expandContainerMacros(e)),e}findWidget(e){for(let i of this.widgets){if(i.wuid===e)return i;if(i instanceof De){let r=i.findWidget(e);if(r)return r}}}findWidgetByName(e){for(let i of this.widgets){if(i.name===e)return i;if(i instanceof De){let r=i.findWidgetByName(e);if(r)return r}}for(let i of this.connections)if(i.name===e)return i}hide(){for(let e of this.widgets)e.hide()}destroy(){for(let e of this.widgets)e.destroy()}get widgets(){return this._widgets}get connections(){return this._connections}get macros(){return this.properties.getValue(lr)}},nr="arrow_length",dr="arrows",ur="fill_arrow",pr="name",cr="line_color",gr="line_style",mr="line_width",fr="src_wuid",xr="src_term",wr="tgt_wuid",yr="tgt_term",vr="router",br="points",Bp="wuid",wt="LEFT",yt="UP",vt="DOWN",bt="RIGHT",Ip=class extends G{sourceWidget;targetWidget;constructor(t){super(t),this.properties.clear(),this.properties.add(new b(nr)),this.properties.add(new b(dr)),this.properties.add(new y(ur)),this.properties.add(new _(pr)),this.properties.add(new R(cr)),this.properties.add(new b(gr)),this.properties.add(new b(mr)),this.properties.add(new _(fr)),this.properties.add(new _(xr)),this.properties.add(new _(wr)),this.properties.add(new _(yr)),this.properties.add(new b(vr)),this.properties.add(new ne(br)),this.properties.add(new _(Bp))}parseNode(t){this.properties.loadXMLValues(t),this.sourceWidget=this.display.findWidget(this.sourceWuid),this.sourceWidget||console.warn(`Can't find source widget ${this.sourceWuid}`),this.targetWidget=this.display.findWidget(this.targetWuid),this.targetWidget||console.warn(`Can't find target widget ${this.targetWuid}`)}draw(t){!this.sourceWidget||!this.targetWidget||(this.points.length?this.drawPath(t):this.router===0?this.drawManhattanConnection(t):this.router===1&&this.drawDirectConnection(t))}drawPath(t){let e=this.getPosition(this.sourceWidget,this.sourceTerm),i=this.getPosition(this.targetWidget,this.targetTerm),r=[e,...this.points,i],s=S.fromPoints(r).translate(.5*this.scale,.5*this.scale);t.strokePath({path:s,lineWidth:this.lineWidth,color:this.lineColor,dash:this.getDashArray()}),this.drawStartArrow(t,r[1],r[0]),this.drawStopArrow(t,r[r.length-2],r[r.length-1])}drawManhattanConnection(t){let e=this.getManhattanAnchor(this.sourceWidget,this.sourceTerm),i=this.getManhattanAnchor(this.targetWidget,this.targetTerm),r=this.route(e,i),s=S.fromPoints(r);this.lineWidth&&t.strokePath({lineWidth:this.lineWidth,color:this.lineColor,path:s,dash:this.getDashArray()}),this.drawStartArrow(t,r[r.length-2],r[r.length-1]),this.drawStopArrow(t,r[1],r[0])}getDashArray(){let{scale:t}=this;if(this.lineWidth){if(this.lineStyle===0)return[];if(this.lineStyle===1)return[6*t,2*t];if(this.lineStyle===2)return[2*t,2*t];if(this.lineStyle===3)return[6*t,2*t,2*t,2*t];if(this.lineStyle===4)return[6*t,2*t,2*t,2*t,2*t,2*t];console.warn(`Unsupported connection line style ${this.lineStyle}`)}}drawDirectConnection(t){let e=this.getPosition(this.sourceWidget,this.sourceTerm),i=this.getPosition(this.targetWidget,this.targetTerm);this.lineWidth&&t.strokePath({path:new S(e.x,e.y).lineTo(i.x,i.y),lineWidth:this.lineWidth,color:this.lineColor,dash:this.getDashArray()}),this.drawStartArrow(t,i,e),this.drawStopArrow(t,e,i)}getManhattanAnchor(t,e){let i;switch(e){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":i=yt;break;case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":i=vt;break;case"LEFT":i=wt;break;case"RIGHT":i=bt;break;default:}let r=t.bounds,s=this.getPosition(t,e),o=s.x-r.x,a=r.x+r.width-s.x,h=s.y-r.y,l=r.y+r.height-s.y;return Math.min(o,a)<Math.min(h,l)?i=o<a?wt:bt:i=h<l?yt:vt,{x:s.x,y:s.y,direction:i}}getPosition(t,e){switch(e){case"LEFT":return{x:t.holderX,y:t.holderY+t.holderHeight/2};case"TOP":return{x:t.holderX+t.holderWidth/2,y:t.holderY};case"RIGHT":return{x:t.holderX+t.holderWidth,y:t.holderY+t.holderHeight/2};case"BOTTOM":return{x:t.holderX+t.holderWidth/2,y:t.holderY+t.holderHeight};case"TOP_LEFT":return{x:t.holderX,y:t.holderY};case"TOP_RIGHT":return{x:t.holderX+t.holderWidth,y:t.holderY};case"BOTTOM_LEFT":return{x:t.holderX,y:t.holderY+t.holderHeight};case"BOTTOM_RIGHT":return{x:t.holderX+t.holderWidth,y:t.holderY+t.holderHeight};default:let i=parseInt(e,10),r=t.properties.getProperty("points");if(r){let s=r.value;return s=oe(s,this.scale),s[i]}else throw Error(`Unexpected term ${e}`)}}route(t,e){let i=t.x-e.x,r=t.y-e.y,s={x:0,y:0},o,a,h=[],{tolxtol:l,tol:d,minDist:n}=this;if(i*i<l&&r*r<l)return[{x:e.x,y:e.y}];t.direction===wt?i>0&&r*r<d&&e.direction===bt?(s=e,o=e.direction):(i<0?s={x:t.x-n,y:t.y}:r>0&&e.direction===vt||r<0&&e.direction===yt?s={x:e.x,y:t.y}:t.direction===e.direction?(a=Math.min(t.x,e.x)-n,s={x:a,y:t.y}):s={x:t.x-i/2,y:t.y},r>0?o=yt:o=vt):t.direction===bt?i<0&&r*r<d&&e.direction===wt?(s=e,o=e.direction):(i>0?s={x:t.x+n,y:t.y}:r>0&&e.direction===vt||r<0&&e.direction===yt?s={x:e.x,y:t.y}:t.direction===e.direction?(a=Math.max(t.x,e.x)+n,s={x:a,y:t.y}):s={x:t.x-i/2,y:t.y},r>0?o=yt:o=vt):t.direction===vt?i*i<d&&r<0&&e.direction===yt?(s=e,o=e.direction):(r>0?s={x:t.x,y:t.y+n}:i>0&&e.direction===bt||i<0&&e.direction===wt?s={x:t.x,y:e.y}:t.direction===e.direction?(a=Math.max(t.y,e.y)+n,s={x:t.x,y:a}):s={x:t.x,y:t.y-r/2},i>0?o=wt:o=bt):t.direction===yt&&(i*i<d&&r>0&&e.direction===vt?(s=e,o=e.direction):(r<0?s={x:t.x,y:t.y-n}:i>0&&e.direction===bt||i<0&&e.direction===wt?s={x:t.x,y:e.y}:t.direction===e.direction?(a=Math.min(t.y,e.y)-n,s={x:t.x,y:a}):s={x:t.x,y:t.y-r/2},i>0?o=wt:o=bt));let p=A(C({},s),{direction:o});return h=h.concat(this.route(p,e)),h.push(t),h}drawStartArrow(t,e,i){let r=t.ctx;if(this.arrows===1||this.arrows===3){let s=this.calculateArrowPoints(e,i);if(s[2]=i,this.fillArrow){r.fillStyle=this.lineColor.toString(),r.beginPath();for(let o=0;o<s.length;o++)o===0?r.moveTo(s[o].x,s[o].y):r.lineTo(s[o].x,s[o].y);r.fill()}else r.strokeStyle=this.lineColor.toString(),r.lineWidth=this.lineWidth,r.beginPath(),r.moveTo(i.x,i.y),r.lineTo(s[0].x,s[0].y),r.moveTo(i.x,i.y),r.lineTo(s[1].x,s[1].y),r.stroke()}}drawStopArrow(t,e,i){let r=t.ctx;if(this.arrows===2||this.arrows===3){let s=this.calculateArrowPoints(e,i);if(s[2]=i,this.fillArrow){r.fillStyle=this.lineColor.toString(),r.beginPath();for(let o=0;o<s.length;o++)o===0?r.moveTo(s[o].x,s[o].y):r.lineTo(s[o].x,s[o].y);r.fill()}else r.strokeStyle=this.lineColor.toString(),r.lineWidth=this.lineWidth,r.beginPath(),r.moveTo(i.x,i.y),r.lineTo(s[0].x,s[0].y),r.moveTo(i.x,i.y),r.lineTo(s[1].x,s[1].y),r.stroke()}}calculateArrowPoints(t,e){let i=_d(e,t),r=Math.PI/10,s=new kt(this.arrowLength,i.theta-r),o=new kt(this.arrowLength,i.theta+r),a=new kt(Math.floor(this.arrowLength*Math.cos(r)),i.theta),h=Pt(s.toPoint(),e.x,e.y),l=Pt(o.toPoint(),e.x,e.y),d=Pt(a.toPoint(),e.x,e.y);return[h,l,d]}get minDist(){return this.scale*20}get tol(){return this.scale*.1}get tolxtol(){return this.scale*.01}get name(){return this.properties.getValue(pr)}get arrows(){return this.properties.getValue(dr)}get fillArrow(){return this.properties.getValue(ur)}get arrowLength(){return this.scale*this.properties.getValue(nr)}get lineColor(){return this.properties.getValue(cr)}get lineStyle(){return this.properties.getValue(gr)}get lineWidth(){return this.scale*this.properties.getValue(mr)}get router(){return this.properties.getValue(vr)}get sourceTerm(){return this.properties.getValue(xr)}get sourceWuid(){return this.properties.getValue(fr)}get targetTerm(){return this.properties.getValue(yr)}get targetWuid(){return this.properties.getValue(wr)}get points(){return oe(this.properties.getValue(br),this.scale)}},Hp=0,Tr="auto_scale_widgets",Fd=class extends ue{displayArgs;constructor(t,e,i){super(t,e),this.displayArgs=i??{},this.properties.add(new Wd(Tr))}parseNode(t){super.parseNode(t);let e=Hp++;this.macros.set("DID",`DID_${e}`);let i=this.properties.getValue("name");this.macros.set("DNAME",i);for(let r in this.displayArgs)this.macros.set(r,this.displayArgs[r]);for(let r of t.getNodes("widget")){let s=r.getString("widget_type"),o=this.display.createWidget(s,this);o&&(o.parseNode(r),this.widgets.push(o))}for(let r of t.getNodes("connection")){let s=new Ip(this.display);s.parseNode(r),this.connections.push(s)}}draw(t){for(let e of this.widgets.filter(i=>i.visible))e.drawHolder(t),e.draw(t),e.drawDecoration(t);for(let e of this.connections)e.draw(t);for(let e of this.widgets.filter(i=>i.visible))e.drawOverlay(t)}measureContentBounds(t){let e=0,i=0,r=0,s=0;for(let o of this.widgets.filter(a=>a.visible)){let a=t?o.bounds:o.unscaledBounds;e=Math.min(e,a.x),i=Math.min(i,a.y),r=Math.max(r,a.x+a.width),s=Math.max(s,a.y+a.height)}return{x:e,y:i,width:r-e,height:s-i}}get autoScaleWidgets(){return this.properties.getValue(Tr)}},Dp=0,Sr="group_name",Vr="opi_file",Cr="resize_behaviour",$d=class extends ue{linkedDisplay;resolvedOpiFile;constructor(t,e){super(t,e),this.properties.add(new _(Sr)),this.properties.add(new _(Vr)),this.properties.add(new b(Cr,0))}parseNode(t){super.parseNode(t);let e=Dp++;this.macros.set("LCID",`LCID_${e}`)}init(){this.opiFile&&(this.resolvedOpiFile=this.display.resolvePath(this.opiFile),fetch(this.resolvedOpiFile,{credentials:"same-origin"}).then(t=>{t.ok&&t.text().then(e=>{this.linkedDisplay=new Fd(this.display,this);let i=Nd.parseFromXML(e);this.linkedDisplay.parseNode(i),this.requestRepaint()})}))}draw(t){this.transparent||t.fillRect(A(C({},this.area),{color:this.backgroundColor}));let e=this.getLinkedWidget();if(this.linkedDisplay&&e)if(t.fillRect(A(C({},this.area),{color:this.linkedDisplay.backgroundColor})),this.resizeBehavior===0){let i=this.linkedDisplay.measureContentBounds(!1),{width:r,height:s}=i,o=this.display.scale;r*=o,s*=o;let a=r/s,h=this.width,l=h/a,d=h/r;l>this.height&&(l=this.height,h=l*a,d=l/r),this.linkedDisplay.relativeScale=d;let n=t.createChild(Math.ceil(h),Math.ceil(l));n.translate(i.x,i.y),this.linkedDisplay.draw(n),t.copy(n,this.x,this.y)}else if(this.resizeBehavior===1)console.warn("Unsupported resize behavior of LinkingContainer",this.resizeBehavior);else if(this.resizeBehavior===2){let i=this.linkedDisplay.measureContentBounds(!0),r=t.createChild(i.width,i.height);r.translate(i.x,i.y),this.linkedDisplay.draw(r),t.copy(r,this.x,this.y)}else this.resizeBehavior===3&&console.warn("Unsupported resize behavior of LinkingContainer",this.resizeBehavior)}getLinkedWidget(){return this.linkedDisplay&&this.groupName!==""?this.linkedDisplay.findWidgetByName(this.groupName):this.linkedDisplay}get widgets(){return this.linkedDisplay?this.linkedDisplay.widgets:[]}get connections(){return this.linkedDisplay?this.linkedDisplay.connections:[]}findWidget(t){if(this.linkedDisplay)return this.linkedDisplay.findWidget(t)}get opiFile(){return this.properties.getValue(Vr)}get groupName(){return this.properties.getValue(Sr)}get resizeBehavior(){return this.properties.getValue(Cr)}},Np=class{constructor(t){this.display=t}resolve(t,e){if(t.startsWith("/"))return`${this.display.absPrefix}${t.slice(1)}`;if(t.startsWith("http://")||t.startsWith("https://"))return t;if(e){let i=e.parent;for(;i;){if(i instanceof $d){let r=i.resolvedOpiFile,s=r.lastIndexOf("/")+1;return`${r.substring(0,s)}${t}`}i=i.parent}}return`${this.display.relPrefix}${t}`}},Fp=class{constructor(t,e){this.pvName=t,this.formula=e}pvValues=new Map;updateDataSource(t,e){this.pvValues.set(t,e)}clearState(){this.pvValues.clear()}getPVNames(){let t=this.formula.expression,e=[];return this.getExpressionParameters(t,e),e}getExpressionParameters(t,e){switch(t.type){case"ParameterLiteral":e.indexOf(t.value)===-1&&e.push(t.value);break;case"ConditionalExpression":this.getExpressionParameters(t.consequent,e),t.alternate&&this.getExpressionParameters(t.alternate,e);break;case"BinaryExpression":this.getExpressionParameters(t.left,e),this.getExpressionParameters(t.right,e);break;case"LogicalExpression":this.getExpressionParameters(t.left,e),this.getExpressionParameters(t.right,e);break;case"UnaryExpression":this.getExpressionParameters(t.argument,e);break;case"CallExpression":for(let i of t.arguments)this.getExpressionParameters(i,e);break}}execute(){let t=this.formula.expression;return this.executeExpression(t)}executeExpression(t){switch(t.type){case"BooleanLiteral":return t.value;case"ParameterLiteral":let e=this.pvValues.get(t.value);return e?e.value:void 0;case"ConstantLiteral":return t.value;case"NumericLiteral":return t.value;case"StringLiteral":return t.value;case"ConditionalExpression":return this.executeConditionalExpression(t);case"BinaryExpression":return this.executeBinaryExpression(t);case"LogicalExpression":return this.executeLogicalExpression(t);case"UnaryExpression":return this.executeUnaryExpression(t);case"CallExpression":return this.executeCallExpression(t);default:throw new Error("Unexpected expression type")}}executeBinaryExpression(t){let e=this.executeExpression(t.left),i=this.executeExpression(t.right);switch(t.operator){case"+":return e+i;case"-":return e-i;case"*":return e*i;case"/":return e/i;case"^":return Math.pow(e,i);case"%":return e%i;case"==":return e===i;case"!=":return e!==i;case"<=":return e<=i;case"<":return e<i;case">=":return e>=i;case">":return e>i;default:throw new Error(`Unexpected binary operator ${t.operator}`)}}executeLogicalExpression(t){let e=this.executeExpression(t.left),i=this.executeExpression(t.right);switch(t.operator){case"&&":return e&&i;case"||":return e||i;default:throw new Error(`Unexpected logical operator ${t.operator}`)}}executeConditionalExpression(t){let e=this.executeExpression(t.test),i=this.executeExpression(t.consequent);if(t.alternate===void 0)return e?i:null;{let r=this.executeExpression(t.alternate);return e?i:r}}executeUnaryExpression(t){let e=this.executeExpression(t.argument);switch(t.operator){case"-":return-e;case"+":return e;default:throw new Error(`Unexpected unary operator ${t.operator}`)}}executeCallExpression(t){let e=t.callee.name,i=[];for(let r of t.arguments)i.push(this.executeExpression(r));switch(e){case"abs":return Math.abs(i[0]);case"acos":return Math.acos(i[0]);case"asin":return Math.asin(i[0]);case"atan":return Math.atan(i[0]);case"cbrt":return Math.cbrt(i[0]);case"ceil":return Math.ceil(i[0]);case"cos":return Math.cos(i[0]);case"cosh":return Math.cosh(i[0]);case"exp":return Math.exp(i[0]);case"floor":return Math.floor(i[0]);case"log":return Math.log(i[0]);case"log10":return Math.log10(i[0]);case"round":return Math.round(i[0]);case"signum":return Math.sign(i[0]);case"sin":return Math.sin(i[0]);case"sinh":return Math.sinh(i[0]);case"sqrt":return Math.sqrt(i[0]);case"tan":return Math.tan(i[0]);case"tanh":return Math.tanh(i[0]);case"toDegrees":return i[0]*180/Math.PI;case"toRadians":return i[0]/180*Math.PI;case"parameterAcquisitionStatus":return this.callParameterAcquisitionStatus(i[0]);default:throw new Error(`Unsupported function '${e}'`)}}callParameterAcquisitionStatus(t){let e=this.pvValues.get(t);if(e)return e.acquisitionStatus}};function $p(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i}function Mt(t,e,i,r){var s=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(s,Mt.prototype),s.expected=e,s.found=i,s.location=r,s.name="SyntaxError",s}$p(Mt,Error);function _e(t,e,i){return i=i||" ",t.length>e?t:(e-=t.length,i+=i.repeat(e),t+i.slice(0,e))}Mt.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var i=null,r;for(r=0;r<t.length;r++)if(t[r].source===this.location.source){i=t[r].text.split(/\r\n|\n|\r/g);break}var s=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(s):s,a=this.location.source+":"+o.line+":"+o.column;if(i){var h=this.location.end,l=_e("",o.line.toString().length," "),d=i[s.line-1],n=s.line===h.line?h.column:d.length+1,p=n-s.column||1;e+=`
 --> `+a+`
`+l+` |
`+o.line+" | "+d+`
`+l+" | "+_e("",s.column-1," ")+_e("",p,"^")}else e+=`
 at `+a}return e};Mt.buildMessage=function(t,e){var i={literal:function(d){return'"'+s(d.text)+'"'},class:function(d){var n=d.parts.map(function(p){return Array.isArray(p)?o(p[0])+"-"+o(p[1]):o(p)});return"["+(d.inverted?"^":"")+n.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(d){return d.description}};function r(d){return d.charCodeAt(0).toString(16).toUpperCase()}function s(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(n){return"\\x0"+r(n)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(n){return"\\x"+r(n)})}function o(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(n){return"\\x0"+r(n)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(n){return"\\x"+r(n)})}function a(d){return i[d.type](d)}function h(d){var n=d.map(a),p,g;if(n.sort(),n.length>0){for(p=1,g=1;p<n.length;p++)n[p-1]!==n[p]&&(n[g]=n[p],g++);n.length=g}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}function l(d){return d?'"'+s(d)+'"':"end of input"}return"Expected "+h(t)+" but "+l(e)+" found."};function Op(t,e){e=e!==void 0?e:{};var i={},r=e.grammarSource,s={Start:ni},o=ni,a="=",h="false",l="true",d="pi",n="e",p=".",g="0",v='"',w="'",T="(",B=")",M=",",k="<=",W=">=",D="==",N="!=",K="&&",J="||",ht=/^[\t ]/,tt=/^[A-Z_a-z]/,lt=/^[a-zA-Z0-9_]/,st=/^[0-9]/,Rt=/^[1-9]/,Gt=/^[^\n\r\f"]/,et=/^[^\n\r\f']/,nt=/^[+\-]/,gt=/^[%*\/\^]/,mt=/^[<>]/,Et=j("=",!1),St=dt(["	"," "],!1,!1),Vt=j("false",!0),ft=j("true",!0),ut=j("PI",!0),ot=j("E",!0),pt=Ct("identifier"),zt=dt([["A","Z"],"_",["a","z"]],!1,!1),Ut=dt([["a","z"],["A","Z"],["0","9"],"_"],!1,!1),qt=Ct("boolean"),Yt=Ct("constant"),qd=Ct("number"),Ue=j(".",!1),Yd=j("0",!1),Xd=dt([["0","9"]],!1,!1),Kd=dt([["1","9"]],!1,!1),jd=Ct("string"),qe=j('"',!1),Ye=dt([`
`,"\r","\f",'"'],!0,!1),Zd=Ct("parameter"),Xe=j("'",!1),Ke=dt([`
`,"\r","\f","'"],!0,!1),je=j("(",!1),Ze=j(")",!1),pe=dt(["+","-"],!1,!1),Je=j(",",!1),Qe=dt(["%","*","/","^"],!1,!1),ti=j("<=",!1),ei=j(">=",!1),ii=dt(["<",">"],!1,!1),ri=j("==",!1),si=j("!=",!1),oi=j("&&",!1),ai=j("||",!1),Jd=function(u){return u},Qd=function(u){return{type:"Formula",expression:u}},tu=function(u){return u},eu=function(u,f){return{type:"Symbol",name:u+f.join("")}},iu=function(){return{type:"BooleanLiteral",value:!0}},ru=function(){return{type:"BooleanLiteral",value:!1}},su=function(){return{type:"ConstantLiteral",value:Math.PI}},ou=function(){return{type:"ConstantLiteral",value:Math.E}},au=function(){return{type:"NumericLiteral",value:parseFloat(ce())}},hu=function(){return{type:"NumericLiteral",value:parseFloat(ce())}},lu=function(){return{type:"NumericLiteral",value:parseFloat(ce())}},nu=function(u){return{type:"StringLiteral",value:u.join("")}},du=function(u){return{type:"ParameterLiteral",value:u.join("")}},uu=function(u){return u},pu=function(u,f){return{type:"UnaryExpression",operator:u,argument:f}},cu=function(u,f){return{type:"CallExpression",callee:u,arguments:f}},gu=function(u){return qu(Gu(u,0))},mu=function(u,f){return zu(u,f,3)},fu=function(u,f){return ee(u,f)},xu=function(u,f){return ee(u,f)},wu=function(u,f){return ee(u,f)},yu=function(u,f){return ee(u,f)},vu=function(u,f){return Uu(u,f)},c=e.peg$currPos|0,q=c,Wt=[{line:1,column:1}],at=c,te=e.peg$maxFailExpected||[],E=e.peg$silentFails|0,Xt;if(e.startRule){if(!(e.startRule in s))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');o=s[e.startRule]}function ce(){return t.substring(q,c)}function im(){return q}function rm(){return{source:r,start:q,end:c}}function sm(){return Kt(q,c)}function om(u,f){throw f=f!==void 0?f:Kt(q,c),li([Ct(u)],t.substring(q,c),f)}function am(u,f){throw f=f!==void 0?f:Kt(q,c),Tu(u,f)}function j(u,f){return{type:"literal",text:u,ignoreCase:f}}function dt(u,f,L){return{type:"class",parts:u,inverted:f,ignoreCase:L}}function hm(){return{type:"any"}}function bu(){return{type:"end"}}function Ct(u){return{type:"other",description:u}}function hi(u){var f=Wt[u],L;if(f)return f;if(u>=Wt.length)L=Wt.length-1;else for(L=u;!Wt[--L];);for(f=Wt[L],f={line:f.line,column:f.column};L<u;)t.charCodeAt(L)===10?(f.line++,f.column=1):f.column++,L++;return Wt[u]=f,f}function Kt(u,f,L){var x=hi(u),P=hi(f),V={source:r,start:{offset:u,line:x.line,column:x.column},end:{offset:f,line:P.line,column:P.column}};return L&&r&&typeof r.offset=="function"&&(V.start=r.offset(V.start),V.end=r.offset(V.end)),V}function I(u){c<at||(c>at&&(at=c,te=[]),te.push(u))}function Tu(u,f){return new Mt(u,null,null,f)}function li(u,f,L){return new Mt(Mt.buildMessage(u,f),u,f,L)}function ni(){var u,f,L,x,P;return u=c,t.charCodeAt(c)===61?(f=a,c++):(f=i,E===0&&I(Et)),f!==i?(L=z(),x=Su(),x!==i?(P=z(),q=u,u=Jd(x)):(c=u,u=i)):(c=u,u=i),u}function Su(){var u,f;return u=c,f=jt(),f!==i&&(q=u,f=Qd(f)),u=f,u}function z(){var u,f;for(u=[],f=di();f!==i;)u.push(f),f=di();return u}function di(){var u;return u=t.charAt(c),ht.test(u)?c++:(u=i,E===0&&I(St)),u}function Vu(){var u;return u=t.substr(c,5),u.toLowerCase()===h?c+=5:(u=i,E===0&&I(Vt)),u}function Cu(){var u;return u=t.substr(c,4),u.toLowerCase()===l?c+=4:(u=i,E===0&&I(ft)),u}function Au(){var u;return u=t.substr(c,2),u.toLowerCase()===d?c+=2:(u=i,E===0&&I(ut)),u}function _u(){var u;return u=t.charAt(c),u.toLowerCase()===n?c++:(u=i,E===0&&I(ot)),u}function Lu(){var u,f;return u=c,f=Pu(),f!==i&&(q=u,f=tu(f)),u=f,u}function Pu(){var u,f,L,x;if(E++,u=c,f=ku(),f!==i){for(L=[],x=ui();x!==i;)L.push(x),x=ui();q=u,u=eu(f,L)}else c=u,u=i;return E--,u===i&&(f=i,E===0&&I(pt)),u}function ku(){var u;return u=t.charAt(c),tt.test(u)?c++:(u=i,E===0&&I(zt)),u}function ui(){var u;return u=t.charAt(c),lt.test(u)?c++:(u=i,E===0&&I(Ut)),u}function Mu(){var u;return u=Ru(),u===i&&(u=Eu(),u===i&&(u=Wu(),u===i&&(u=Iu(),u===i&&(u=Hu())))),u}function Ru(){var u,f;return E++,u=c,f=Cu(),f!==i&&(q=u,f=iu()),u=f,u===i&&(u=c,f=Vu(),f!==i&&(q=u,f=ru()),u=f),E--,u===i&&(f=i,E===0&&I(qt)),u}function Eu(){var u,f;return E++,u=c,f=Au(),f!==i&&(q=u,f=su()),u=f,u===i&&(u=c,f=_u(),f!==i&&(q=u,f=ou()),u=f),E--,u===i&&(f=i,E===0&&I(Yt)),u}function Wu(){var u,f,L,x,P;if(E++,u=c,f=pi(),f!==i)if(t.charCodeAt(c)===46?(L=p,c++):(L=i,E===0&&I(Ue)),L!==i){for(x=[],P=Bt();P!==i;)x.push(P),P=Bt();q=u,u=au()}else c=u,u=i;else c=u,u=i;if(u===i){if(u=c,t.charCodeAt(c)===46?(f=p,c++):(f=i,E===0&&I(Ue)),f!==i){if(L=[],x=Bt(),x!==i)for(;x!==i;)L.push(x),x=Bt();else L=i;L!==i?(q=u,u=hu()):(c=u,u=i)}else c=u,u=i;u===i&&(u=c,f=pi(),f!==i&&(q=u,f=lu()),u=f)}return E--,u===i&&(f=i,E===0&&I(qd)),u}function pi(){var u,f,L,x;if(t.charCodeAt(c)===48?(u=g,c++):(u=i,E===0&&I(Yd)),u===i)if(u=c,f=Bu(),f!==i){for(L=[],x=Bt();x!==i;)L.push(x),x=Bt();f=[f,L],u=f}else c=u,u=i;return u}function Bt(){var u;return u=t.charAt(c),st.test(u)?c++:(u=i,E===0&&I(Xd)),u}function Bu(){var u;return u=t.charAt(c),Rt.test(u)?c++:(u=i,E===0&&I(Kd)),u}function Iu(){var u,f,L,x;if(E++,u=c,t.charCodeAt(c)===34?(f=v,c++):(f=i,E===0&&I(qe)),f!==i){for(L=[],x=t.charAt(c),Gt.test(x)?c++:(x=i,E===0&&I(Ye));x!==i;)L.push(x),x=t.charAt(c),Gt.test(x)?c++:(x=i,E===0&&I(Ye));t.charCodeAt(c)===34?(x=v,c++):(x=i,E===0&&I(qe)),x!==i?(q=u,u=nu(L)):(c=u,u=i)}else c=u,u=i;return E--,u===i&&(f=i,E===0&&I(jd)),u}function Hu(){var u,f,L,x;if(E++,u=c,t.charCodeAt(c)===39?(f=w,c++):(f=i,E===0&&I(Xe)),f!==i){for(L=[],x=t.charAt(c),et.test(x)?c++:(x=i,E===0&&I(Ke));x!==i;)L.push(x),x=t.charAt(c),et.test(x)?c++:(x=i,E===0&&I(Ke));t.charCodeAt(c)===39?(x=w,c++):(x=i,E===0&&I(Xe)),x!==i?(q=u,u=du(L)):(c=u,u=i)}else c=u,u=i;return E--,u===i&&(f=i,E===0&&I(Zd)),u}function Du(){var u,f,L,x,P,V;return u=Mu(),u===i&&(u=c,t.charCodeAt(c)===40?(f=T,c++):(f=i,E===0&&I(je)),f!==i?(L=z(),x=jt(),x!==i?(P=z(),t.charCodeAt(c)===41?(V=B,c++):(V=i,E===0&&I(Ze)),V!==i?(q=u,u=uu(x)):(c=u,u=i)):(c=u,u=i)):(c=u,u=i)),u}function ci(){var u,f,L,x,P;return u=Du(),u===i&&(u=c,f=Nu(),f!==i?(L=z(),x=ci(),x!==i?(P=z(),q=u,u=pu(f,x)):(c=u,u=i)):(c=u,u=i)),u}function Nu(){var u;return u=t.charAt(c),nt.test(u)?c++:(u=i,E===0&&I(pe)),u}function ge(){var u,f,L,x;return u=c,f=Lu(),f!==i?(L=z(),x=Fu(),x!==i?(q=u,u=cu(f,x)):(c=u,u=i)):(c=u,u=i),u===i&&(u=ci()),u}function Fu(){var u,f,L,x,P,V;return u=c,t.charCodeAt(c)===40?(f=T,c++):(f=i,E===0&&I(je)),f!==i?(L=z(),x=c,P=$u(),P!==i?(V=z(),P=[P,V],x=P):(c=x,x=i),x===i&&(x=null),t.charCodeAt(c)===41?(P=B,c++):(P=i,E===0&&I(Ze)),P!==i?(q=u,u=gu(x)):(c=u,u=i)):(c=u,u=i),u}function $u(){var u,f,L,x,P,V,Y,F;if(u=c,f=jt(),f!==i){for(L=[],x=c,P=z(),t.charCodeAt(c)===44?(V=M,c++):(V=i,E===0&&I(Je)),V!==i?(Y=z(),F=jt(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.charCodeAt(c)===44?(V=M,c++):(V=i,E===0&&I(Je)),V!==i?(Y=z(),F=jt(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=mu(f,L)}else c=u,u=i;return u}function me(){var u,f,L,x,P,V,Y,F;if(u=c,f=ge(),f!==i){for(L=[],x=c,P=z(),V=t.charAt(c),gt.test(V)?c++:(V=i,E===0&&I(Qe)),V!==i?(Y=z(),F=ge(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),V=t.charAt(c),gt.test(V)?c++:(V=i,E===0&&I(Qe)),V!==i?(Y=z(),F=ge(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=fu(f,L)}else c=u,u=i;return u}function fe(){var u,f,L,x,P,V,Y,F;if(u=c,f=me(),f!==i){for(L=[],x=c,P=z(),V=t.charAt(c),nt.test(V)?c++:(V=i,E===0&&I(pe)),V!==i?(Y=z(),F=me(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),V=t.charAt(c),nt.test(V)?c++:(V=i,E===0&&I(pe)),V!==i?(Y=z(),F=me(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=xu(f,L)}else c=u,u=i;return u}function xe(){var u,f,L,x,P,V,Y,F;if(u=c,f=fe(),f!==i){for(L=[],x=c,P=z(),t.substr(c,2)===k?(V=k,c+=2):(V=i,E===0&&I(ti)),V===i&&(t.substr(c,2)===W?(V=W,c+=2):(V=i,E===0&&I(ei)),V===i&&(V=t.charAt(c),mt.test(V)?c++:(V=i,E===0&&I(ii)))),V!==i?(Y=z(),F=fe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.substr(c,2)===k?(V=k,c+=2):(V=i,E===0&&I(ti)),V===i&&(t.substr(c,2)===W?(V=W,c+=2):(V=i,E===0&&I(ei)),V===i&&(V=t.charAt(c),mt.test(V)?c++:(V=i,E===0&&I(ii)))),V!==i?(Y=z(),F=fe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=wu(f,L)}else c=u,u=i;return u}function we(){var u,f,L,x,P,V,Y,F;if(u=c,f=xe(),f!==i){for(L=[],x=c,P=z(),t.substr(c,2)===D?(V=D,c+=2):(V=i,E===0&&I(ri)),V===i&&(t.substr(c,2)===N?(V=N,c+=2):(V=i,E===0&&I(si))),V!==i?(Y=z(),F=xe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.substr(c,2)===D?(V=D,c+=2):(V=i,E===0&&I(ri)),V===i&&(t.substr(c,2)===N?(V=N,c+=2):(V=i,E===0&&I(si))),V!==i?(Y=z(),F=xe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=yu(f,L)}else c=u,u=i;return u}function jt(){var u,f,L,x,P,V,Y,F;if(u=c,f=we(),f!==i){for(L=[],x=c,P=z(),t.substr(c,2)===K?(V=K,c+=2):(V=i,E===0&&I(oi)),V===i&&(t.substr(c,2)===J?(V=J,c+=2):(V=i,E===0&&I(ai))),V!==i?(Y=z(),F=we(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.substr(c,2)===K?(V=K,c+=2):(V=i,E===0&&I(oi)),V===i&&(t.substr(c,2)===J?(V=J,c+=2):(V=i,E===0&&I(ai))),V!==i?(Y=z(),F=we(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=vu(f,L)}else c=u,u=i;return u}function Ou(u,f){return u.map(function(L){return L[f]})}function Gu(u,f){return u?u[f]:null}function zu(u,f,L){return[u].concat(Ou(f,L))}function ee(u,f){return f.reduce(function(L,x){return{type:"BinaryExpression",operator:x[1],left:L,right:x[3]}},u)}function Uu(u,f){return f.reduce(function(L,x){return{type:"LogicalExpression",operator:x[1],left:L,right:x[3]}},u)}function qu(u){return u!==null?u:[]}if(Xt=o(),e.peg$library)return{peg$result:Xt,peg$currPos:c,peg$FAILED:i,peg$maxFailExpected:te,peg$maxFailPos:at};if(Xt!==i&&c===t.length)return Xt;throw Xt!==i&&c<t.length&&I(bu()),li(te,at<t.length?t.charAt(at):null,at<t.length?Kt(at,at+1):Kt(at,at))}var Gp=class{compile(t){let e=Op(t,{});return new Fp(t,e)}execute(t){return this.compile(t).execute()}},zp=class{pvs=new Map;canProvide(t){return t.startsWith("=")}startProviding(t){for(let e of t)this.pvs.set(e.name,new Up(e))}stopProviding(t){for(let e of t)this.pvs.delete(e.name)}isNavigable(){return!1}shutdown(){}},Up=class{constructor(t){this.pv=t;let e=new Gp;this.compiledFormula=e.compile(t.name);for(let i of this.compiledFormula.getPVNames()){let r=t.pvEngine.createPV(i);this.compiledFormula.updateDataSource(r.name,{value:r.value,acquisitionStatus:"good"}),t.pvEngine.addListener(i,()=>{this.compiledFormula.updateDataSource(i,{value:t.pvEngine.getValue(i),acquisitionStatus:"good"}),this.trigger()})}this.trigger()}compiledFormula;trigger(){let t=this.compiledFormula.execute();this.pv.pvEngine.setValue(new Date,this.pv.name,t)}};function Od(t){return!isNaN(t)&&(Number.isInteger(parseFloat(t))||t%1!==0)}function Ar(t){return Od(t)?parseFloat(t):(console.warn(`Not a valid float: ${t}`),t)}function _r(t){return t!=null?String(t):t}var qp=class extends Hd{constructor(t,e,i,r){super(t,e),this.type=i,this.initializer=r,this.writable=!0}setSample(t){if(this.type==="VDouble")t.value=Ar(t.value);else if(this.type==="VDoubleArray")for(let e=0;e<t.value.length;e++)t.value[e]=Ar(t.value);else if(this.type==="VString")t.value=_r(t.value);else if(this.type==="VStringArray")for(let e=0;e<t.value.length;e++)t.value[e]=_r(t.value);else typeof t.value=="string"&&Od(t.value)&&(t.value=parseFloat(t.value));super.setSample(t)}},Gd=/(loc\:\/\/[^\(<]+)(<(.*)>)?(\((.*)\))?/;function It(t){if(!t.startsWith("loc://"))return t;let e=t.match(Gd);return e?e[1]:t}var Yp=class{constructor(t){this.display=t}rules=[];scripts=[];pvs=new Map;providers=[];scriptLibraries={};listeners=new Map;init(){for(let t of this.listeners.entries()){let e=this.pvs.get(t[0]);if(e&&e.value!==null&&e.value!==void 0)for(let i of t[1])i()}}clearState(){this.disconnectAll(),this.rules=[],this.scripts=[],this.listeners.clear()}getPVNames(){return[...this.pvs.keys()]}hasPV(t){let e=It(t);return this.pvs.has(e)}getPV(t){let e=It(t);return this.pvs.get(e)}disconnectAll(){for(let t of this.providers){let e=[];for(let i of this.pvs.values())t.canProvide(i.name)&&e.push(i);e.length&&t.stopProviding(e)}this.pvs.clear()}createPV(t){if(t.startsWith("loc://"))return this.createLocalPV(t);let e=this.pvs.get(t);if(e)return e;e=new Hd(t,this),this.pvs.set(t,e);for(let i of this.providers)if(i.canProvide(t))return e.navigable=i.isNavigable(),i.startProviding([e]),e;return console.warn(`No provider for PV ${t}`),e.disconnected=!0,e}createHistoricalDataProvider(t,e){for(let i of this.providers)if(i.canProvide(t)){if(i.createHistoricalDataProvider)return i.createHistoricalDataProvider(t,e);break}}requestRepaint(){this.display.requestRepaint()}createLocalPV(t){let e=t.match(Gd),i,r;if(e){if(t=e[1],e[3])switch(e[3]){case"VDouble":case"VDoubleArray":case"VString":case"VStringArray":i=e[3];break;default:console.warn(`Unknown local PV type information: ${e[3]}`)}if(e[5]!==void 0){let a=e[5];a.startsWith('"')&&a.endsWith('"')?r=a.substring(1,a.length-1):a.indexOf(",")!==-1?r=a.split(",").map(h=>{let l=h.trim();return l.startsWith('"')&&l.endsWith('"')?l.substring(1,l.length-1):Number(l)}):r=Number(a)}}let s=this.pvs.get(t),o=!1;if(s){let a=s;a.type&&i&&a.type!==i&&console.warn(`PV ${t} is defined with different types: ${a.type} !== ${i}`),a.initializer!==void 0&&r!==void 0&&!this.initializerEquals(a.initializer,r)?console.warn(`PV ${t} is defined with different initializers: ${a.initializer} !== ${r}`):a.initializer===void 0&&r!==void 0&&(o=!0)}return s?i&&!s.type&&(s.type=i):(s=new qp(t,this,i,r),this.pvs.set(t,s),o=!0),o&&r!==void 0&&this.setValue(new Date,t,r),s}initializerEquals(t,e){if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}else return t===e}getValue(t){let e=It(t),i=this.pvs.get(e);if(i)return i.value}setValue(t,e,i,r="NONE"){let s=It(e),o=this.pvs.get(s);if(o){o.setSample({time:t,value:i,severity:r});for(let a of this.listeners.get(s)||[])a()}else throw new Error(`Cannot set value of unknown PV ${e}`)}setValues(t){let e=[];for(let i of t.keys()){let r=this.pvs.get(i);if(r){r.setSample(t.get(i));for(let s of this.listeners.get(i)||[])e.push(s)}else console.warn(`Received an update for unknown pv ${i}`)}for(let i of e)i()}createScript(t,e,i){let r=[];for(let o of e.inputs){let a=t.expandMacro(o.pvName);r.push(this.createPV(a))}let s=new Xp(t,e,i,r);this.scripts.push(s);for(let o=0;o<e.inputs.length;o++){let a=e.inputs[o],h=r[o];if(a.trigger){let l=t.expandMacro(a.pvName);this.addListener(l,()=>{if(e.checkConnect)for(let d=0;d<e.inputs.length;d++){let n=r[d],p=e.inputs[d].trigger,g=n.value!==null&&n.value!==void 0;if(n.disconnected||p&&!g)return}s.scriptEngine.run(h)},!1)}}return s}createRule(t,e){let i=[];for(let o of e.inputs){let a=t.expandMacro(o.pvName);i.push(this.createPV(a))}let r=new Kp(t,e,i);this.rules.push(r);let s=()=>r.scriptEngine.run();for(let o of e.inputs)if(o.trigger){let a=t.expandMacro(o.pvName);this.addListener(a,s,!1)}}addProvider(t){this.providers.push(t)}addScriptLibrary(t,e){this.scriptLibraries[t]=e}addListener(t,e,i=!0){let r=It(t),s=this.listeners.get(r);if(s?s.push(e):this.listeners.set(r,[e]),i){let o=this.pvs.get(r);o&&o.value!==null&&o.value!==void 0&&e()}}removeListener(t,e){let i=It(t),r=this.listeners.get(i);if(r){let s=r.indexOf(e);s!==-1&&r.splice(s,1)}}},Xp=class{constructor(t,e,i,r){this.widget=t,this.script=e,this.text=i,this.pvs=r,this.scriptEngine=new he(t,i,r)}scriptEngine},Kp=class{constructor(t,e,i){this.widget=t,this.rule=e;let r="",s=t.properties.getProperty(e.propertyName);if(!s)throw new Error(`Cannot create rule for unsupported property ${e.propertyName}`);if(e.expressions.length){let o=!1,a=!1,h=!1,l=!1;for(let p of e.expressions)p.expression.match(/pv[0-9]+/)&&(o=!0),e.outputExpression&&p.outputValue.toString().match(/pv[0-9]+/)&&(o=!0),p.expression.indexOf("pvInt")!==-1&&(a=!0),e.outputExpression&&p.outputValue.toString().indexOf("pvInt")!==-1&&(a=!0),p.expression.indexOf("pvStr")!==-1&&(h=!0),e.outputExpression&&p.outputValue.toString().indexOf("pvStr")!==-1&&(h=!0),p.expression.indexOf("pvSev")!==-1&&(l=!0),e.outputExpression&&p.outputValue.toString().indexOf("pvSev")!==-1&&(l=!0);for(let p=0;p<i.length;p++)o&&(r+=`var pv${p} = PVUtil.getDouble(pvs[${p}]);
`),a&&(r+=`var pvInt${p} = PVUtil.getLong(pvs[${p}]);
`),h&&(r+=`var pvStr${p} = PVUtil.getString(pvs[${p}]);
`),l&&(r+=`var pvSev${p} = PVUtil.getSeverity(pvs[${p}]);
`);for(let p=0;p<e.expressions.length;p++){let g=e.expressions[p].expression,v=e.expressions[p].outputValue;if(p>0&&(r+="else "),r+=`if (${g}) widget.setPropertyValue("${e.propertyName}", `,e.outputExpression)r+=`${v});
`;else{let w=this.printScriptValue(s,v);r+=`${w});
`}}let d=s.value,n=this.printScriptValue(s,d);r+=`else widget.setPropertyValue("${e.propertyName}", `,r+=`${n});
`}this.scriptEngine=new he(t,r,i)}scriptEngine;printScriptValue(t,e){return e==null?"null":t.printScriptValue(e)}},Ot=class{constructor(t,e,i){this.pv=t,this.interval=e,i!==void 0&&t.pvEngine.setValue(new Date,t.name,i),this.interval>0&&(this.timer=window.setInterval(()=>{this.generateSample(new Date)},e))}timer;emit(t,e){let i="NONE";this.pv.lowerAlarmLimit!==void 0&&e<this.pv.lowerAlarmLimit||this.pv.upperAlarmLimit!==void 0&&e>this.pv.upperAlarmLimit?i="MAJOR":(this.pv.lowerWarningLimit!==void 0&&e<this.pv.lowerWarningLimit||this.pv.upperWarningLimit!==void 0&&e>this.pv.upperWarningLimit)&&(i="MINOR"),this.pv.pvEngine.setValue(t,this.pv.name,e,i)}stop(){window.clearInterval(this.timer)}},Lt=class extends Ot{constructor(t,e){super(t,-1,e)}generateSample(){}},jp=class extends Ot{constructor(t,e){super(t,1e3),this.formatter=e}generateSample(t){let e=this.formatter.formatDate(t,{year:!0,month:!0,day:!0})+" "+this.formatter.formatTime(t,{hours:!0,minutes:!0,seconds:!0,milliseconds:!0});this.emit(t,e)}},Lr=class extends Ot{constructor(t,e,i,r){super(t,r),this.min=e,this.max=i;let s=this.max-this.min;t.units="x",t.lowerDisplayLimit=e,t.lowerAlarmLimit=e+s*.1,t.lowerWarningLimit=e+s*.2,t.upperWarningLimit=e+s*.8,t.upperAlarmLimit=e+s*.9,t.upperDisplayLimit=i}generateSample(t){let e=Math.random()*(this.max-this.min)+this.min;this.emit(t,e)}},Pr=class extends Ot{constructor(t,e,i,r){super(t,r),this.avg=e,this.stddev=i,t.units="x",t.lowerDisplayLimit=e-4*i,t.lowerAlarmLimit=e-2*i,t.lowerWarningLimit=e-i,t.upperWarningLimit=e+i,t.upperAlarmLimit=e+2*i,t.upperDisplayLimit=e+4*i}generateSample(t){let e,i,r;do e=2*Math.random()-1,i=2*Math.random()-1,r=e*e+i*i;while(r>=1||r===0);let s=Math.sqrt(-2*Math.log(r)/r),o=e*s;this.emit(t,this.avg+o*this.stddev)}},Le=class extends Ot{constructor(t,e,i,r,s){super(t,s),this.min=e,this.max=i,this.samplesPerCycle=r;let o=this.max-this.min;t.units="x",t.lowerDisplayLimit=e,t.lowerAlarmLimit=e+o*.1,t.lowerWarningLimit=e+o*.2,t.upperWarningLimit=e+o*.8,t.upperAlarmLimit=e+o*.9,t.upperDisplayLimit=i}currentValue=0;generateSample(t){let e=this.max-this.min,i=Math.sin(this.currentValue*2*Math.PI/this.samplesPerCycle)*e/2+this.min+e/2;this.currentValue++,this.emit(t,i)}},Pe=class extends Ot{constructor(t,e,i,r,s){super(t,s),this.min=e,this.max=i,this.inc=r,r>=0?this.currentValue=e-r:this.currentValue=i-r;let o=this.max-this.min;t.units="x",t.lowerDisplayLimit=e,t.lowerAlarmLimit=e+o*.1,t.lowerWarningLimit=e+o*.2,t.upperWarningLimit=e+o*.8,t.upperAlarmLimit=e+o*.9,t.upperDisplayLimit=i}currentValue=0;generateSample(t){this.currentValue=this.currentValue+this.inc,this.currentValue>this.max&&(this.currentValue=this.min),this.currentValue<this.min&&(this.currentValue=this.max),this.emit(t,this.currentValue)}},Zp=/sim\:\/\/([a-zA-Z]+)(\((.*)\))?/,Jp=class{pvs=new Map;canProvide(t){return t.startsWith("sim://")}startProviding(t){for(let e of t){let i=new Qp(e);this.pvs.set(e.name,i)}}stopProviding(t){for(let e of t){let i=this.pvs.get(e.name);i&&(i.fn.stop(),this.pvs.delete(e.name))}}isNavigable(){return!1}shutdown(){for(let t of this.pvs.values())t.fn.stop()}},Qp=class{constructor(t){this.pv=t;let e=t.name.match(Zp);if(e){let i=e[3]?e[3].split(","):[];for(let r=0;r<i.length;r++)i[r]=i[r].trim();this.fn=this.createGenerator(e[1],i)}else console.warn(`Unexpected pattern for PV ${t.name}`),this.fn=new Lt(t,void 0)}fn;createGenerator(t,e){switch(t){case"const":let i=this.saferEval(e[0]);return new Lt(this.pv,i);case"gaussianNoise":return this.createGaussianNoise(e);case"noise":return this.createNoise(e);case"ramp":return this.createRamp(e);case"sine":return this.createSine(e);default:return console.warn(`Unexpected function ${t} for PV ${this.pv.name}`),new Lt(this.pv,void 0)}}saferEval(t){return Function('"use strict";return ('+t+")")()}createNoise(t){if(t.length===0)return new Lr(this.pv,-5,5,1e3);{let e=parseFloat(t[0]),i=parseFloat(t[1]),r=parseFloat(t[2])*1e3;return new Lr(this.pv,e,i,r)}}createGaussianNoise(t){if(t.length===0)return new Pr(this.pv,0,1,100);{let e=parseFloat(t[0]),i=parseFloat(t[1]),r=parseFloat(t[2])*1e3;return new Pr(this.pv,e,i,r)}}createRamp(t){let e;if(t.length===0)e=new Pe(this.pv,-5,5,1,1e3);else if(t.length===3){let i=parseFloat(t[0]),r=parseFloat(t[1]),s=parseFloat(t[2])*1e3;e=new Pe(this.pv,i,r,1,s)}else if(t.length===4){let i=parseFloat(t[0]),r=parseFloat(t[1]),s=parseFloat(t[2]),o=parseFloat(t[3])*1e3;e=new Pe(this.pv,i,r,s,o)}else return console.warn(`Unexpected ramp arguments for PV ${this.pv.name}`),new Lt(this.pv,void 0);return e}createSine(t){let e;if(t.length===0)e=new Le(this.pv,-5,5,10,1e3);else if(t.length===3){let i=parseFloat(t[0]),r=parseFloat(t[1]),s=parseFloat(t[2])*1e3;e=new Le(this.pv,i,r,10,s)}else if(t.length===4){let i=parseFloat(t[0]),r=parseFloat(t[1]),s=parseFloat(t[2]),o=parseFloat(t[3])*1e3;e=new Le(this.pv,i,r,s,o)}else return console.warn(`Unexpected sine arguments for PV ${this.pv.name}`),new Lt(this.pv,void 0);return e}},tc=/sys\:\/\/([a-zA-Z]+)/,ec=class{constructor(t){this.formatter=t}pvs=new Map;canProvide(t){return t==="sys://time"}startProviding(t){for(let e of t){let i=new ic(e,this.formatter);this.pvs.set(e.name,i)}}stopProviding(t){for(let e of t){let i=this.pvs.get(e.name);i&&(i.fn.stop(),this.pvs.delete(e.name))}}isNavigable(){return!1}shutdown(){for(let t of this.pvs.values())t.fn.stop()}},ic=class{constructor(t,e){this.pv=t,this.formatter=e;let i=t.name.match(tc);i?this.fn=this.createGenerator(i[1]):(console.warn(`Unexpected pattern for PV ${t.name}`),this.fn=new Lt(t,void 0))}fn;createGenerator(t){switch(t){case"time":return new jp(this.pv,this.formatter);default:return console.warn(`Unexpected function ${t} for PV ${this.pv.name}`),new Lt(this.pv,void 0)}}},kr="font",Mr="push_action_index",Rr="release_action_index",Er="toggle_button",Wr="image",zd=class extends G{areaRegion;pushed=!1;imageElement;imageLoaded=!1;constructor(t,e){super(t,e),this.properties.add(new O(kr)),this.properties.add(new y(Er)),this.properties.add(new b(Mr)),this.properties.add(new b(Rr)),this.properties.add(new _(Wr))}init(){this.image&&(this.imageElement=new Image,this.imageElement.onload=()=>{this.imageLoaded=!0,this.requestRepaint()},this.imageElement.src=this.resolvePath(this.image)),this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.toggleButton||(this.pushed=!0,this.requestRepaint())},mouseOut:()=>{this.pushed=!1,this.requestRepaint()},mouseUp:()=>{this.toggleButton||(this.pushed=!1,this.requestRepaint())},click:()=>{this.executeActionByIndex(this.pushed?this.releaseActionIndex:this.pushActionIndex),this.toggleButton&&(this.pushed=!this.pushed)},tooltip:()=>this.tooltip,cursor:"pointer"}}draw(t){let e=t.ctx,{scale:i}=this;t.fillRect(A(C({},this.area),{color:this.backgroundColor})),t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let r=1*i,s=this.holderY+r/2,o=this.holderX+r/2,a=this.holderY+this.holderHeight-r+r/2,h=this.holderX+this.holderWidth-r+r/2;t.strokePath({lineWidth:r,color:this.pushed?m.BUTTON_LIGHTEST:m.BLACK,path:new S(h,a).lineTo(h,s).moveTo(h,a).lineTo(o,a)}),t.strokePath({lineWidth:r,color:this.pushed?this.backgroundColor:m.BUTTON_DARKER,path:new S(h-r,a-r).lineTo(h-r,s+r).moveTo(h-r,a-r).lineTo(o+r,a-r)}),t.strokePath({lineWidth:r,color:this.pushed?m.BLACK:m.BUTTON_LIGHTEST,path:new S(o,s).lineTo(h-r,s).moveTo(o,s).lineTo(o,a-r)}),t.strokePath({lineWidth:r,color:this.pushed?m.BUTTON_DARKER:this.backgroundColor,path:new S(o+r,s+r).lineTo(h-r-r,s+r).moveTo(o+r,s+r).lineTo(o+r,a-r-r)});let l=this.text.split(`
`);e.fillStyle=this.foregroundColor.toString(),e.font=this.font.getFontString();let d,n;if(this.imageElement&&this.imageLoaded){let p=e.measureText(l[0]).width,g=this.font.height,v=this.imageElement.naturalHeight*i,w=this.imageElement.naturalWidth*i,T=(this.height-v)/g,B=(this.width-w)/p,M=5*i;if(B>T){e.textBaseline="middle",e.textAlign="left",d=this.x+(this.width-p)/2+M,n=this.y+this.height/2;let k=this.x+(this.width-p)/2-w,W=this.y+(this.height-v)/2;e.drawImage(this.imageElement,k,W,w,v)}else{e.textAlign="center",e.textBaseline="top";let k=g+v;d=this.x+this.width/2,n=this.y+(this.height-k)/2+v;let W=this.x+(this.width-w)/2,D=this.y+(this.height-k)/2;e.drawImage(this.imageElement,W,D,w,v)}this.pushed&&(d+=1*i,n+=1*i),e.fillText(l[0],d,n)}else{e.textAlign="start",e.textBaseline="top";let p=0;for(let v of l){let w=e.measureText(v).width;p=Math.max(p,w)}d=this.x+(this.width-p)/2;let g=l.length*this.font.height+(l.length-1)*this.font.height*.2;n=this.y+(this.height-g)/2;for(let v of l){let w=d,T=n;this.pushed&&(w+=1*i,T+=1*i),e.fillText(v,w,T),n+=this.font.height*1.2}}}getHookedActions(){let{actions:t}=this;if(t.hookAllActionsToClick)return t.actions;if(this.pushed){let e=this.releaseActionIndex;return[t.getAction(e)]}else{let e=this.pushActionIndex;return[t.getAction(e)]}}get font(){return this.properties.getValue(kr).scale(this.scale)}get image(){return this.properties.getValue(Wr)}get toggleButton(){return this.properties.getValue(Er)}get pushActionIndex(){return this.properties.getValue(Mr)}get releaseActionIndex(){return this.properties.getValue(Rr)}get backgroundColor(){let t=this.properties.getProperty("background_color");return t&&t.value!==m.TRANSPARENT?t.value:m.BUTTON}},Br="bit",Ir="data_type",Hr="effect_3d",Dr="font",Nr="off_color",Fr="off_label",$r="off_state",Or="on_color",Gr="on_label",zr="on_state",Ur="push_action_index",qr="released_action_index",Yr="show_led",Xr="show_boolean_label",Kr="square_button",jr="toggle_button",rc=class extends G{hovered=!1;manualToggleState=!1;areaRegion;constructor(t,e){super(t,e),this.properties.add(new b(Br)),this.properties.add(new b(Ir)),this.properties.add(new y(Kr)),this.properties.add(new y(Yr)),this.properties.add(new y(Hr)),this.properties.add(new R(Or)),this.properties.add(new _(Gr)),this.properties.add(new _(zr)),this.properties.add(new R(Nr)),this.properties.add(new _(Fr)),this.properties.add(new _($r)),this.properties.add(new O(Dr)),this.properties.add(new y(jr)),this.properties.add(new b(Ur)),this.properties.add(new b(qr)),this.properties.add(new y(Xr))}init(){this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.toggleButton?this.booleanValue?this.toggleOff():this.toggleOn():this.toggleOn(),this.requestRepaint()},mouseEnter:()=>{this.hovered=!0,this.requestRepaint()},mouseUp:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},mouseOut:()=>{this.booleanValue&&!this.toggleButton&&this.toggleOff(),this.hovered=!1,this.requestRepaint()},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.onState);this.executeActionByIndex(this.pushActionIndex)}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.offState);this.releaseActionIndex!==void 0&&this.executeActionByIndex(this.releaseActionIndex)}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.dataType===0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.dataType===1?this.pv.toString()===this.onState:!1:this.manualToggleState}draw(t){let e=this.booleanValue;this.squareButton?this.drawSquare(t,e):this.drawEllipse(t,e),this.width>this.height?this.drawHorizontal(t,e):this.drawVertical(t,e),this.showBooleanLabel&&t.fillText({x:this.x+this.width/2,y:this.y+this.height/2,font:this.font,color:this.foregroundColor,align:"center",baseline:"middle",text:e?this.onLabel:this.offLabel})}drawSquare(t,e){t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:m.DARK_GRAY}),t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let i=2*this.scale,r=e?m.DARK_GRAY:m.WHITE,s=e?m.WHITE:m.DARK_GRAY;this.effect3d&&(t.fillPath({color:r,path:new S(this.x,this.y).lineTo(this.x,this.y+this.height).lineTo(this.x+i,this.y+this.height-i).lineTo(this.x+i,this.y+i).lineTo(this.x+this.width-i,this.y+i).lineTo(this.x+this.width,this.y).closePath()}),t.fillPath({color:s,path:new S(this.x,this.y+this.height).lineTo(this.x+this.width,this.y+this.height).lineTo(this.x+this.width,this.y).lineTo(this.x+this.width-i,this.y+i).lineTo(this.x+this.width-i,this.y+this.height-i).lineTo(this.x+i,this.y+this.height-i).closePath()}));let o=this.backgroundColor;this.hovered&&(o=this.backgroundColor.mixWith(m.WHITE,.5)),t.fillRect({x:this.x+i,y:this.y+i,width:this.width-i-i,height:this.height-i-i,color:o})}drawEllipse(t,e){let{scale:i}=this;if(this.effect3d){let h=this.width/2,l=this.height/2,d=Math.sqrt(h*h+l*l),n=this.x+h+(l-h-d)/2-1*i,p=this.y+l-(l-h+d)/2-1*i,g=this.x+h+(l-h+d)/2+5*i,v=this.y+l-(l-h-d)/2+5*i,w=t.createLinearGradient(n,p,g,v);e?(w.addColorStop(0,m.DARK_GRAY.toString()),w.addColorStop(1,m.WHITE.toString())):(w.addColorStop(0,m.WHITE.toString()),w.addColorStop(1,m.DARK_GRAY.toString())),t.ctx.fillStyle=w}else e?t.ctx.fillStyle=m.WHITE.toString():t.ctx.fillStyle=m.DARK_GRAY.toString();let r=this.x+this.width/2,s=this.y+this.height/2,o=this.width/2,a=this.height/2;t.ctx.beginPath(),t.ctx.ellipse(r,s,o,a,0,0,2*Math.PI),t.ctx.fill(),t.addHitRegion(this.areaRegion).addEllipse(r,s,o,a,0,0,2*Math.PI),this.hovered?t.ctx.fillStyle=this.backgroundColor.mixWith(m.WHITE,.5).toString():t.ctx.fillStyle=this.backgroundColor.toString(),t.ctx.beginPath(),t.ctx.ellipse(r,s,o-i*2,a-i*2,0,0,2*Math.PI),t.ctx.fill()}drawHorizontal(t,e){let{scale:i}=this;if(this.showLed){let r;this.squareButton?(r=Math.floor(.3*(this.width+this.height)/2),r>Math.min(this.width,this.height)&&(r=Math.min(this.width,this.height)-2*i)):(r=Math.floor(.25*(this.width+this.height)/2),r>Math.min(this.width,this.height)&&(r=Math.min(this.width,this.height)-8*i));let s={x:Math.floor(this.x+this.width*.79999-r/2),y:Math.floor(this.y+this.height/2-r/2),width:r,height:r},o=s.x+s.width/2,a=s.y+s.height/2,h=s.width/2,l=s.height/2,d=e?this.onColor:this.offColor;if(t.fillEllipse({cx:o,cy:a,rx:h,ry:l,color:d}),this.effect3d){let n=t.createLinearGradient(s.x,s.y,s.x+s.width,s.y+s.height);n.addColorStop(0,"white"),n.addColorStop(1,d.withAlpha(0).toString()),t.ctx.beginPath(),t.ctx.ellipse(o,a,h,l,0,0,2*Math.PI),t.ctx.fillStyle=n,t.ctx.fill()}}}drawVertical(t,e){let{scale:i}=this;if(this.showLed){let r;this.squareButton?(r=Math.floor(.3*(this.width+this.height)/2),r>Math.min(this.width,this.height)&&(r=Math.min(this.width,this.height)-2*i)):(r=Math.floor(.25*(this.width+this.height)/2),r>Math.min(this.width,this.height)&&(r=Math.min(this.width,this.height)-8*i));let s={x:Math.floor(this.x+this.width/2-r/2),y:Math.floor(this.y+(1-.79999)*this.height-r/2),width:r,height:r},o=e?this.onColor:this.offColor,a=s.x+s.width/2,h=s.y+s.height/2,l=s.width/2,d=s.height/2;if(t.fillEllipse({cx:a,cy:h,rx:l,ry:d,color:o}),this.effect3d){let n=t.createLinearGradient(s.x,s.y,s.x+s.width,s.y+s.height);n.addColorStop(0,m.WHITE.toString()),n.addColorStop(1,o.withAlpha(0).toString()),t.ctx.beginPath(),t.ctx.ellipse(a,h,l,d,0,0,2*Math.PI),t.ctx.fillStyle=n,t.ctx.fill()}}}get bit(){return this.properties.getValue(Br)}get dataType(){return this.properties.getValue(Ir)}get toggleButton(){return this.properties.getValue(jr)}get pushActionIndex(){return this.properties.getValue(Ur)}get releaseActionIndex(){return this.properties.getValue(qr)}get squareButton(){return this.properties.getValue(Kr)}get showLed(){return this.properties.getValue(Yr)}get showBooleanLabel(){return this.properties.getValue(Xr)}get effect3d(){return this.properties.getValue(Hr)}get onColor(){return this.properties.getValue(Or)}get onLabel(){return this.properties.getValue(Gr)}get onState(){return this.properties.getValue(zr)}get offColor(){return this.properties.getValue(Nr)}get offLabel(){return this.properties.getValue(Fr)}get offState(){return this.properties.getValue($r)}get font(){return this.properties.getValue(Dr).scale(this.scale)}},Zr="bit",Jr="data_type",Qr="effect_3d",ts="off_color",es="off_label",is="off_state",rs="on_color",ss="on_label",os="on_state",as="push_action_index",hs="released_action_index",ls="toggle_button",sc=class extends G{manualToggleState=!1;shaftRegion;constructor(t,e){super(t,e),this.properties.add(new b(Zr)),this.properties.add(new b(Jr)),this.properties.add(new y(Qr)),this.properties.add(new R(rs)),this.properties.add(new _(ss)),this.properties.add(new _(os)),this.properties.add(new R(ts)),this.properties.add(new _(es)),this.properties.add(new _(is)),this.properties.add(new b(as)),this.properties.add(new b(hs)),this.properties.add(new y(ls))}init(){this.shaftRegion={id:`${this.wuid}-shaft`,mouseDown:()=>{this.toggleButton?this.booleanValue?this.toggleOff():this.toggleOn():this.toggleOn(),this.requestRepaint()},mouseUp:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},mouseOut:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.onState);this.executeActionByIndex(this.pushActionIndex)}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.offState);this.releaseActionIndex!==void 0&&this.executeActionByIndex(this.releaseActionIndex)}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.dataType===0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.dataType===1?this.pv.toString()===this.onState:!1:this.manualToggleState}draw(t){let e=this.booleanValue;this.width>this.height?this.drawHorizontal(t,e):this.drawVertical(t,e)}drawHorizontal(t,e){let i=this.width,r=this.height;r>i/2?r=Math.floor(this.width/2):i=Math.floor(2*this.height);let s={x:Math.floor(63/218*i),y:0,width:r/2,height:r/2};this.drawPedestal(t,s,e);let o=Math.floor(35/218*i),a=Math.floor(45/105*r),h=Math.floor(43/218*i),l=Math.floor(35/105*r),d=Math.floor(1/7*s.width);if(e){let n={x:2*s.x+s.width-o,y:s.height/2-a/2,width:o,height:a},p={x:s.x+s.width/2-h/2+d,y:s.y+s.height/2-l/2,width:h,height:l};this.drawHorizontalBar(t,p,n,!0)}else{let n={x:0,y:s.height/2-a/2,width:o,height:a},p={x:s.x+s.width/2-h/2-d,y:s.y+s.height/2-l/2,width:h,height:l};this.drawHorizontalBar(t,p,n,!1)}}drawVertical(t,e){let i=this.width,r=this.height;i>r/2?i=Math.floor(this.height/2):r=Math.floor(2*this.width);let s={x:0,y:Math.floor(63/218*r),width:i/2,height:i/2};this.drawPedestal(t,s,e);let o=Math.floor(45/105*i),a=Math.floor(35/218*r),h=Math.floor(35/105*i),l=Math.floor(43/218*r);if(e){let d={x:s.width/2-o/2,y:0,width:o,height:a},n={x:s.x+s.width/2-h/2,y:s.y+s.height/2-l/2,width:h,height:l};n.y-=Math.floor(1/7*s.height),this.drawVerticalBar(t,n,d,!0)}else{let d=s.y+s.height/2+l/2+2*this.scale,n={x:s.width/2-o/2,y:s.y+s.height/2-l/2+d-a,width:o,height:a},p={x:s.x+s.width/2-h/2,y:s.y+s.height/2-l/2,width:h,height:l};p.y+=Math.floor(1/7*s.height),this.drawVerticalBar(t,p,n,!1)}}drawPedestal(t,e,i){let r=this.x+e.x+e.width/2,s=this.y+e.y+e.height/2,o=e.width/2,a=e.height/2;if(t.ctx.fillStyle=this.effect3d?m.WHITE.toString():m.GRAY.toString(),t.ctx.beginPath(),t.ctx.ellipse(r,s,o,a,0,0,2*Math.PI),t.ctx.fill(),this.effect3d){let h=t.createLinearGradient(this.x+e.x,this.y+e.y,this.x+e.x+e.width,this.y+e.y+e.height);i?(h.addColorStop(0,`rgba(255,255,255,${10/255})`),h.addColorStop(1,`rgba(0,0,0,${100/255})`)):(h.addColorStop(0,"rgba(0,0,0,0)"),h.addColorStop(1,`rgba(0,0,0,${150/255})`)),t.ctx.fillStyle=h,t.ctx.fill()}}drawHorizontalBar(t,e,i,r){let s=(r?0:10)/255,o=(r?150:220)/255,a=t.createLinearGradient(this.x+i.x,this.y+i.y,this.x+i.x,this.y+i.y+i.height);a.addColorStop(0,`rgba(0,0,0,${s})`),a.addColorStop(1,`rgba(0,0,0,${o})`);let h=t.addHitRegion(this.shaftRegion),l=this.x+e.x+e.width/2,d=this.y+e.y+e.height/2,n=e.width/2,p=e.height/2;t.ctx.beginPath(),t.ctx.ellipse(l,d,n,p,0,0,2*Math.PI),h.addEllipse(l,d,n,p,0,0,2*Math.PI),t.ctx.fillStyle=r?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=a,t.ctx.fill());let g=[Math.round(this.x+i.x+i.width/2),Math.round(this.y+i.y),Math.round(this.x+i.x+i.width/2),Math.round(this.y+i.y+i.height),Math.round(this.x+e.x+e.width/2),Math.round(this.y+e.y+e.height),Math.round(this.x+e.x+e.width/2),Math.round(this.y+e.y)];if(t.ctx.beginPath(),t.ctx.moveTo(g[0],g[1]),t.ctx.lineTo(g[2],g[3]),t.ctx.lineTo(g[4],g[5]),t.ctx.lineTo(g[6],g[7]),t.ctx.closePath(),h.addPath(new S(g[0],g[1]).lineTo(g[2],g[3]).lineTo(g[4],g[5]).lineTo(g[6],g[7]).closePath()),t.ctx.fillStyle=r?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=a,t.ctx.fill()),l=this.x+i.x+i.width/2,d=this.y+i.y+i.height/2,n=i.width/2,p=i.height/2,t.ctx.beginPath(),t.ctx.ellipse(l,d,n,p,0,0,2*Math.PI),h.addEllipse(l,d,n,p,0,0,2*Math.PI),t.ctx.fillStyle=r?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d){let{scale:v}=this,w=Math.sqrt(n*n+p*p),T=p-n,B=this.x+i.x+n+(T-w)/2-1*v,M=this.x+i.y+p-(T+w)/2-1*v,k=this.x+i.x+n+(T+w)/2+5*v,W=this.x+i.y+p-(T-w)/2+5*v,D=t.createLinearGradient(B,M,k,W);D.addColorStop(0,`rgba(0,0,0,${s})`),D.addColorStop(1,`rgba(0,0,0,${o})`),t.ctx.fillStyle=D,t.ctx.fill()}}drawVerticalBar(t,e,i,r){let s=t.createLinearGradient(this.x+i.x,this.y+i.y,this.x+i.x+i.width,this.y+i.y);s.addColorStop(0,`rgba(0,0,0,${10/255})`),s.addColorStop(1,`rgba(0,0,0,${r?210/255:160/255})`);let o=t.addHitRegion(this.shaftRegion),a=this.x+e.x+e.width/2,h=this.y+e.y+e.height/2;t.ctx.beginPath(),t.ctx.ellipse(a,h,e.width/2,e.height/2,0,0,2*Math.PI),o.addEllipse(a,h,e.width/2,e.height/2,0,0,2*Math.PI),t.ctx.fillStyle=r?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=s,t.ctx.fill());let l=[Math.round(this.x+i.x),Math.round(this.y+i.y+i.height/2),Math.round(this.x+i.x+i.width),Math.round(this.y+i.y+i.height/2),Math.round(this.x+e.x+e.width),Math.round(this.y+e.y+e.height/2),Math.round(this.x+e.x),Math.round(this.y+e.y+e.height/2)];t.ctx.beginPath(),t.ctx.moveTo(l[0],l[1]),t.ctx.lineTo(l[2],l[3]),t.ctx.lineTo(l[4],l[5]),t.ctx.lineTo(l[6],l[7]),t.ctx.closePath(),o.addPath(new S(l[0],l[1]).lineTo(l[2],l[3]).lineTo(l[4],l[5]).lineTo(l[6],l[7]).closePath()),t.ctx.fillStyle=r?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=s,t.ctx.fill()),a=this.x+i.x+i.width/2,h=this.y+i.y+i.height/2;let d=i.width/2,n=i.height/2;if(t.ctx.beginPath(),t.ctx.ellipse(a,h,d,n,0,0,2*Math.PI),o.addEllipse(a,h,d,n,0,0,2*Math.PI),t.ctx.fillStyle=r?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d){let p=t.createLinearGradient(this.x+i.x,this.y+i.y,this.x+i.width,this.y+i.height);p.addColorStop(0,`rgba(0,0,0,${(r?5:10)/255})`),p.addColorStop(1,`rgba(0,0,0,${(r?180:160)/255})`),t.ctx.fillStyle=p,t.ctx.fill()}}get bit(){return this.properties.getValue(Zr)}get dataType(){return this.properties.getValue(Jr)}get toggleButton(){return this.properties.getValue(ls)}get pushActionIndex(){return this.properties.getValue(as)}get releaseActionIndex(){return this.properties.getValue(hs)}get effect3d(){return this.properties.getValue(Qr)}get onColor(){return this.properties.getValue(rs)}get onLabel(){return this.properties.getValue(ss)}get onState(){return this.properties.getValue(os)}get offColor(){return this.properties.getValue(ts)}get offLabel(){return this.properties.getValue(es)}get offState(){return this.properties.getValue(is)}},ns="bit",ds="enabled",us="font",ps="label",cs="selected_color",oc=16,ac=new m(130,130,130),hc=new m(94,151,230),lc=4,nc=class extends G{hovered=!1;manualToggleState=!1;areaRegion;constructor(t,e){super(t,e),this.properties.add(new b(ns)),this.properties.add(new y(ds)),this.properties.add(new O(us)),this.properties.add(new _(ps)),this.properties.add(new R(cs,new m(64,64,64)))}init(){this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.booleanValue?this.toggleOff():this.toggleOn(),this.requestRepaint()},mouseEnter:()=>{this.hovered=!0,this.requestRepaint()},mouseOut:()=>{this.hovered=!1,this.requestRepaint()},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.manualToggleState}draw(t){t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let e=this.booleanValue,{boxSize:i,gap:r,scale:s}=this,o=this.backgroundColor;this.hovered&&(o=o.mixWith(hc,.7));let a={x:this.x,y:this.y+this.height/2-i/2,width:i,height:i},h=t.createLinearGradient(a.x,a.y+1*s,a.x,a.y+a.height);h.addColorStop(0,m.WHITE.toString()),h.addColorStop(1,o.toString()),t.fillRect(A(C({},a),{rx:2*s,ry:2*s,gradient:h})),t.strokeRect({x:a.x+.5*s,y:a.y+.5*s,width:a.width-1*s,height:a.height-1*s,rx:2*s,ry:2*s,color:ac}),e&&t.strokePath({lineWidth:3*s,color:this.selectedColor,path:new S(a.x+3*s,a.y+Math.floor(i*.45)).lineTo(a.x+Math.floor(i*.45),a.y+i*3/4-1*s).lineTo(a.x+i-2*s,a.y+3*s)}),this.enabled?t.fillText({x:a.x+a.width+r,y:a.y+a.height/2,align:"left",baseline:"middle",color:this.foregroundColor,font:this.font,text:this.label}):(t.fillText({x:a.x+a.width+r+1*s,y:a.y+a.height/2+1*s,align:"left",baseline:"middle",color:m.BUTTON_LIGHTEST,font:this.font,text:this.label}),t.fillText({x:a.x+a.width+r,y:a.y+a.height/2,align:"left",baseline:"middle",color:m.BUTTON_DARKER,font:this.font,text:this.label}))}get boxSize(){return this.scale*oc}get gap(){return this.scale*lc}get bit(){return this.properties.getValue(ns)}get enabled(){return this.properties.getValue(ds)}get selectedColor(){return this.properties.getValue(cs)}get font(){return this.properties.getValue(us).scale(this.scale)}get label(){return this.properties.getValue(ps)}},gs="enabled",ms="font",fs="horizontal",xs="items",ws="items_from_pv",ys="selected_color",dc=class extends G{pushedItem;itemRegions=[];constructor(t,e){super(t,e),this.properties.add(new y(gs)),this.properties.add(new O(ms)),this.properties.add(new y(fs)),this.properties.add(new de(xs,[])),this.properties.add(new y(ws)),this.properties.add(new R(ys))}init(){for(let t=0;t<this.items.length;t++)this.itemRegions.push({id:`${this.wuid}-item-${t}`,cursor:"pointer",mouseDown:()=>{this.pushedItem=t,this.requestRepaint()},mouseOut:()=>{this.pushedItem=void 0,this.requestRepaint()},mouseUp:()=>{this.pushedItem=void 0,this.requestRepaint()},click:()=>{this.writeValue(this.items[t]),this.requestRepaint()},tooltip:()=>this.tooltip})}draw(t){this.horizontal?this.drawHorizontal(t):this.drawVertical(t)}drawHorizontal(t){let e=this.area.width/this.items.length,i=this.area.x;for(let r=0;r<this.items.length;r++){let s={x:i,y:this.area.y,width:e,height:this.area.height};i+=e,this.drawButton(t,s,r)}}drawVertical(t){let e=this.area.height/this.items.length,i=this.area.y;for(let r=0;r<this.items.length;r++){let s={x:Math.round(this.area.x),y:Math.round(i),width:Math.round(this.area.width),height:Math.round(e)};i+=e,this.drawButton(t,s,r)}}drawButton(t,e,i){let r=this.pv?.value===this.items[i],s=r||i===this.pushedItem;t.fillRect(A(C({},e),{color:r?this.selectedColor:this.backgroundColor})),t.addHitRegion(this.itemRegions[i]).addRect(e.x,e.y,e.width,e.height);let o=1*this.scale,a=e.y+o/2,h=e.x+o/2,l=e.y+e.height-o+o/2,d=e.x+e.width-o+o/2;t.strokePath({lineWidth:o,color:s?m.BUTTON_LIGHTEST:m.BLACK,path:new S(d,l).lineTo(d,a).moveTo(d,l).lineTo(h,l)}),t.strokePath({lineWidth:o,color:s?this.backgroundColor:m.BUTTON_DARKER,path:new S(d-o,l-o).lineTo(d-o,a+o).moveTo(d-o,l-o).lineTo(h+o,l-o)}),t.strokePath({lineWidth:o,color:s?m.BLACK:m.BUTTON_LIGHTEST,path:new S(h,a).lineTo(d-o,a).moveTo(h,a).lineTo(h,l-o)}),t.strokePath({lineWidth:o,color:s?m.BUTTON_DARKER:this.backgroundColor,path:new S(h+o,a+o).lineTo(d-o-o,a+o).moveTo(h+o,a+o).lineTo(h+o,l-o-o)}),t.fillText({x:e.x+e.width/2,y:e.y+e.height/2,text:this.items[i],align:"center",baseline:"middle",color:this.foregroundColor,font:this.font})}writeValue(t){this.pv&&this.pv.writable&&this.display.pvEngine.setValue(new Date,this.pv.name,t)}get enabled(){return this.properties.getValue(gs)}get font(){return this.properties.getValue(ms).scale(this.scale)}get horizontal(){return this.properties.getValue(fs)}get items(){return this.properties.getValue(xs)}get itemsFromPV(){return this.properties.getValue(ws)}get selectedColor(){return this.properties.getValue(ys)}},vs="enabled",bs="font",Ts="items",Ss="items_from_pv",uc=8,pc=new m(0,0,0,.1),cc=class extends G{areaRegion;selectEl;constructor(t,e){super(t,e),this.properties.add(new y(vs)),this.properties.add(new O(bs)),this.properties.add(new de(Ts,[])),this.properties.add(new y(Ss))}init(){this.areaRegion={id:`${this.wuid}-area`,tooltip:()=>this.tooltip},this.selectEl=document.createElement("select"),this.selectEl.style.display="block",this.selectEl.style.position="absolute",this.selectEl.style.boxSizing="border-box",this.selectEl.style.opacity="0",this.selectEl.addEventListener("change",()=>{this.writeValue(this.selectEl?.value??""),this.requestRepaint()});let t=document.createElement("option");t.disabled=!0,t.value="",t.defaultSelected=!0,t.text=" -- select an option -- ",this.selectEl.add(t);for(let e=0;e<this.items.length;e++){let i=document.createElement("option");i.value=this.items[e],i.text=this.items[e],this.selectEl.add(i)}this.display.rootPanel.appendChild(this.selectEl)}draw(t){let e=this.display.measureAbsoluteArea(this);this.selectEl.style.display="block",this.selectEl.style.left=`${e.x}px`,this.selectEl.style.top=`${e.y}px`,this.selectEl.style.width=`${e.width}px`,this.selectEl.style.height=`${e.height}px`,e=U(this.bounds,2*this.scale),t.fillRect(A(C({},e),{color:this.backgroundColor})),t.strokeRect(A(C({},e),{color:pc,crispen:!0})),t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height);let i=this.pv?.value??this.value;if(i)for(let a of this.items){let h=a===i;if(!h)try{h=parseFloat(a)===i}catch{}h&&t.fillText({x:5*this.scale+e.x,y:e.y+e.height/2,align:"left",baseline:"middle",color:this.foregroundColor,font:this.font,text:i})}let{selectorWidth:r}=this,s=Math.min(e.height,r/2),o={x:e.x+e.width-r-5*this.scale+r/2,y:e.y+(e.height-s)/2+s};t.fillPath({color:this.foregroundColor,path:new S(o.x,o.y).lineTo(o.x-s,o.y-s).lineTo(o.x+s,o.y-s).closePath()})}writeValue(t){this.pv?this.pv.writable&&this.display.pvEngine.setValue(new Date,this.pv.name,t):this.value=t}hide(){this.selectEl&&(this.selectEl.style.display="none")}destroy(){this.selectEl&&(this.display.rootPanel.removeChild(this.selectEl),this.selectEl=void 0)}get selectorWidth(){return this.scale*uc}get enabled(){return this.properties.getValue(vs)}get font(){return this.properties.getValue(bs).scale(this.scale)}get items(){return this.properties.getValue(Ts)}get itemsFromPV(){return this.properties.getValue(Ss)}},Vs="bit",Cs="data_type",As="effect_3d",_s="font",Ls="off_image",Ps="off_label",ks="off_state",Ms="on_image",Rs="on_label",Es="on_state",Ws="push_action_index",Bs="released_action_index",Is="show_boolean_label",Hs="toggle_button",gc=class extends G{onImageElement;onImageLoaded=!1;offImageElement;offImageLoaded=!1;manualToggleState=!1;areaRegion;constructor(t,e){super(t,e),this.properties.add(new b(Vs)),this.properties.add(new b(Cs)),this.properties.add(new y(As)),this.properties.add(new _(Ms)),this.properties.add(new _(Rs)),this.properties.add(new _(Es)),this.properties.add(new _(Ls)),this.properties.add(new _(Ps)),this.properties.add(new _(ks)),this.properties.add(new O(_s)),this.properties.add(new y(Hs)),this.properties.add(new b(Ws)),this.properties.add(new b(Bs)),this.properties.add(new y(Is))}init(){this.onImageElement=new Image,this.onImageElement.onload=()=>{this.onImageLoaded=!0,this.requestRepaint()},this.offImageElement=new Image,this.offImageElement.onload=()=>{this.offImageLoaded=!0,this.requestRepaint()},this.onImage&&(this.onImageElement.src=this.resolvePath(this.onImage)),this.offImage&&(this.offImageElement.src=this.resolvePath(this.offImage)),this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.toggleButton?this.booleanValue?this.toggleOff():this.toggleOn():this.toggleOn(),this.requestRepaint()},mouseUp:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},mouseOut:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.onState);this.executeActionByIndex(this.pushActionIndex)}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.offState);this.releaseActionIndex!==void 0&&this.executeActionByIndex(this.releaseActionIndex)}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.dataType===0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.dataType===1?this.pv.toString()===this.onState:!1:this.manualToggleState}draw(t){let e=this.bounds;this.borderAlarmSensitive&&(e=U(e,2*this.scale,2*this.scale));let i=this.booleanValue;i?this.onImageLoaded&&t.ctx.drawImage(this.onImageElement,e.x,e.y,e.width,e.height):this.offImageLoaded&&t.ctx.drawImage(this.offImageElement,e.x,e.y,e.width,e.height),t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height),this.showBooleanLabel&&t.fillText({x:this.x+this.width/2,y:this.y+this.height/2,font:this.font,color:this.foregroundColor,align:"center",baseline:"middle",text:i?this.onLabel:this.offLabel})}get bit(){return this.properties.getValue(Vs)}get dataType(){return this.properties.getValue(Cs)}get toggleButton(){return this.properties.getValue(Hs)}get pushActionIndex(){return this.properties.getValue(Ws)}get releaseActionIndex(){return this.properties.getValue(Bs)}get showBooleanLabel(){return this.properties.getValue(Is)}get effect3d(){return this.properties.getValue(As)}get onImage(){return this.properties.getValue(Ms)}get onLabel(){return this.properties.getValue(Rs)}get onState(){return this.properties.getValue(Es)}get offImage(){return this.properties.getValue(Ls)}get offLabel(){return this.properties.getValue(Ps)}get offState(){return this.properties.getValue(ks)}get font(){return this.properties.getValue(_s).scale(this.scale)}},Ds="font",Ns="label",mc=class extends G{areaRegion;selectEl;constructor(t,e){super(t,e),this.properties.add(new O(Ds)),this.properties.add(new _(Ns))}init(){this.areaRegion={id:`${this.wuid}-area`,tooltip:()=>this.tooltip,cursor:"pointer"},this.selectEl=document.createElement("select"),this.selectEl.style.display="block",this.selectEl.style.position="absolute",this.selectEl.style.boxSizing="border-box",this.selectEl.style.opacity="0",this.selectEl.addEventListener("change",i=>{let r=this.selectEl?.value;if(r){this.selectEl.selectedIndex=0;let s=Number(r.substring(7));this.executeActionByIndex(s)}});let t=document.createElement("option");t.disabled=!0,t.value="",t.defaultSelected=!0,t.text=" -- select an option -- ",this.selectEl.add(t);let e=this.actions.actions;for(let i=0;i<e.length;i++){let r=document.createElement("option");r.value=`action-${i}`,r.text=e[i]?.toString()??"",this.selectEl.add(r)}this.display.rootPanel.appendChild(this.selectEl)}draw(t){let e=this.display.measureAbsoluteArea(this);this.selectEl.style.display="block",this.selectEl.style.left=`${e.x}px`,this.selectEl.style.top=`${e.y}px`,this.selectEl.style.width=`${e.width}px`,this.selectEl.style.height=`${e.height}px`;let i=t.ctx;t.fillRect(A(C({},this.area),{color:this.backgroundColor})),t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let r=this.label.split(`
`);i.fillStyle=this.foregroundColor.toString(),i.font=this.font.getFontString(),i.textBaseline="middle",i.textAlign="center";let s=this.x+this.width/2,o=this.y+this.height/2;i.fillText(r[0],s,o)}hide(){this.selectEl&&(this.selectEl.style.display="none")}destroy(){this.selectEl&&(this.display.rootPanel.removeChild(this.selectEl),this.selectEl=void 0)}get font(){return this.properties.getValue(Ds).scale(this.scale)}get backgroundColor(){let t=this.properties.getProperty("background_color");return t&&t.value!==m.TRANSPARENT?t.value:m.BUTTON}get label(){return this.properties.getValue(Ns)}},fc=class extends zd{},Fs="enabled",$s="font",Os="horizontal",Gs="items",zs="items_from_pv",Us="selected_color",xc=7,wc=2,yc=4,vc=new m(120,120,120),bc=new m(94,151,230),Tc=class extends G{hoveredItem;itemRegions=[];constructor(t,e){super(t,e),this.properties.add(new y(Fs)),this.properties.add(new O($s)),this.properties.add(new y(Os)),this.properties.add(new de(Gs,[])),this.properties.add(new y(zs)),this.properties.add(new R(Us))}init(){for(let t=0;t<this.items.length;t++)this.itemRegions.push({id:`${this.wuid}-item-${t}`,cursor:"pointer",click:()=>{this.writeValue(this.items[t]),this.requestRepaint()},mouseEnter:()=>{this.hoveredItem=t,this.requestRepaint()},mouseOut:()=>{this.hoveredItem=void 0,this.requestRepaint()},tooltip:()=>this.tooltip})}draw(t){this.horizontal?this.drawHorizontal(t):this.drawVertical(t)}drawHorizontal(t){let e=this.area.width/this.items.length,i=this.area.x;for(let r=0;r<this.items.length;r++){let s={x:i,y:this.area.y,width:e,height:this.area.height};i+=e,this.drawRadio(t,s,r)}}drawVertical(t){let e=this.area.height/this.items.length,i=this.area.y;for(let r=0;r<this.items.length;r++){let s={x:this.area.x,y:i,width:this.area.width,height:e};i+=e,this.drawRadio(t,s,r)}}drawRadio(t,e,i){let{radioRadius:r,dotRadius:s,gap:o}=this,a=this.backgroundColor;i===this.hoveredItem&&(a=a.mixWith(bc,.7));let h=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);h.addColorStop(0,m.WHITE.toString()),h.addColorStop(1,a.toString()),t.fillEllipse({cx:e.x+r,cy:e.y+e.height/2,rx:r,ry:r,gradient:h});let l=1*this.scale;t.strokeEllipse({cx:e.x+r,cy:e.y+e.height/2,rx:r,ry:r,color:vc,lineWidth:l}),this.pv?.value===this.items[i]&&t.fillEllipse({cx:e.x+r,cy:e.y+e.height/2,rx:s+l/2,ry:s+l/2,color:this.selectedColor}),t.addHitRegion(this.itemRegions[i]).addRect(e.x,e.y,e.width,e.height),t.fillText({x:e.x+r+r+o,y:e.y+e.height/2,text:this.items[i],align:"left",baseline:"middle",color:this.foregroundColor,font:this.font})}writeValue(t){this.pv&&this.pv.writable&&this.display.pvEngine.setValue(new Date,this.pv.name,t)}get radioRadius(){return this.scale*xc}get dotRadius(){return this.scale*wc}get gap(){return this.scale*yc}get enabled(){return this.properties.getValue(Fs)}get font(){return this.properties.getValue($s).scale(this.scale)}get horizontal(){return this.properties.getValue(Os)}get items(){return this.properties.getValue(Gs)}get itemsFromPV(){return this.properties.getValue(zs)}get selectedColor(){return this.properties.getValue(Us)}},qs="enabled",Ys="font",Xs="maximum",Ks="minimum",js="horizontal",Zs="step_increment",Js="page_increment",Qs="bar_length",to="show_value_tip",eo=new m(243,243,243),Ht=new m(232,232,231),ie=150,Sc=class extends G{decreaseRegion;decreasePressed=!1;increaseRegion;increasePressed=!1;pageDecreaseRegion;pageDecreasePressed=!1;pageIncreaseRegion;pageIncreasePressed=!1;thumbRegion;grabStartValue;dragRange;actionTimeout;constructor(t,e){super(t,e),this.properties.add(new y(qs)),this.properties.add(new y(js)),this.properties.add(new y(to)),this.properties.add(new O(Ys)),this.properties.add(new H(Xs)),this.properties.add(new H(Ks)),this.properties.add(new H(Zs)),this.properties.add(new H(Js)),this.properties.add(new H(Qs))}init(){this.decreaseRegion={id:`${this.wuid}-decrease`,mouseDown:()=>{this.decreasePressed=!0,this.stepDecreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.decreasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.decreasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip},this.increaseRegion={id:`${this.wuid}-increase`,mouseDown:()=>{this.increasePressed=!0,this.stepIncreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.increasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.increasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip},this.thumbRegion={id:`${this.wuid}-thumb`,mouseDown:()=>{this.grabStartValue=this.getCoercedValue()},grab:t=>{let e=this.horizontal?t.dx:t.dy,i=(this.maximum-this.minimum)*e/this.dragRange;this.setCoercedValue(this.grabStartValue+i),this.requestRepaint()},tooltip:()=>this.tooltip},this.pageDecreaseRegion={id:`${this.wuid}-page-decrease`,mouseDown:()=>{this.pageDecreasePressed=!0,this.pageDecreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.pageDecreasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.pageDecreasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip},this.pageIncreaseRegion={id:`${this.wuid}-page-increase`,mouseDown:()=>{this.pageIncreasePressed=!0,this.pageIncreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.pageIncreasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.pageIncreasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip}}draw(t){this.horizontal?this.drawHorizontal(t):this.drawVertical(t)}drawHorizontal(t){let{scale:e}=this,i=U(this.bounds,2*e);t.fillRect(A(C({},i),{color:eo}));let r=Math.min(i.height,i.width/2);this.drawLeftButton(t,{x:i.x,y:i.y,width:r,height:i.height}),this.drawRightButton(t,{x:i.x+i.width-r,y:i.y,width:r,height:i.height});let s=this.barLength,o=this.maximum+s,a=this.minimum,h=o-a,l=h-s,d=i.width-r-r,n=Math.floor(Math.max(6*e,d*s/h));this.dragRange=d-n;let p=this.getCoercedValue(),g=Math.floor((d-n)*(p-a)/l),v=d-g-n,w={x:i.x+r+g,y:i.y,width:n,height:i.height};t.fillRect(A(C({},w),{color:Ht})),this.drawRaisedButtonBorder(t,w),t.addHitRegion(this.thumbRegion).addRect(w.x,w.y,w.width,w.height);let T={x:i.x+r,y:i.y,width:g,height:i.height};t.addHitRegion(this.pageDecreaseRegion).addRect(T.x,T.y,T.width,T.height),this.pageDecreasePressed&&t.fillRect(A(C({},T),{color:m.BLACK}));let B={x:i.x+r+g+n,y:i.y,width:v,height:i.height};t.addHitRegion(this.pageIncreaseRegion).addRect(B.x,B.y,B.width,B.height),this.pageIncreasePressed&&t.fillRect(A(C({},B),{color:m.BLACK}))}drawVertical(t){let{scale:e}=this,i=U(this.bounds,e);t.fillRect(A(C({},i),{color:eo}));let r=Math.min(i.width,i.height/2);this.drawUpButton(t,{x:i.x,y:i.y,width:i.width,height:r}),this.drawDownButton(t,{x:i.x,y:i.y+i.height-r,width:i.width,height:r});let s=this.barLength,o=this.maximum+s,a=this.minimum,h=o-a,l=h-s,d=i.height-r-r,n=Math.floor(Math.max(6*e,d*s/h));this.dragRange=d-n;let p=this.getCoercedValue(),g=Math.floor((d-n)*(p-a)/l),v=d-g-n,w={x:i.x,y:i.y+r+g,width:i.width,height:n};t.fillRect(A(C({},w),{color:Ht})),this.drawRaisedButtonBorder(t,w),t.addHitRegion(this.thumbRegion).addRect(w.x,w.y,w.width,w.height);let T={x:i.x,y:i.y+r,width:i.width,height:g};t.addHitRegion(this.pageDecreaseRegion).addRect(T.x,T.y,T.width,T.height),this.pageDecreasePressed&&t.fillRect(A(C({},T),{color:m.BLACK}));let B={x:i.x,y:i.y+r+g+n,width:i.width,height:v};t.addHitRegion(this.pageIncreaseRegion).addRect(B.x,B.y,B.width,B.height),this.pageIncreasePressed&&t.fillRect(A(C({},B),{color:m.BLACK}))}drawLeftButton(t,e){t.fillRect(A(C({},e),{color:Ht})),this.decreasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.decreaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),r=Math.min(i.height/2,i.width);i.x+=(i.width-r)/2,r=Math.max(r,1);let s={x:i.x,y:i.y+i.height/2};t.fillPath({color:m.BLACK,path:new S(s.x,s.y).lineTo(s.x+r,s.y-r).lineTo(s.x+r,s.y+r).closePath()})}drawRightButton(t,e){t.fillRect(A(C({},e),{color:Ht})),this.increasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.increaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),r=Math.min(i.height/2,i.width);i.x+=(i.width-r)/2,r=Math.max(r,1);let s={x:i.x+r,y:i.y+i.height/2};t.fillPath({color:m.BLACK,path:new S(s.x,s.y).lineTo(s.x-r,s.y-r).lineTo(s.x-r,s.y+r).closePath()})}drawUpButton(t,e){t.fillRect(A(C({},e),{color:Ht})),this.decreasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.decreaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),r=Math.min(i.height,i.width/2);i.y+=(i.height-r)/2,r=Math.max(r,1);let s={x:i.x+i.width/2,y:i.y};t.fillPath({color:m.BLACK,path:new S(s.x,s.y).lineTo(s.x-r,s.y+r).lineTo(s.x+r,s.y+r).closePath()})}drawDownButton(t,e){t.fillRect(A(C({},e),{color:Ht})),this.increasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.increaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),r=Math.min(i.height,i.width/2);i.y+=(i.height-r)/2,r=Math.max(r,1);let s={x:i.x+i.width/2,y:i.y+r};t.fillPath({color:m.BLACK,path:new S(s.x,s.y).lineTo(s.x-r,s.y-r).lineTo(s.x+r,s.y-r).closePath()})}drawRaisedButtonBorder(t,e){this.drawButtonBorder(t,e,m.BUTTON_DARKEST,m.BUTTON_DARKER,m.BUTTON,m.BUTTON_LIGHTEST)}drawPressedButtonBorder(t,e){this.drawButtonBorder(t,e,m.BUTTON_LIGHTEST,m.BUTTON_LIGHTEST,m.BUTTON_DARKEST,m.BUTTON_DARKER)}drawButtonBorder(t,e,i,r,s,o){let a=1*this.scale,h=e.y+a/2,l=e.x+a/2,d=e.y+e.height-a+a/2,n=e.x+e.width-a+a/2;t.strokePath({color:i,path:new S(n,d).lineTo(n,h).moveTo(n,d).lineTo(l,d)}),t.strokePath({color:r,path:new S(n-a,d-a).lineTo(n-a,h+a).moveTo(n-a,d-a).lineTo(l+a,d-a)}),t.strokePath({color:s,path:new S(l,h).lineTo(n-a,h).moveTo(l,h).lineTo(l,d-a)}),t.strokePath({color:o,path:new S(l+a,h+a).lineTo(n-a-a,h+a).moveTo(l+a,h+a).lineTo(l+a,d-a-a)})}stepIncreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.stepIncrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.stepIncreaseRepeatedly(),ie)}stepDecreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.stepDecrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.stepDecreaseRepeatedly(),ie)}stepIncrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t+this.stepIncrement)}stepDecrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t-this.stepIncrement)}pageIncreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.pageIncrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.pageIncreaseRepeatedly(),ie)}pageDecreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.pageDecrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.pageDecreaseRepeatedly(),ie)}pageIncrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t+this.pageIncrement)}pageDecrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t-this.pageIncrement)}setCoercedValue(t){this.pv&&this.pv.writable&&(t=t<this.minimum?this.minimum:t>this.maximum?this.maximum:t,this.display.pvEngine.setValue(new Date,this.pv.name,t))}getCoercedValue(){let t=this.pv?.value??(this.maximum-this.minimum)/2;return t<this.minimum?this.minimum:t>this.maximum?this.maximum:t}destroy(){window.clearTimeout(this.actionTimeout)}get enabled(){return this.properties.getValue(qs)}get horizontal(){return this.properties.getValue(js)}get showValueTip(){return this.properties.getValue(to)}get font(){return this.properties.getValue(Ys).scale(this.scale)}get minimum(){return this.properties.getValue(Ks)}get maximum(){return this.properties.getValue(Xs)}get stepIncrement(){return this.properties.getValue(Zs)}get pageIncrement(){return this.properties.getValue(Js)}get barLength(){return this.properties.getValue(Qs)}},io="confirm_message",ro="font",so="format_type",oo="horizontal_alignment",ao="multiline_input",ho="password_input",lo="precision",no="precision_from_pv",uo="show_units",Vc="text",po="vertical_alignment",Cc=class extends G{areaRegion;inputEl;editing=!1;constructor(t,e){super(t,e),this.properties.add(new _(io)),this.properties.add(new O(ro)),this.properties.add(new b(so)),this.properties.add(new b(oo)),this.properties.add(new y(ao)),this.properties.add(new y(ho,!1)),this.properties.add(new b(lo)),this.properties.add(new y(no)),this.properties.add(new y(uo,!0)),this.properties.add(new b(po,1))}init(){this.text&&(this.value=this.text),this.areaRegion={id:`${this.wuid}-area`,click:()=>{if(this.pv&&!this.pv.writable)return;this.editing=!0;let t=this.display.measureAbsoluteArea(this);if(t.x-=2*this.scale,t.y-=2*this.scale,t.width+=2*this.scale,t.height+=2*this.scale,this.inputEl.value=this.pv?.value??this.value??"",this.inputEl.style.display="block",this.inputEl.style.position="absolute",this.inputEl.style.boxSizing="border-box",this.inputEl.style.left=`${t.x}px`,this.inputEl.style.top=`${t.y}px`,this.inputEl.style.width=`${t.width}px`,this.inputEl.style.height=`${t.height}px`,this.inputEl.autocomplete="off",this.multilineInput){let e=this.inputEl;e.style.resize="none"}else{let e=this.inputEl;this.passwordInput&&(e.type="password")}this.inputEl.focus(),this.inputEl.select()},tooltip:()=>this.tooltip,cursor:"text"},this.inputEl=document.createElement(this.multilineInput?"textarea":"input"),this.inputEl.style.display="none",this.inputEl.addEventListener("keyup",t=>{if(t.key==="Enter"){if(!this.multilineInput||t.ctrlKey){let e=this.inputEl?.value||"";!this.confirmMessage||confirm(this.confirmMessage)?(this.value=e,this.pv&&this.display.pvEngine.setValue(new Date,this.pv.name,e),this.inputEl.style.display="none",this.editing=!1,this.requestRepaint()):this.cancelInput()}}else t.key==="Escape"&&this.cancelInput()}),this.inputEl.addEventListener("blur",t=>{this.cancelInput()}),this.display.rootPanel.appendChild(this.inputEl)}cancelInput(){this.inputEl.style.display="none",this.editing=!1,this.requestRepaint()}draw(t){if(this.editing)return;t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let e=t.ctx;this.backgroundAlarmSensitive&&this.alarm?t.fillRect(A(C({},this.area),{color:this.alarmSensitiveBackgroundColor})):this.transparent||t.fillRect(A(C({},this.area),{color:this.backgroundColor}));let i=document.createElement("canvas");i.width=this.area.width,i.height=this.area.height;let r=i.getContext("2d");r.fillStyle=this.alarmSensitiveForegroundColor.toString(),r.font=this.font.getFontString();let s=this.x;this.horizAlignment===0?r.textAlign="start":this.horizAlignment===1?(s+=this.width/2,r.textAlign="center"):this.horizAlignment===2&&(s+=this.width,r.textAlign="end");let o=this.y;this.vertAlignment===0?r.textBaseline="top":this.vertAlignment===1?(o=o+this.height/2,r.textBaseline="middle"):this.vertAlignment===2&&(o=o+this.height,r.textBaseline="bottom");let a=this.text;if(this.pv&&this.pv.value!==void 0){let h=this.precisionFromPV?this.pv.precision:this.precision;h===-1&&(h=this.pv.precision??-1),a=ae(this.pv.value,this.formatType,h),this.showUnits&&this.pv?.units&&(a+=" "+this.pv.units)}r.fillText(a,s-this.area.x,o-this.area.y),e.drawImage(i,this.area.x,this.area.y)}hide(){this.editing=!1,this.inputEl&&(this.inputEl.style.display="none")}destroy(){this.inputEl&&(this.display.rootPanel.removeChild(this.inputEl),this.inputEl=void 0)}get value(){return this.text}set value(t){this.properties.setValue(Vc,t),this.requestRepaint()}get confirmMessage(){return this.properties.getValue(io)}get font(){return this.properties.getValue(ro).scale(this.scale)}get formatType(){return this.properties.getValue(so)}get horizAlignment(){return this.properties.getValue(oo)}get multilineInput(){return this.properties.getValue(ao)}get passwordInput(){return this.properties.getValue(ho)}get precision(){return this.properties.getValue(lo)}get precisionFromPV(){return this.properties.getValue(no)}get showUnits(){return this.properties.getValue(uo)}get vertAlignment(){return this.properties.getValue(po)}},co="alpha",go="fill",mo="line_width",fo="line_style",xo="start_angle",wo="total_angle",Ac=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(co,255)),this.properties.add(new b(mo)),this.properties.add(new b(xo)),this.properties.add(new b(wo)),this.properties.add(new y(go)),this.properties.add(new b(fo))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawShape(t),t.ctx.globalAlpha=1}drawShape(t){let e=this.x+this.width/2,i=this.y+this.height/2,r=this.width/2,s=this.height/2,o=-$(this.startAngle),a=-$(this.totalAngle+this.startAngle);if(this.fill&&(t.ctx.fillStyle=this.alarmSensitiveBackgroundColor.toString(),t.ctx.beginPath(),t.ctx.moveTo(e,i),t.ctx.ellipse(e,i,r,s,0,o,a,!0),t.ctx.closePath(),t.ctx.fill()),this.lineWidth&&this.totalAngle!==0){let h,{scale:l}=this;this.lineStyle===0?h=[]:this.lineStyle===1?h=[6*l,2*l]:this.lineStyle===2?h=[2*l,2*l]:console.warn(`Unsupported arc line style ${this.lineStyle}`),t.strokeEllipse({cx:e,cy:i,rx:r,ry:s,startAngle:o,endAngle:a,lineWidth:this.lineWidth,anticlockwise:!0,color:this.alarmSensitiveForegroundColor,dash:h})}}get alpha(){return this.properties.getValue(co)}get lineWidth(){return this.scale*this.properties.getValue(mo)}get lineStyle(){return this.properties.getValue(fo)}get startAngle(){return this.properties.getValue(xo)}get totalAngle(){return this.properties.getValue(wo)}get fill(){return this.properties.getValue(go)}},yo="alpha",vo="bg_gradient_color",bo="fg_gradient_color",To="fill_level",So="gradient",Vo="horizontal_fill",Co="line_color",Ao="line_width",_o="line_style",_c=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(yo,255)),this.properties.add(new R(vo)),this.properties.add(new R(bo)),this.properties.add(new y(So)),this.properties.add(new b(Ao)),this.properties.add(new H(To)),this.properties.add(new y(Vo)),this.properties.add(new R(Co)),this.properties.add(new b(_o))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawBackground(t),this.fillLevel&&this.drawFill(t),t.ctx.globalAlpha=1}drawBackground(t){let e=this.x+this.width/2,i=this.y+this.height/2,r=this.width/2,s=this.height/2;if(!this.transparent){let o=this.alarmSensitiveBackgroundColor;if(this.gradient){let a=this.horizontalFill?this.x:this.x+this.width,h=this.horizontalFill?this.y+this.height:this.y,l=t.createLinearGradient(this.x,this.y,a,h);l.addColorStop(0,this.backgroundGradientStartColor.toString()),l.addColorStop(1,o.toString()),t.fillEllipse({cx:e,cy:i,rx:r,ry:s,gradient:l})}else t.fillEllipse({cx:e,cy:i,rx:r,ry:s,color:o})}this.lineWidth&&(this.lineStyle===0?t.strokeEllipse({cx:e,cy:i,rx:r,ry:s,color:this.lineColor,lineWidth:this.lineWidth}):this.lineStyle===1?t.strokeEllipse({cx:e,cy:i,rx:r,ry:s,color:this.lineColor,lineWidth:this.lineWidth,dash:[6*this.scale,2*this.scale]}):console.warn(`Unsupported ellipse line style ${this.lineStyle}`))}drawFill(t){let e=U(this,this.lineWidth);if(t.ctx.save(),this.horizontalFill){let h=e.width*(this.fillLevel/100);t.ctx.beginPath(),t.ctx.rect(e.x,e.y,h,e.height)}else{let h=e.height*(this.fillLevel/100),l=e.y+e.height-h;t.ctx.beginPath(),t.ctx.rect(e.x,l,e.width,e.height)}t.ctx.clip();let i=this.x+this.width/2,r=this.y+this.height/2,s=(this.width-this.lineWidth)/2,o=(this.height-this.lineWidth)/2,a=this.alarmSensitiveForegroundColor;if(this.gradient){let h=this.horizontalFill?this.x:this.x+this.width,l=this.horizontalFill?this.y+this.height:this.y,d=t.createLinearGradient(this.x,this.y,h,l);d.addColorStop(0,this.foregroundGradientStartColor.toString()),d.addColorStop(1,a.toString()),t.fillEllipse({cx:i,cy:r,rx:s,ry:o,gradient:d})}else t.fillEllipse({cx:i,cy:r,rx:s,ry:o,color:a});t.ctx.restore()}get alpha(){return this.properties.getValue(yo)}get lineWidth(){return this.scale*this.properties.getValue(Ao)}get fillLevel(){return this.properties.getValue(To)}get horizontalFill(){return this.properties.getValue(Vo)}get lineColor(){return this.properties.getValue(Co)}get lineStyle(){return this.properties.getValue(_o)}get gradient(){return this.properties.getValue(So)}get backgroundGradientStartColor(){return this.properties.getValue(vo)}get foregroundGradientStartColor(){return this.properties.getValue(bo)}},Lo="image_file",Po="no_animation",ko="transparency",Lc=class extends G{currentImageFile;imageElement;imageSnapshot;imageLoading=!1;imageLoaded=!1;constructor(t,e){super(t,e),this.properties.add(new _(Lo)),this.properties.add(new _(Po)),this.properties.add(new y(ko,!0))}init(){this.imageElement=new Image(this.width,this.height),this.imageElement.onload=()=>{this.snapshotImage(this.imageElement),this.imageLoading=!1,this.imageLoaded=!0,this.requestRepaint()},this.triggerImageLoad()}draw(t){this.imageFile&&this.currentImageFile!==this.imageFile&&this.triggerImageLoad(),this.transparency||(t.ctx.fillStyle=this.backgroundColor.toString(),t.ctx.fillRect(this.x,this.y,this.width,this.height)),this.imageLoading&&this.imageSnapshot?t.ctx.drawImage(this.imageSnapshot,this.x,this.y,this.width,this.height):this.imageLoaded&&(this.noAnimation?t.ctx.drawImage(this.imageSnapshot,this.x,this.y,this.width,this.height):t.ctx.drawImage(this.imageElement,this.x,this.y,this.width,this.height))}triggerImageLoad(){this.imageLoading=!0,this.imageLoaded=!1,this.imageElement&&this.imageFile&&(this.currentImageFile=this.imageFile,this.imageElement.src=this.resolvePath(this.imageFile))}snapshotImage(t){let e=document.createElement("canvas"),i=e.getContext("2d");e.width=t.naturalWidth,e.height=t.naturalHeight,i.drawImage(t,0,0),this.imageSnapshot=e}get transparency(){return this.properties.getValue(ko)}get imageFile(){return this.properties.getValue(Lo)}get noAnimation(){return this.properties.getValue(Po)}},Mo="font",Ro="horizontal_alignment",Eo="vertical_alignment",Wo="wrap_words",Pc=class extends G{constructor(t,e){super(t,e),this.properties.add(new O(Mo)),this.properties.add(new b(Ro)),this.properties.add(new b(Eo)),this.properties.add(new y(Wo))}draw(t){let e=t.ctx;this.transparent||t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.backgroundColor});let i=this.wrapText(t,this.text,this.width);e.fillStyle=this.foregroundColor.toString(),e.font=this.font.getFontString(),e.textAlign="start",e.textBaseline="top";let r=0;for(let h of i){let l=e.measureText(h).width;r=Math.max(r,l)}let s=this.x;this.horizAlignment===1?s=this.x+(this.width-r)/2:this.horizAlignment===2&&(s=this.x+(this.width-r));let o=i.length*this.font.height+(i.length-1)*this.font.height*.2,a=this.y;this.vertAlignment===1?a+=(this.height-o)/2:this.vertAlignment===2&&(a+=this.height-o);for(let h of i)e.fillText(h,s,a),a+=this.font.height*1.2}wrapText(t,e,i){let r=[];for(let s of e.split(`
`))r=r.concat(this.wrapLine(t,s,i));return r}wrapLine(t,e,i){if(!e)return[""];let r=[],s,o,a,h=0;for(;e.length;){for(o=e.length;t.measureText(e.substr(0,o),this.font).width>i;o--);if(s=e.substr(0,o),o!==e.length)for(a=0;s.indexOf(" ",a)!==-1;a=s.indexOf(" ",a)+1);r.push(s.substr(0,a||s.length)),h=Math.max(h,t.measureText(r[r.length-1],this.font).width),e=e.substr(r[r.length-1].length,e.length)}return r}get font(){return this.properties.getValue(Mo).scale(this.scale)}get horizAlignment(){return this.properties.getValue(Ro)}get vertAlignment(){return this.properties.getValue(Eo)}get wrapWords(){return this.properties.getValue(Wo)}},Bo="alpha",Io="fill_level",Ho="horizontal_fill",Do="line_color",No="line_style",Fo="line_width",Dt="points",kc=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(Bo,255)),this.properties.add(new b(Fo)),this.properties.add(new H(Io)),this.properties.add(new y(Ho)),this.properties.add(new R(Do)),this.properties.add(new b(No)),this.properties.add(new ne(Dt,[]))}init(){this.addPropertyListener("x",(t,e)=>{let i=this.properties.getValue(Dt),r=se(i,t-e,0);this.properties.setValue(Dt,r),this.requestRepaint()}),this.addPropertyListener("y",(t,e)=>{let i=this.properties.getValue(Dt),r=se(i,0,t-e);this.properties.setValue(Dt,r),this.requestRepaint()})}draw(t){let{scale:e}=this;t.ctx.globalAlpha=this.alpha/255;let i=S.fromPoints(this.points).closePath();if(!this.transparent){let r=this.alarmSensitiveBackgroundColor;t.fillPath({path:i,color:r})}this.lineWidth&&(this.lineStyle===0?t.strokePath({path:i,lineWidth:this.lineWidth,color:this.lineColor}):this.lineStyle===2?t.strokePath({path:i,lineWidth:this.lineWidth,color:this.lineColor,dash:[6*e,2*e]}):console.warn(`Unsupported polygon line style ${this.lineStyle}`)),this.fillLevel&&this.drawFill(t,i),t.ctx.globalAlpha=1}drawFill(t,e){let i=this.y,r=this.width,s=this.height;this.horizontalFill?r*=this.fillLevel/100:(s*=this.fillLevel/100,i+=s),t.ctx.save();let o=this.x-this.lineWidth/2,a=i-this.lineWidth/2,h=r+this.lineWidth,l=s+this.lineWidth;t.ctx.beginPath(),t.ctx.rect(o,a,h,l),t.ctx.clip();let d=this.alarmSensitiveForegroundColor;t.fillPath({path:e,color:d}),t.ctx.restore()}get alpha(){return this.properties.getValue(Bo)}get lineWidth(){return this.scale*this.properties.getValue(Fo)}get fillLevel(){return this.properties.getValue(Io)}get horizontalFill(){return this.properties.getValue(Ho)}get lineColor(){return this.properties.getValue(Do)}get lineStyle(){return this.properties.getValue(No)}get points(){return oe(this.properties.getValue(Dt),this.scale)}},$o="alpha",Oo="arrows",Go="arrow_length",zo="fill_arrow",Uo="fill_level",qo="horizontal_fill",Yo="line_width",Xo="points",Mc=class extends G{constructor(t,e){super(t,e),this.properties.add(new b($o,255)),this.properties.add(new b(Yo)),this.properties.add(new H(Uo)),this.properties.add(new y(qo)),this.properties.add(new ne(Xo,[])),this.properties.add(new b(Go)),this.properties.add(new y(zo)),this.properties.add(new b(Oo))}draw(t){let e=t.ctx;e.globalAlpha=this.alpha/255,this.transparent&&(e.globalAlpha=0),this.drawShape(e,this.backgroundColor),this.fillLevel&&this.drawFill(e),e.globalAlpha=1}drawFill(t){let e=this.y,i=this.width,r=this.height;this.horizontalFill?i*=this.fillLevel/100:(r*=this.fillLevel/100,e+=r),t.save();let s=this.x-this.lineWidth/2,o=e-this.lineWidth/2,a=i+this.lineWidth,h=r+this.lineWidth;t.beginPath(),t.rect(s,o,a,h),t.clip(),this.drawShape(t,this.foregroundColor),t.restore()}drawShape(t,e){t.strokeStyle=e.toString(),t.lineWidth=this.lineWidth,t.beginPath();for(let i=0;i<this.points.length;i++)i===0?t.moveTo(this.points[i].x,this.points[i].y):t.lineTo(this.points[i].x,this.points[i].y);if(t.stroke(),this.points.length>=2){let i=this.points[0],r=this.points[this.points.length-1];if(this.arrows===2||this.arrows===3){let s=this.calculateArrowPoints(this.points[this.points.length-2],r);if(s[2]=r,this.fillArrow){t.fillStyle=e.toString(),t.beginPath();for(let o=0;o<s.length;o++)o===0?t.moveTo(s[o].x,s[o].y):t.lineTo(s[o].x,s[o].y);t.fill()}else t.strokeStyle=e.toString(),t.lineWidth=this.lineWidth,t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(s[0].x,s[0].y),t.moveTo(r.x,r.y),t.lineTo(s[1].x,s[1].y),t.stroke()}if(this.arrows===1||this.arrows===3){let s=this.calculateArrowPoints(this.points[1],i);if(s[2]=i,this.fillArrow){t.fillStyle=e.toString(),t.beginPath();for(let o=0;o<s.length;o++)o===0?t.moveTo(s[o].x,s[o].y):t.lineTo(s[o].x,s[o].y);t.fill()}else t.strokeStyle=e.toString(),t.lineWidth=this.lineWidth,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s[0].x,s[0].y),t.moveTo(i.x,i.y),t.lineTo(s[1].x,s[1].y),t.stroke()}}}calculateArrowPoints(t,e){let i=_d(e,t),r=Math.PI/10,s=new kt(this.arrowLength,i.theta-r),o=new kt(this.arrowLength,i.theta+r),a=new kt(Math.floor(this.arrowLength*Math.cos(r)),i.theta),h=Pt(s.toPoint(),e.x,e.y),l=Pt(o.toPoint(),e.x,e.y),d=Pt(a.toPoint(),e.x,e.y);return[h,l,d]}get alpha(){return this.properties.getValue($o)}get lineWidth(){return this.scale*this.properties.getValue(Yo)}get fillLevel(){return this.properties.getValue(Uo)}get horizontalFill(){return this.properties.getValue(qo)}get points(){return oe(this.properties.getValue(Xo),this.scale)}get arrows(){return this.properties.getValue(Oo)}get fillArrow(){return this.properties.getValue(zo)}get arrowLength(){return this.properties.getValue(Go)}},Ko="alpha",jo="bg_gradient_color",Zo="fg_gradient_color",Jo="fill_level",Qo="gradient",ta="horizontal_fill",ea="line_color",ia="line_width",ra="line_style",Rc=class extends G{constructor(t,e){super(t,e),this.fillRoundRectangleBackgroundBorder=!1,this.properties.add(new b(Ko,255)),this.properties.add(new R(jo)),this.properties.add(new R(Zo)),this.properties.add(new y(Qo)),this.properties.add(new b(ia)),this.properties.add(new H(Jo)),this.properties.add(new y(ta)),this.properties.add(new R(ea)),this.properties.add(new b(ra))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawBackground(t),this.fillLevel&&this.drawFill(t),t.ctx.globalAlpha=1}drawBackground(t){if(!this.transparent){let e=this.alarmSensitiveBackgroundColor;if(this.gradient){let i=this.horizontalFill?this.x:this.x+this.width,r=this.horizontalFill?this.y+this.height:this.y,s=t.createLinearGradient(this.x,this.y,i,r);s.addColorStop(0,this.backgroundGradientStartColor.toString()),s.addColorStop(1,e.toString()),t.fillRect(A(C({},this.area),{gradient:s}))}else t.fillRect(A(C({},this.area),{color:e}))}this.lineWidth&&(this.lineStyle===0?t.strokeRect(A(C({},this.area),{color:this.lineColor,lineWidth:this.lineWidth,crispen:!0})):this.lineStyle===1?t.strokeRect(A(C({},this.area),{color:this.lineColor,lineWidth:this.lineWidth,crispen:!0,dash:[6*this.scale,2*this.scale]})):console.warn(`Unsupported rectangle line style ${this.lineStyle}`))}drawFill(t){let e=U(this,this.lineWidth);if(t.ctx.save(),this.horizontalFill){let r=e.width*(this.fillLevel/100);t.ctx.beginPath(),t.ctx.rect(e.x,e.y,r,e.height)}else{let r=e.height*(this.fillLevel/100),s=e.y+e.height-r;t.ctx.beginPath(),t.ctx.rect(e.x,s,e.width,e.height)}t.ctx.clip();let i=this.alarmSensitiveForegroundColor;if(this.gradient){let r=this.horizontalFill?e.x:e.x+e.width,s=this.horizontalFill?e.y+e.height:e.y,o=t.createLinearGradient(e.x,e.y,r,s);o.addColorStop(0,this.foregroundGradientStartColor.toString()),o.addColorStop(1,i.toString()),t.fillRect(A(C({},e),{gradient:o}))}else t.fillRect(A(C({},e),{color:i}));t.ctx.restore()}get alpha(){return this.properties.getValue(Ko)}get lineWidth(){return this.scale*this.properties.getValue(ia)}get fillLevel(){return this.properties.getValue(Jo)}get horizontalFill(){return this.properties.getValue(ta)}get lineColor(){return this.properties.getValue(ea)}get lineStyle(){return this.properties.getValue(ra)}get gradient(){return this.properties.getValue(Qo)}get backgroundGradientStartColor(){return this.properties.getValue(jo)}get foregroundGradientStartColor(){return this.properties.getValue(Zo)}},sa="alpha",oa="bg_gradient_color",aa="corner_width",ha="corner_height",la="fg_gradient_color",na="fill_level",da="gradient",ua="horizontal_fill",pa="line_color",ca="line_width",ga="line_style",Ec=class extends G{constructor(t,e){super(t,e),this.fillRoundRectangleBackgroundBorder=!1,this.properties.add(new b(sa,255)),this.properties.add(new R(oa)),this.properties.add(new R(la)),this.properties.add(new y(da)),this.properties.add(new b(ca)),this.properties.add(new H(na)),this.properties.add(new y(ua)),this.properties.add(new R(pa)),this.properties.add(new b(aa)),this.properties.add(new b(ha)),this.properties.add(new b(ga))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawBackground(t),this.fillLevel&&this.drawFill(t),t.ctx.globalAlpha=1}drawBackground(t){if(!this.transparent){let e=this.alarmSensitiveBackgroundColor;if(this.gradient){let i=this.horizontalFill?this.x:this.x+this.width,r=this.horizontalFill?this.y+this.height:this.y,s=t.createLinearGradient(this.x,this.y,i,r);s.addColorStop(0,this.backgroundGradientStartColor.toString()),s.addColorStop(1,e.toString()),t.fillRect(A(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,gradient:s}))}else t.fillRect(A(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,color:e}))}this.lineWidth&&(this.lineStyle===0?t.strokeRect(A(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,color:this.lineColor,lineWidth:this.lineWidth,crispen:!0})):this.lineStyle===1?t.strokeRect(A(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,color:this.lineColor,lineWidth:this.lineWidth,crispen:!0,dash:[6*this.scale,2*this.scale]})):console.warn(`Unsupported RoundedRectangle line style ${this.lineStyle}`))}drawFill(t){let e=this.cornerWidth/2,i=this.cornerHeight/2,r=U(this,this.lineWidth);if(t.ctx.save(),this.horizontalFill){let o=r.width*(this.fillLevel/100);t.ctx.beginPath(),t.ctx.rect(r.x,r.y,o,r.height)}else{let o=r.height*(this.fillLevel/100),a=r.y+r.height-o;t.ctx.beginPath(),t.ctx.rect(r.x,a,r.width,r.height)}t.ctx.clip();let s=this.alarmSensitiveForegroundColor;if(this.gradient){let o=this.horizontalFill?r.x:r.x+r.width,a=this.horizontalFill?r.y+r.height:r.y,h=t.createLinearGradient(r.x,r.y,o,a);h.addColorStop(0,this.foregroundGradientStartColor.toString()),h.addColorStop(1,s.toString()),t.fillRect(A(C({},r),{rx:e,ry:i,gradient:h}))}else t.fillRect(A(C({},r),{rx:e,ry:i,color:s}));t.ctx.restore()}get alpha(){return this.properties.getValue(sa)}get lineWidth(){return this.scale*this.properties.getValue(ca)}get fillLevel(){return this.properties.getValue(na)}get horizontalFill(){return this.properties.getValue(ua)}get lineColor(){return this.properties.getValue(pa)}get lineStyle(){return this.properties.getValue(ga)}get gradient(){return this.properties.getValue(da)}get cornerWidth(){return this.scale*this.properties.getValue(aa)}get cornerHeight(){return this.scale*this.properties.getValue(ha)}get backgroundGradientStartColor(){return this.properties.getValue(oa)}get foregroundGradientStartColor(){return this.properties.getValue(la)}},ma="bitReverse",fa="effect_3d",xa="horizontal",wa="led_border",ya="led_border_color",va="led_packed",ba="numBits",Ta="off_color",Sa="on_color",Va="startBit",Ca="square_led",Wc=class extends G{constructor(t,e){super(t,e),this.properties.add(new y(ma)),this.properties.add(new y(fa)),this.properties.add(new y(xa)),this.properties.add(new b(ba)),this.properties.add(new R(Ta)),this.properties.add(new R(Sa)),this.properties.add(new b(Va)),this.properties.add(new y(Ca)),this.properties.add(new b(wa,3)),this.properties.add(new R(ya,m.DARK_GRAY)),this.properties.add(new y(va,!1))}getLedColor(t){let e=!1;if(this.pv?.value!==void 0)for(let i=this.startBit;i<this.startBit+this.numBits;i++){let r=0;if(this.bitReverse?r=i-this.startBit:r=this.numBits-1-(i-this.startBit),r===t){e=(this.pv?.value>>i&1)>0;break}}return e?this.onColor:this.offColor}draw(t){if(this.numBits<1)return;let e=this.bounds;this.borderAlarmSensitive&&(e=U(e,2*this.scale)),this.horizontal?this.drawHorizontal(t,e):this.drawVertical(t,e)}drawHorizontal(t,e){let i,r;this.ledPacked?(i=Math.floor((e.width-this.ledBorder)/this.numBits+this.ledBorder),r=i-this.ledBorder):(i=Math.floor(e.width/this.numBits),r=i);let s=0;i>e.height||this.squareLed?s=e.height:s=i;for(let o=0;o<this.numBits;o++)if(this.squareLed){let a={x:e.x+o*r,y:e.y,width:i,height:s};this.effect3d?this.drawSquare3d(t,a,o):this.drawSquare2d(t,a,o)}else{let a=Math.min(i,s),h={x:e.x+o*r,y:e.y,width:a,height:a};this.effect3d?this.drawCircle3d(t,h,o):this.drawCircle2d(t,h,o)}}drawVertical(t,e){let i,r;this.ledPacked?(i=Math.floor((e.height-this.ledBorder)/this.numBits+this.ledBorder),r=i-this.ledBorder):(i=Math.floor(e.height/this.numBits),r=i);let s=0;i>e.width||this.squareLed?s=e.width:s=i;for(let o=0;o<this.numBits;o++)if(this.squareLed){let a={x:e.x,y:e.y+o*r,width:s,height:i};this.effect3d?this.drawSquare3d(t,a,o):this.drawSquare2d(t,a,o)}else{let a=Math.min(s,i),h={x:e.x,y:e.y+o*r,width:a,height:a};this.effect3d?this.drawCircle3d(t,h,o):this.drawCircle2d(t,h,o)}}drawCircle2d(t,e,i){let r=e.x+e.width/2,s=e.y+e.height/2,o=e.width/2,a=e.height/2;this.ledBorder>0&&(o-=this.ledBorder/2,a-=this.ledBorder/2),t.fillEllipse({cx:r,cy:s,rx:o,ry:a,color:this.getLedColor(i)}),t.strokeEllipse({cx:r,cy:s,rx:o,ry:a,color:this.ledBorderColor,lineWidth:this.ledBorder})}drawCircle3d(t,e,i){let r=e.x+e.width/2,s=e.y+e.height/2,o=e.width/2,a=e.height/2;t.fillEllipse({cx:r,cy:s,rx:o,ry:a,color:m.WHITE});let h=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);h.addColorStop(0,this.ledBorderColor.toString()),h.addColorStop(1,this.ledBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:r,cy:s,rx:o,ry:a,gradient:h});let l=e.width-2*this.ledBorder,d=e.height-2*this.ledBorder;o=l/2,a=d/2,t.fillEllipse({cx:r,cy:s,rx:o,ry:a,color:this.getLedColor(i)}),h=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),h.addColorStop(0,m.WHITE.toString()),h.addColorStop(1,this.ledBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:r,cy:s,rx:o,ry:a,gradient:h})}drawSquare2d(t,e,i){let r=Ft(e.x,e.y,e.width,e.height,this.ledBorder);t.fillRect(A(C({},r),{color:this.getLedColor(i)})),t.strokeRect(A(C({},r),{color:this.ledBorderColor,lineWidth:this.ledBorder}))}drawSquare3d(t,e,i){t.fillRect(A(C({},e),{color:this.ledBorderColor}));let r=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y);r.addColorStop(0,"rgba(0,0,0,0.078)"),r.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:r,path:new S(e.x,e.y).lineTo(e.x+this.ledBorder,e.y+this.ledBorder).lineTo(e.x+this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x,e.y+e.height)}),r=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),r.addColorStop(0,"rgba(0,0,0,0.078)"),r.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:r,path:new S(e.x,e.y).lineTo(e.x+this.ledBorder,e.y+this.ledBorder).lineTo(e.x+e.width-this.ledBorder,e.y+this.ledBorder).lineTo(e.x+e.width,e.y)}),r=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y),r.addColorStop(0,"rgba(255,255,255,0.078)"),r.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:r,path:new S(e.x+e.width,e.y).lineTo(e.x+e.width-this.ledBorder,e.y+this.ledBorder).lineTo(e.x+e.width-this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x+e.width,e.y+e.height)}),r=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),r.addColorStop(0,"rgba(255,255,255,0.078)"),r.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:r,path:new S(e.x,e.y+e.height).lineTo(e.x+this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x+e.width-this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x+e.width,e.y+e.height)});let s=e.x+this.ledBorder,o=e.y+this.ledBorder,a=e.width-2*this.ledBorder,h=e.height-2*this.ledBorder,l=this.getLedColor(i);t.fillRect({x:s,y:o,width:a,height:h,color:l}),r=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),r.addColorStop(0,"rgba(255,255,255,0.784)"),r.addColorStop(1,l.withAlpha(0).toString()),t.fillRect({x:s,y:o,width:a,height:h,gradient:r})}get bitReverse(){return this.properties.getValue(ma)}get horizontal(){return this.properties.getValue(xa)}get numBits(){return this.properties.getValue(ba)}get startBit(){return this.properties.getValue(Va)}get ledPacked(){return this.properties.getValue(va)}get ledBorder(){return this.scale*this.properties.getValue(wa)}get ledBorderColor(){return this.properties.getValue(ya)}get offColor(){return this.properties.getValue(Ta)}get onColor(){return this.properties.getValue(Sa)}get effect3d(){return this.properties.getValue(fa)}get squareLed(){return this.properties.getValue(Ca)}},Qt=class{prefix="";suffix="";comma=0;minInt=1;minFrac=0;maxFrac=0;constructor(t){for(let h=0;h<t.length;h++)if(t.charAt(h)=="#"||t.charAt(h)=="0"){this.prefix=t.substring(0,h),t=t.substring(h);break}this.suffix=t.replace(/[#]|[0]|[,]|[.]/g,"");let e=t.replace(/[^0#,.]/g,""),i="",r="",s=e.indexOf(".");s!==-1?(i=e.substring(0,s),r=e.substring(s+1)):i=e;let o=i.lastIndexOf(",");o!==-1&&(this.comma=i.length-1-o),i=i.replace(/[,]/g,""),r=r.replace(/[,]|[.]+/g,""),this.maxFrac=r.length;let a=i.replace(/[^0]/g,"");a.length>this.minInt&&(this.minInt=a.length),a=r.replace(/[^0]/g,""),this.minFrac=a.length}format(t){let e=this.formatBack(t).toLowerCase();if(isNaN(e)||e.length==0)return t;if(e.indexOf("e")!=-1){let g=Number(e);if(g===1/0||g===-1/0||(e=g+"",e.indexOf("e")!==-1))return e}let i=!1;e.charAt(0)==="-"?(i=!0,e=e.substring(1)):e.charAt(0)==="+"&&(e=e.substring(1));let r=e.indexOf("."),s="",o="";r!=-1?(s=e.substring(0,r),o=e.substring(r+1)):s=e,o=o.replace(/[.]/,"");let a=this.suffix&&this.suffix.charAt(0)==="%",h=this.minInt,l=this.minFrac,d=this.maxFrac;if(a&&(h-=2,l+=2,d+=2),o.length>d){let g=+("0."+o);g=d==0?Math.round(g):g.toFixed(d),o=g.toString(10).substr(2);let v=g>=1?1:0,w,T=s.length-1;for(;v;)if(T==-1){s="1"+s;break}else w=Number(s.charAt(T)),w===9?(w="0",v=1):(w=++w+"",v=0),s=s.substring(0,T)+w+s.substring(T+1,s.length),T--}for(let g=o.length;g<l;g++)o=o+"0";for(;o.length>l&&o.charAt(o.length-1)=="0";)o=o.substring(0,o.length-1);for(let g=s.length;g<h;g++)s="0"+s;for(;s.length>h&&s.charAt(0)=="0";)s=s.substring(1);a&&(s+=o.substring(0,2),o=o.substring(2));let n=0;for(let g=s.length;g>0;g--)n!=0&&n%this.comma==0&&(s=s.substring(0,g)+","+s.substring(g),n=0),n++;let p;return o.length>0?p=this.prefix+s+"."+o+this.suffix:p=this.prefix+s+this.suffix,i&&(p="-"+p),p}formatBack(t){if(t+="",!t)return"";if(!isNaN(t))return this.getNumericString(t);let e=t,i=!1;t.charAt(0)==="-"&&(e=e.substr(1),i=!0);let r=e.indexOf(this.prefix),s=this.suffix==""?e.length:e.indexOf(this.suffix,this.prefix.length+1);return r==0&&s>0&&(e=e.substr(0,s),e=e.substr(this.prefix.length),e=e.replace(/,/g,""),i&&(e="-"+e),!isNaN(e))?this.getNumericString(e):t}getNumericString(t){let e=Number(t)+"";if(t.indexOf(".")>-1&&e.indexOf(".")<0){for(var i=t.indexOf(".")+1;i<t.length;i++)if(t.charAt(i)!=="0")return t;return e}return t}},Bc=1,Ic=8,Q=2,Ud=class{constructor(t,e,i){this.rampWidth=t,this.startAngle=e,this.endAngle=i}lolo=10;loloColor=m.RED;showLoLo=!0;lo=25;loColor=m.ORANGE;showLo=!0;hi=75;hiColor=m.ORANGE;showHi=!0;hihi=90;hihiColor=m.RED;showHiHi=!0;minimum=0;maximum=100;gradient=!0;logScale=!1;effect3d=!0;labelsOutside=!0;range={min:this.minimum,max:this.maximum};lengthInDegrees=0;radius=0;draw(t,e,i){if(this.labelsOutside){let r=Bc+Ic;this.radius=e.width/2-r}else this.radius=e.width/2-1;this.range=this.getRenderedRange(),this.endAngle-this.startAngle>0?this.lengthInDegrees=360-(this.endAngle-this.startAngle):this.lengthInDegrees=this.startAngle-this.endAngle,this.drawRamp(t,i)}drawRamp(t,e){let i=e.x+e.width/2,r=e.y+e.height/2,s=e.width/2,o=e.height/2,a,h=360-this.endAngle;if(this.endAngle-this.startAngle>0?a=this.startAngle-90:a=this.startAngle+90,this.showLoLo){let v=a,w=360-this.getValuePosition(this.lolo,!0);t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(v),endAngle:$(w),color:this.loloColor})}if(this.showLo){let v;this.showLoLo?v=this.lolo:v=this.minimum;let w=360-this.getValuePosition(v,!0),T=360-this.getValuePosition(this.lo,!0);if(this.effect3d&&this.gradient&&this.showLoLo){let B=$(this.getValuePosition(v,!0)-Q),M=xt(e.width/2,B,e),k=$(this.getValuePosition(this.lo,!0)+Q),W=xt(e.width/2,k,e),D=t.createLinearGradient(M.x,M.y,W.x,W.y);D.addColorStop(0,this.loloColor.toString()),D.addColorStop(1,this.loColor.toString()),t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w-Q/2),endAngle:$(T+Q/2),gradient:D})}else t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w),endAngle:$(T),color:this.loColor})}let l=this.minimum;this.showLo?l=this.lo:this.showLoLo&&(l=this.lolo);let d=this.maximum;this.showHi?d=this.hi:this.showHiHi&&(d=this.hihi);let n=(l+d)/2,p=360-this.getValuePosition(l,!0),g=360-this.getValuePosition(n,!0);if(this.effect3d&&this.gradient&&(this.showLoLo||this.showLo)){let v=$(this.getValuePosition(l,!0)-Q),w=xt(e.width/2,v,e),T=$(this.getValuePosition(n,!0)+Q),B=xt(e.width/2,T,e),M=t.createLinearGradient(w.x,w.y,B.x,B.y);M.addColorStop(0,(this.showLo?this.loColor:this.loloColor).toString()),M.addColorStop(1,m.GREEN.toString()),t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p-Q/2),endAngle:$(g+Q/2),gradient:M})}else t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p),endAngle:$(g),color:m.GREEN});if(p=360-this.getValuePosition(n,!0),g=360-this.getValuePosition(d,!0),this.effect3d&&this.gradient&&(this.showHi||this.showHiHi)){let v=$(this.getValuePosition(n,!0)-Q),w=xt(e.width/2,v,e),T=$(this.getValuePosition(d,!0)+Q),B=xt(e.width/2,T,e),M=t.createLinearGradient(w.x,w.y,B.x,B.y);M.addColorStop(0,m.GREEN.toString()),M.addColorStop(1,(this.showHi?this.hiColor:this.hihiColor).toString());let k=g!==h?Q/2:0;t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p-Q/2),endAngle:$(g+k),gradient:M})}else t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p),endAngle:$(g),color:m.GREEN});if(this.showHi){let v;this.showHiHi?v=this.hihi:v=this.maximum;let w=360-this.getValuePosition(this.hi,!0),T=360-this.getValuePosition(v,!0);if(this.effect3d&&this.gradient&&this.showHiHi){let B=$(this.getValuePosition(this.hi,!0)-Q),M=xt(e.width/2,B,e),k=$(this.getValuePosition(v,!0)+Q),W=xt(e.width/2,k,e),D=t.createLinearGradient(M.x,M.y,W.x,W.y);D.addColorStop(0,this.hiColor.toString()),D.addColorStop(1,this.hihiColor.toString());let N=T!==h?Q/2:0;t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w-Q/2),endAngle:$(T+N),gradient:D})}else t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w),endAngle:$(T),color:this.hiColor})}if(this.showHiHi){p=360-this.getValuePosition(this.hihi,!0),g=h;let v=this.gradient?Q/2:0;t.strokeEllipse({cx:i,cy:r,rx:s-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p-v),endAngle:$(g),color:this.hihiColor})}}getRadius(){return this.radius}getValuePosition(t,e=!1){e&&(t=this.getValueInRange(t));let i;return this.logScale?i=this.startAngle-(Math.log10(t)-Math.log10(this.range.min))/(Math.log10(this.range.max)-Math.log10(this.range.min))*this.lengthInDegrees:i=this.startAngle-(t-this.range.min)/(this.range.max-this.range.min)*this.lengthInDegrees,i<0&&(i+=360),i}getValueInRange(t){return this.range.min<=t&&t<=this.range.max?t:t>this.range.max?this.range.max:this.range.min}getRenderedRange(){let t={min:this.minimum,max:this.maximum};return this.logScale&&(this.minimum<=0&&(t.min=.1),t.max<=this.minimum&&(t.max=t.min+100)),t}},Aa=new m(100,100,100),Hc=16,Dc=8,Nc=5,Fc=-1,_a="color_hi",La="color_hihi",Pa="color_lo",ka="color_lolo",Ma="effect_3d",Ra="font",Ea="value_label_format",Wa="level_hi",Ba="level_hihi",Ia="level_lo",Ha="level_lolo",Da="limits_from_pv",Na="log_scale",Fa="minimum",$a="maximum",Oa="needle_color",Ga="ramp_gradient",za="show_ramp",ke=225,$c=315,Oc=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(_a)),this.properties.add(new R(La)),this.properties.add(new R(Pa)),this.properties.add(new R(ka)),this.properties.add(new y(Ma)),this.properties.add(new O(Ra)),this.properties.add(new H(Wa)),this.properties.add(new H(Ba)),this.properties.add(new H(Ia)),this.properties.add(new H(Ha)),this.properties.add(new y(Na)),this.properties.add(new y(Da)),this.properties.add(new H($a)),this.properties.add(new H(Fa)),this.properties.add(new R(Oa)),this.properties.add(new y(Ga)),this.properties.add(new y(za,!0)),this.properties.add(new _(Ea))}draw(t){let e;this.limitsFromPv&&this.pv&&!this.pv.disconnected?e={min:this.pv.lowerDisplayLimit??this.minimum,lolo:this.pv.lowerAlarmLimit,lo:this.pv.lowerWarningLimit,hi:this.pv.upperWarningLimit,hihi:this.pv.upperAlarmLimit,max:this.pv.upperDisplayLimit??this.maximum}:e={min:this.minimum,lolo:this.levelLoLo,lo:this.levelLo,hi:this.levelHi,hihi:this.levelHiHi,max:this.maximum},this.logScale&&(e.min=Math.max(.1,e.min),e.max<=e.min&&(e.max=e.min+100));let i=Math.min(this.width,this.height),r=i;this.drawBackground(t,i,r),this.showRamp&&this.drawRamp(t,i,r,e),this.drawLabel(t,i,r),this.drawNeedle(t,i,r,e),this.drawNeedleCenter(t,i,r)}drawBackground(t,e,i){if(t.fillEllipse({cx:this.x+e/2,cy:this.y+i/2,rx:e/2,ry:i/2,color:m.GRAY}),this.effect3d){let s=t.createLinearGradient(this.x,this.y,this.x+this.width,this.y+this.height);s.addColorStop(0,Aa.toString()),s.addColorStop(1,m.WHITE.toString()),t.fillEllipse({cx:this.x+e/2,cy:this.y+i/2,rx:e/2,ry:i/2,gradient:s})}let r=(this.effect3d?2:1)*this.scale;if(t.fillEllipse({cx:this.x+e/2,cy:this.y+i/2,rx:e/2-r,ry:i/2-r,color:this.backgroundColor}),this.effect3d){let s=e/2,o=9.5/10,a=1/2,h=8.5/10,l=$(0),d=$(35),n={x:Math.floor(this.x+e/2-s*h*Math.cos(l)),y:Math.floor(this.y+i/2-s*o),width:Math.floor(2*s*h*Math.cos(l)),height:Math.floor(s*o+s*a)},p=t.createLinearGradient(n.x,n.y,n.x,n.y+n.height);p.addColorStop(0,m.WHITE.withAlpha(90/255).toString()),p.addColorStop(1,m.WHITE.withAlpha(0).toString()),t.fillEllipse({cx:n.x+n.width/2,cy:n.y+n.height/2,rx:n.width/2,ry:n.height/2,gradient:p}),n={x:Math.floor(this.x+e/2-s*h*Math.sin(d)),y:Math.floor(Math.ceil(this.y+i/2+s*a)),width:Math.floor(2*s*h*Math.sin(d)),height:Math.floor(Math.ceil(s*o-s*a))},p=t.createLinearGradient(n.x,n.y,n.x,n.y+n.height),p.addColorStop(0,m.WHITE.withAlpha(0).toString()),p.addColorStop(1,m.WHITE.withAlpha(40/255).toString()),t.fillEllipse({cx:n.x+n.width/2,cy:n.y+n.height/2,rx:n.width/2,ry:n.height/2,gradient:p})}}drawRamp(t,e,i,r){let s=U({x:this.x,y:this.y,width:e,height:i},e/4,i/4),o=C({},s);o.width=Math.min(s.width,s.height),o.height=s.width;let a=new Ud(10*this.scale,225,315);a.lolo=r.lolo,a.loloColor=this.colorLoLo,a.lo=r.lo,a.loColor=this.colorLo,a.hi=r.hi,a.hiColor=this.colorHi,a.hihi=r.hihi,a.hihiColor=this.colorHiHi,a.minimum=r.min,a.maximum=r.max,a.effect3d=this.effect3d,a.gradient=this.rampGradient,a.logScale=this.logScale,a.draw(t,s,o)}drawLabel(t,e,i){let r=it.ARIAL_12_BOLD.scale(this.scale);if(this.pv?.value!==void 0){let s=this.formatLabelValue(this.pv.value),o=t.measureText(s,r);t.fillText({x:this.x+e/2-o.width/2,y:this.y+i*7/8-o.height/2,color:this.foregroundColor,align:"left",baseline:"top",font:r,text:s})}}drawNeedle(t,e,i,r){let s=this.x+e/2,o=this.y+i/2,a;if(this.pv?.value!==void 0){let T=this.getValueInRange(this.pv.value,r);a=360-this.getValuePosition(T,r),r.max>r.min?T>r.max?a+=10:T<r.min&&(a-=10):T>r.min?a-=10:T<r.max&&(a+=10)}else a=360-this.getValuePosition((r.min+r.max)/2,r);let h=$(a),{scale:l}=this,{needleDiameter:d,majorTickLength:n,gapBetweenNeedleScale:p}=this,g=$t(s,o-d/2+3*l,s,o,h),v=$t(s+e/2-n-p,o,s,o,h),w=$t(s,o+d/2-3*l,s,o,h);t.fillPath({color:this.needleColor,path:new S(g.x,g.y).lineTo(v.x,v.y).lineTo(w.x,w.y).closePath()})}drawNeedleCenter(t,e,i){let{needleDiameter:r}=this,s=this.x+e/2,o=this.y+i/2,a=r/2,h=r/2;if(this.effect3d){let l=t.createLinearGradient(s-a,o-h,s+a,o+h);l.addColorStop(0,m.WHITE.toString()),l.addColorStop(1,Aa.toString()),t.fillEllipse({cx:s,cy:o,rx:a,ry:h,gradient:l})}else t.fillEllipse({cx:s,cy:o,rx:a,ry:h,color:m.GRAY})}getValueInRange(t,e){return e.min<=t&&t<=e.max?t:t>e.max?e.max:e.min}getValuePosition(t,e){let i=360-($c-ke),r;return this.logScale?r=ke-(Math.log10(t)-Math.log10(e.min))/(Math.log10(e.max)-Math.log10(e.min))*i:r=ke-(t-e.min)/(e.max-e.min)*i,r<0&&(r+=360),r}formatLabelValue(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(3)))}get needleDiameter(){return this.scale*Hc}get majorTickLength(){return this.scale*Dc}get minorTickLength(){return this.scale*Nc}get gapBetweenNeedleScale(){return this.scale*Fc}get colorLo(){return this.properties.getValue(Pa)}get colorLoLo(){return this.properties.getValue(ka)}get colorHi(){return this.properties.getValue(_a)}get colorHiHi(){return this.properties.getValue(La)}get effect3d(){return this.properties.getValue(Ma)}get font(){return this.properties.getValue(Ra).scale(this.scale)}get levelLo(){return this.properties.getValue(Ia)}get levelLoLo(){return this.properties.getValue(Ha)}get levelHi(){return this.properties.getValue(Wa)}get levelHiHi(){return this.properties.getValue(Ba)}get limitsFromPv(){return this.properties.getValue(Da)}get logScale(){return this.properties.getValue(Na)}get minimum(){return this.properties.getValue(Fa)}get maximum(){return this.properties.getValue($a)}get needleColor(){return this.properties.getValue(Oa)}get rampGradient(){return this.properties.getValue(Ga)}get showRamp(){return this.properties.getValue(za)}get valueLabelFormat(){return this.properties.getValue(Ea)}},Ua="bit",qa="data_type",Ya="off_image",Xa="off_label",Ka="font",ja="on_image",Za="on_label",Ja="show_boolean_label",Gc=class extends G{onImageElement;onImageLoaded=!1;offImageElement;offImageLoaded=!1;constructor(t,e){super(t,e),this.properties.add(new b(Ua)),this.properties.add(new b(qa)),this.properties.add(new _(Ya)),this.properties.add(new _(Xa)),this.properties.add(new _(ja)),this.properties.add(new _(Za)),this.properties.add(new O(Ka)),this.properties.add(new y(Ja))}init(){this.onImageElement=new Image,this.onImageElement.onload=()=>{this.onImageLoaded=!0,this.requestRepaint()},this.offImageElement=new Image,this.offImageElement.onload=()=>{this.offImageLoaded=!0,this.requestRepaint()},this.onImage&&(this.onImageElement.src=this.resolvePath(this.onImage)),this.offImage&&(this.offImageElement.src=this.resolvePath(this.offImage))}get booleanValue(){return this.bit<0?!!this.pv?.toNumber():this.pv?.value!==void 0?(this.pv?.value>>this.bit&1)>0:!1}get image(){return this.booleanValue?this.onImage:this.offImage}get label(){return this.booleanValue?this.onLabel:this.offLabel}draw(t){this.transparent||t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.backgroundColor}),this.booleanValue?this.onImageLoaded&&t.ctx.drawImage(this.onImageElement,this.x,this.y,this.width,this.height):this.offImageLoaded&&t.ctx.drawImage(this.offImageElement,this.x,this.y,this.width,this.height),this.showBooleanLabel&&t.fillText({x:this.x+this.width/2,y:this.y+this.height/2,font:this.font,baseline:"middle",align:"center",color:this.foregroundColor,text:this.label})}get bit(){return this.properties.getValue(Ua)}get dataType(){return this.properties.getValue(qa)}get showBooleanLabel(){return this.properties.getValue(Ja)}get font(){return this.properties.getValue(Ka).scale(this.scale)}get offLabel(){return this.properties.getValue(Xa)}get offImage(){return this.properties.getValue(Ya)}get onLabel(){return this.properties.getValue(Za)}get onImage(){return this.properties.getValue(ja)}},zc=["January","February","March","April","May","June","July","August","September","October","November","December"],Tt=class{constructor(t,e,i,r,s,o,a,h,l,d){this.formatter=t,this.scale=e,this.scaleFont=i,this.minimum=r,this.maximum=s,this.logScale=o,this.majorTickStepHint=a,this.foregroundColor=h,this.showMinorTicks=l,this.showScale=d}labels=[];labelValues=[];labelPositions=[];labelVisibilities=[];gridStepInPixel=0;horizontal=!1;x=0;y=0;scaleFormat="";timeFormat=0;length=0;margin=0;get scaleLength(){return this.length-2*this.margin}getX(){return this.x}getY(){return this.y}getGridPositions(){let t=[...this.labelPositions];return this.horizontal||(t=t.map(e=>this.length-e)),t.pop(),t.shift(),t}setDimensions(t,e,i,r){this.x=t,this.y=e,this.length=i,this.horizontal=r}getValuePosition(t){let{start:e,stop:i}=this.getMinMax(),r=0,s=this.length-2*this.margin;if(this.logScale)t<=0?r=this.margin:r=(Math.log10(t)-Math.log10(e))/(Math.log10(i)-Math.log10(e))*s+this.margin;else{let o=Math.max(Math.abs(e),Math.abs(i));i/=o,e/=o;let a=i-e;r=(t/o-e)/a*s+this.margin}return this.horizontal?r+this.x:this.length-r+this.y}getMinMax(){let t=this.minimum,e=this.maximum;return this.logScale&&(t<=0&&(t=.1),e<=t&&(e=t+100)),{start:t,stop:e}}getPositionValue(t){let e=this.getMinMax(),{start:i,stop:r}=e,s=this.horizontal?t-this.x:this.length+this.y-t,o=this.length-2*this.margin,a;if(this.logScale)a=Math.pow(10,(s-this.margin)*(Math.log10(r)-Math.log10(i))/o+Math.log10(i));else{let h=Math.max(Math.abs(i),Math.abs(r));r/=h,i/=h;let l=r-i;a=((s-this.margin)/o*l+i)*h}return a}calculateMargin(t,e){if(this.showScale){let i=t.measureText(this.format(this.minimum),this.scaleFont),r=t.measureText(this.format(this.maximum),this.scaleFont);return Math.ceil(e?Math.max(i.width,r.width)/2:Math.max(i.height,r.height)/2)}else return 0}measureHorizontalHeight(t){let e=t.measureText("dummy",this.scaleFont);return this.showScale?e.height+this.spaceBetweenMarkAndLabel+this.majorTickLength:0}drawHorizontal(t,e,i,r){let{scale:s}=this;this.length=r,this.horizontal=!0,this.margin=this.calculateMargin(t,this.horizontal);let o=r-2*this.margin;o>0&&this.updateLabels(t,o);let a=0;for(let l=0;l<this.labels.length;l++){let d=t.measureText(this.labels[l],this.scaleFont);d.height>a&&(a=d.height)}let h=this.showScale?a+this.spaceBetweenMarkAndLabel+this.majorTickLength:0;if(i=i-h,this.x=e,this.y=i,this.logScale)for(let l=0;l<this.labelPositions.length;l++){let d=this.x+this.labelPositions[l],n=this.y,p=0;if(this.labelVisibilities[l]?p=this.majorTickLength:p=this.minorTickLength,this.labelVisibilities[l]||this.showMinorTicks){let g=Math.round(d)-s*.5;t.strokePath({path:new S(g,n).lineTo(g,n+p),color:this.foregroundColor,lineWidth:s*1,opacity:100/255})}this.labelVisibilities[l]&&t.fillText({x:d,y:this.y+this.spaceBetweenMarkAndLabel+this.majorTickLength,align:"center",baseline:"top",font:this.scaleFont,color:this.foregroundColor,text:this.labels[l]})}else for(let l=0;l<this.labels.length;l++){let d=e+this.labelPositions[l];this.labelVisibilities[l]&&t.fillText({x:d,y:i+this.majorTickLength+this.spaceBetweenMarkAndLabel,align:"center",baseline:"top",font:this.scaleFont,color:this.foregroundColor,text:this.labels[l]});let n=Math.round(d)-s*.5;t.strokePath({path:new S(n,i).lineTo(n,i+this.majorTickLength),color:this.foregroundColor,lineWidth:s*1,opacity:100/255}),this.showMinorTicks&&this.drawMinorXTicks(t,l,e,i)}return h}drawVertical(t,e,i,r,s,o=!1){let{scale:a}=this;this.length=r,this.horizontal=!1,this.margin=this.calculateMargin(t,this.horizontal);let h=r-2*this.margin;h>0&&this.updateLabels(t,h);let l=0;for(let n=0;n<this.labels.length;n++){let p=t.measureText(this.labels[n],this.scaleFont);p.width>l&&(l=p.width)}let d=this.showScale?l+this.spaceBetweenMarkAndLabel+this.majorTickLength:0;if(s||(e=e-d),this.x=e,this.y=i,this.logScale)for(let n=0;n<this.labelPositions.length;n++){let p;this.labelVisibilities[n]?p=this.majorTickLength:p=this.minorTickLength;let g=e+l+this.spaceBetweenMarkAndLabel-1*a+this.majorTickLength-p,v=Math.round(i+r-this.labelPositions[n])-a*.5;if((this.labelVisibilities[n]||this.showMinorTicks)&&t.strokePath({path:new S(g,v).lineTo(g+p,v),color:this.foregroundColor,lineWidth:a*1,opacity:100/255}),this.labelVisibilities[n]){let w=i+r-this.labelPositions[n];t.fillText({x:e,y:w,align:"left",baseline:"middle",font:this.scaleFont,color:this.foregroundColor,text:this.labels[n]})}}else for(let n=0;n<this.labels.length;n++){let p=i+r-this.labelPositions[n],g=Math.round(p)-a*.5;if(o){if(t.strokePath({path:new S(e,g).lineTo(e+this.majorTickLength,g),color:this.foregroundColor,lineWidth:a*1,opacity:100/255}),this.labelVisibilities[n]){let v=e+this.majorTickLength+this.spaceBetweenMarkAndLabel;t.fillText({x:v,y:p,align:"left",baseline:"middle",font:this.scaleFont,color:this.foregroundColor,text:this.labels[n]})}}else{this.labelVisibilities[n]&&t.fillText({x:e,y:p,align:"left",baseline:"middle",font:this.scaleFont,color:this.foregroundColor,text:this.labels[n]});let v=e+l+this.spaceBetweenMarkAndLabel-a*1;t.strokePath({path:new S(v,g).lineTo(v+this.majorTickLength,g),color:this.foregroundColor,lineWidth:a*1,opacity:100/255}),this.showMinorTicks&&this.drawMinorYTicks(t,n,v,i+r)}}return d}drawMinorXTicks(t,e,i,r){let{gridStepInPixel:s}=this,o,a;s/5>=this.minorTickMarkStepHint?(o=5,a=Math.floor(s/5)):s/4>=this.minorTickMarkStepHint?(o=4,a=Math.floor(s/4)):(o=2,a=Math.floor(s/2));let{labelPositions:h,minorTickLength:l,scale:d}=this;if(e>0)if(e===1&&h[1]-h[0]<s){let n=h[1];for(;n-h[0]>a+3*d;){n=n-a;let p=Math.round(i+n)-d*.5;t.strokePath({path:new S(p,r).lineTo(p,r+l),color:this.foregroundColor,lineWidth:d*1,opacity:100/255})}}else if(e===h.length-1&&h[e]-h[e-1]<s){let n=h[e-1];for(;h[e]-n>a+3*d;){n=n+a;let p=Math.round(i+n)-d*.5;t.strokePath({path:new S(p,r).lineTo(p,r+l),color:this.foregroundColor,lineWidth:d*1,opacity:100/255})}}else for(let n=0;n<o;n++){let p=i+h[e-1]+(h[e]-h[e-1])*n/o;p=Math.round(p)-d*.5,t.strokePath({path:new S(p,r).lineTo(p,r+l),color:this.foregroundColor,lineWidth:d*1,opacity:100/255})}}drawMinorYTicks(t,e,i,r){let{gridStepInPixel:s}=this,o,a;s/5>=this.minorTickMarkStepHint?(o=5,a=Math.floor(s/5)):s/4>=this.minorTickMarkStepHint?(o=4,a=Math.floor(s/4)):(o=2,a=Math.floor(s/2));let{labelPositions:h,minorTickLength:l,majorTickLength:d,scale:n}=this;if(e>0)if(e===1&&h[1]-h[0]<s){let p=h[1];for(;p-h[0]>a+3*n;){p-=a;let g=Math.round(r-p)-n*.5;t.strokePath({path:new S(i+d-l,g).lineTo(i+d,g),color:this.foregroundColor,lineWidth:n*1,opacity:100/255})}}else if(e===h.length-1&&h[e]-h[e-1]<s){let p=h[e-1];for(;h[e]-p>a+3*n;){p+=a;let g=Math.round(r-p)-n*.5;t.strokePath({path:new S(i+d-l,g).lineTo(i+d,g),color:this.foregroundColor,lineWidth:n*1,opacity:100/255})}}else for(let p=0;p<o;p++){let g=r-h[e-1]-(h[e]-h[e-1])*p/o;g=Math.round(g)-n*.5,t.strokePath({path:new S(i+d-l,g).lineTo(i+d,g),color:this.foregroundColor,lineWidth:n*1,opacity:100/255})}}updateLabels(t,e){if(this.labels=[],this.labelValues=[],this.labelPositions=[],this.showScale)if(this.logScale)this.updateLabelsForLogScale(this.minimum,this.maximum,e);else{let i=this.getGridStep(e,this.minimum,this.maximum),r=Math.max(Math.abs(this.minimum),Math.abs(this.maximum)),s=this.maximum/r-this.minimum/r;this.gridStepInPixel=Math.floor(e*(i/r)/s),this.updateLabelsForLinearScale(this.minimum,this.maximum,e,i)}this.updateVisibility(t)}getGridStep(t,e,i){t<=0&&(t=1);let r=!1;if(e>=i)if(i===e)i++;else{r=!0;let d=e;e=i,i=d}let s=Math.abs(i-e),o=this.majorTickStepHint;o>t&&(o=t);let a=s/t*o,h=0;if(a<1){if(a!=0)for(;a<1;)a*=10,h--}else for(;a>=10;)a/=10,h++;let l;return a>7.5?l=10*Math.pow(10,h):a>3.5?l=5*Math.pow(10,h):a>1.5?l=2*Math.pow(10,h):l=Math.pow(10,h),r&&(l=-l),l}updateLabelsForLogScale(t,e,i){t<=0&&(t=.1),e<=t&&(e=t+100);let r=e<t,s=Math.log10(t),o=Math.ceil(s),a=Math.ceil(Math.log10(e)),h=Math.pow(10,o-1),l;t%h<=0||r?l=t-t%h:l=t-t%h+h,r&&t>l?this.addMinMaxTickInfo(t,i,!0):!r&&t<l&&this.addMinMaxTickInfo(t,i,!0);for(let d=o;r?d>=a:d<=a;d+=r?-1:1)if(Math.abs(a-o)>20){let n=Math.pow(10,d);if(n>e)break;this.addTickInfo(n,e,s,i)}else{for(let n=l;(r?n>=Math.pow(10,d-1):n<=Math.pow(10,d))&&!(r?n<e:n>e);n=r?n-h:n+h)this.addTickInfo(n,e,s,i);h=r?h/Math.pow(10,1):h*Math.pow(10,1),l=r?Math.pow(10,d-1):h+Math.pow(10,d)}(r?e<this.labelValues[this.labelValues.length-1]:e>this.labelValues[this.labelValues.length-1])&&this.addMinMaxTickInfo(e,i,!1)}addMinMaxTickInfo(t,e,i){i?(this.labelValues.push(t),this.labels.push(this.format(t)),this.labelPositions.push(this.margin)):(this.labelValues.push(t),this.labels.push(this.format(t)),this.labelPositions.push(this.margin+e))}addTickInfo(t,e,i,r){this.labels.push(this.format(t));let s=Math.floor((Math.log10(t)-i)/(Math.log10(e)-i)*r)+this.margin;this.labelPositions.push(s),this.labelValues.push(t)}updateLabelsForLinearScale(t,e,i,r){let s=e<t,o;t%r<=0?o=t-t%r:o=t-t%r+r,t>o==s&&(this.labelValues.push(t),this.labels.push(this.format(t)),this.labelPositions.push(this.margin));let a=1,h=Math.max(Math.abs(t),Math.abs(e));e/=h,t/=h,r/=h,o/=h;let l=e-t;for(let d=o;e>=t?d<e:d>e;d=o+a++*r){let n=d*h;this.labels.push(this.format(n)),this.labelValues.push(n);let p=Math.floor((d-t)/l*i)+this.margin;this.labelPositions.push(p)}e*=h,this.labelValues.push(e),this.labels.push(this.format(e)),this.labelPositions.push(this.margin+i)}updateVisibility(t){if(this.labelVisibilities=[],!this.labelPositions.length)return;for(let r=0;r<this.labelPositions.length;r++)this.labelVisibilities.push(!0);let e=0,i=null;for(let r=0;r<this.labelPositions.length;r++){let s=!0,o=this.labels[r],a=this.labelPositions[r];r!==0&&(s=this.hasSpaceToDraw(t,e,a,i||"",o));let h=o===i&&r!==0&&r!==this.labelPositions.length-1,l=!0;if(this.logScale){let d=Number(this.labels[r]);l=this.isMajorTick(d)||r===0||r===this.labelPositions.length-1}!s||h||!l?this.labelVisibilities[r]=!1:(e=a,i=o)}}hasSpaceToDraw(t,e,i,r,s){let o=t.measureText(s,this.scaleFont),a=t.measureText(r,this.scaleFont),h=i-e,l=Math.floor(this.horizontal?o.width/2+a.width/2:o.height),d=!0,n=!0;if(i!=this.labelPositions[this.labelPositions.length-1]){d=h>l+this.tickLabelGap;let p=t.measureText(this.labels[this.labels.length-1],this.scaleFont);h=this.labelPositions[this.labelPositions.length-1]-i,l=Math.floor(this.horizontal?o.width/2+p.width/2:o.height),n=h>l+this.tickLabelGap}return d&&n}isMajorTick(t){if(!this.logScale)return!0;let e=Math.log10(t);return e===Math.round(e)}format(t){if(this.timeFormat===0)return this.scaleFormat?new Qt(this.scaleFormat).format(t):String(Number(t.toFixed(2)));let e=new Date(t),i=this.formatter;switch(this.timeFormat){case 1:return i.formatDate(e,{year:!0,month:!0,day:!0})+`
`+i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!1});case 2:return i.formatDate(e,{year:!0,month:!0,day:!0})+`
`+i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!0});case 3:return i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!1});case 4:return i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!0});case 5:return i.formatTime(e,{hours:!0,minutes:!0,seconds:!1,milliseconds:!1});case 6:return i.formatDate(e,{year:!0,month:!0,day:!0});case 7:let r=this.formatter.utc,s=zc[r?e.getUTCMonth():e.getMonth()],o=r?e.getUTCDate():e.getDate();return`${s} ${o}`;case 8:let a=Math.abs(this.maximum-this.minimum);return a<=5e3?i.formatTime(e,{hours:!1,minutes:!1,seconds:!0,milliseconds:!0}):a<=18e5?i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!1}):a<=864e5?i.formatTime(e,{hours:!0,minutes:!0,seconds:!1,milliseconds:!1}):a<=6048e5?i.formatDate(e,{year:!1,month:!0,day:!0})+`
`+i.formatTime(e,{hours:!0,minutes:!0,seconds:!1,milliseconds:!1}):a<=2592e6?i.formatDate(e,{year:!1,month:!0,day:!0}):i.formatDate(e,{year:!0,month:!0,day:!0})}return""}get spaceBetweenMarkAndLabel(){return this.scale*2}get majorTickLength(){return this.scale*6}get minorTickLength(){return this.scale*3}get minorTickMarkStepHint(){return this.scale*4}get tickLabelGap(){return this.horizontal?this.scale*10:this.scale*2}},Qa="color_map",th="crop_bottom",eh="crop_left",ih="crop_right",rh="crop_top",sh="data_height",oh="data_width",ah="font",hh="graph_area_height",lh="graph_area_width",nh="maximum",dh="minimum",uh="show_ramp",ph="x_axis_axis_color",ch="x_axis_axis_title",gh="x_axis_major_tick_step_hint",mh="x_axis_maximum",fh="x_axis_minimum",xh="x_axis_scale_font",wh="x_axis_show_minor_ticks",yh="x_axis_title_font",vh="x_axis_visible",bh="y_axis_axis_color",Th="y_axis_axis_title",Sh="y_axis_major_tick_step_hint",Vh="y_axis_maximum",Ch="y_axis_minimum",Ah="y_axis_scale_font",_h="y_axis_show_minor_ticks",Lh="y_axis_title_font",Ph="y_axis_visible",Uc=class extends G{constructor(t,e){super(t,e),this.properties.add(new Fe(Qa)),this.properties.add(new b(th)),this.properties.add(new b(eh)),this.properties.add(new b(ih)),this.properties.add(new b(rh)),this.properties.add(new b(sh)),this.properties.add(new b(oh)),this.properties.add(new b(hh)),this.properties.add(new b(lh)),this.properties.add(new O(ah)),this.properties.add(new H(nh)),this.properties.add(new H(dh)),this.properties.add(new y(uh)),this.properties.add(new R(ph)),this.properties.add(new _(ch)),this.properties.add(new b(gh)),this.properties.add(new H(mh)),this.properties.add(new H(fh)),this.properties.add(new O(xh)),this.properties.add(new y(wh)),this.properties.add(new O(yh)),this.properties.add(new y(vh)),this.properties.add(new R(bh)),this.properties.add(new _(Th)),this.properties.add(new b(Sh)),this.properties.add(new H(Vh)),this.properties.add(new H(Ch)),this.properties.add(new O(Ah)),this.properties.add(new y(_h)),this.properties.add(new O(Lh)),this.properties.add(new y(Ph))}draw(t){let{scale:e}=this,i=this.area;this.borderAlarmSensitive&&(i=U(i,2*e));let r=this.alarmSensitiveBackgroundColor;t.fillRect(A(C({},i),{color:r}));let{graphAreaWidth:s,graphAreaHeight:o}=this,a=0;this.xAxisVisible&&(a=t.measureText(this.xAxisAxisTitle,this.xAxisTitleFont).height);let h=0;this.yAxisVisible&&(h=t.measureText(this.yAxisAxisTitle,this.yAxisTitleFont).height);let l=new Tt(this.display.formatter,e,this.xAxisScaleFont,this.xAxisMinimum,this.xAxisMaximum,!1,this.xAxisMajorTickStepHint,this.xAxisAxisColor,this.xAxisShowMinorTicks,this.xAxisVisible),d=l.calculateMargin(t,!0),n=new Tt(this.display.formatter,e,this.yAxisScaleFont,this.yAxisMinimum,this.yAxisMaximum,!1,this.yAxisMajorTickStepHint,this.yAxisAxisColor,this.yAxisShowMinorTicks,this.yAxisVisible),p=n.calculateMargin(t,!1),g=l.measureHorizontalHeight(t),v=o+2*p,w=n.drawVertical(t,i.x+h,i.y,v,!0),T=s+2*d,B=i.x+h+w-d,M=i.y+v+g-p;l.drawHorizontal(t,B,M,T);let k=e*1,W=Math.round(i.x+h+w)-k/2,D=Math.round(i.y+p)-k/2;t.strokePath({path:new S(W,D).lineTo(W,D+o),color:this.yAxisAxisColor,opacity:100/255,lineWidth:k});let N=W,K=D+o+k;t.strokePath({path:new S(N,K).lineTo(N+s,K),color:this.xAxisAxisColor,opacity:100/255,lineWidth:k});let{dataWidth:J,dataHeight:ht,colorMap:tt}=this,{minimum:lt,maximum:st}=this,[Rt,Gt]=tt.getMinMax();if(this.value&&this.value.length){let et=document.createElement("canvas"),{cropLeft:nt,cropRight:gt,cropTop:mt,cropBottom:Et}=this;et.width=J-nt-gt,et.height=ht-mt-Et;let St=et.getContext("2d");for(let ut=nt;ut<J-gt;ut++)for(let ot=mt;ot<ht-Et;ot++){let pt=this.value[ot*J+ut];if(tt.autoscale){let Yt=(pt-lt)/(st-lt);pt=Rt+Yt*(Gt-Rt)}let[zt,Ut,qt]=tt.lookup(pt);St.fillStyle=`rgb(${zt},${Ut},${qt})`,St.fillRect(ut-nt,ot-mt,1,1)}let Vt=Math.round(i.x+h+w),ft=Math.round(i.y+n.margin);t.ctx.drawImage(et,Vt,ft,s,o)}if(this.showRamp){let et=new Tt(this.display.formatter,e,this.font,lt,st,!1,50*e,this.alarmSensitiveForegroundColor,!1,!0),nt=i.y+n.margin,gt=o,mt=et.drawVertical(t,i.x+i.width,nt,gt,!1,!0),Et=i.x+h+w+s+this.gap,St=i.width-h-w-s-mt-this.gap,Vt=gt-2*et.margin,ft=document.createElement("canvas");ft.width=St,ft.height=Vt;let ut=ft.getContext("2d");for(let ot=0;ot<Vt;ot++){let pt=st-ot/Vt*(st-lt);if(tt.autoscale){let Yt=(pt-lt)/(st-lt);pt=Rt+Yt*(Gt-Rt)}let[zt,Ut,qt]=tt.lookup(pt);ut.fillStyle=`rgb(${zt},${Ut},${qt})`,ut.fillRect(0,ot,St,1)}t.ctx.drawImage(ft,Et,nt+et.margin)}if(this.xAxisVisible){let et=i.x+w+s/2;this.yAxisVisible&&(et+=h),t.fillText({x:et,y:i.y+i.height,align:"center",baseline:"bottom",font:this.xAxisTitleFont,color:this.xAxisAxisColor,text:this.xAxisAxisTitle})}this.yAxisVisible&&(t.ctx.save(),t.ctx.translate(i.x+h/2,i.y+v/2),t.ctx.rotate(-Math.PI/2),t.fillText({x:0,y:0,align:"center",baseline:"middle",font:this.yAxisTitleFont,color:this.yAxisAxisColor,text:this.yAxisAxisTitle}),t.ctx.restore())}get gap(){return this.scale*3}get colorMap(){return this.properties.getValue(Qa)}get cropBottom(){return this.properties.getValue(th)}get cropLeft(){return this.properties.getValue(eh)}get cropRight(){return this.properties.getValue(ih)}get cropTop(){return this.properties.getValue(rh)}get dataHeight(){return this.properties.getValue(sh)}get dataWidth(){return this.properties.getValue(oh)}get font(){return this.properties.getValue(ah).scale(this.scale)}get graphAreaHeight(){return this.scale*this.properties.getValue(hh)}get graphAreaWidth(){return this.scale*this.properties.getValue(lh)}get maximum(){return this.properties.getValue(nh)}get minimum(){return this.properties.getValue(dh)}get showRamp(){return this.properties.getValue(uh)}get xAxisAxisColor(){return this.properties.getValue(ph)}get xAxisAxisTitle(){return this.properties.getValue(ch)}get xAxisMajorTickStepHint(){return this.scale*this.properties.getValue(gh)}get xAxisMaximum(){return this.properties.getValue(mh)}get xAxisMinimum(){return this.properties.getValue(fh)}get xAxisScaleFont(){return this.properties.getValue(xh).scale(this.scale)}get xAxisShowMinorTicks(){return this.properties.getValue(wh)}get xAxisTitleFont(){return this.properties.getValue(yh).scale(this.scale)}get xAxisVisible(){return this.properties.getValue(vh)}get yAxisAxisColor(){return this.properties.getValue(bh)}get yAxisAxisTitle(){return this.properties.getValue(Th)}get yAxisMajorTickStepHint(){return this.scale*this.properties.getValue(Sh)}get yAxisMaximum(){return this.properties.getValue(Vh)}get yAxisMinimum(){return this.properties.getValue(Ch)}get yAxisScaleFont(){return this.properties.getValue(Ah).scale(this.scale)}get yAxisShowMinorTicks(){return this.properties.getValue(_h)}get yAxisTitleFont(){return this.properties.getValue(Lh).scale(this.scale)}get yAxisVisible(){return this.properties.getValue(Ph)}},kh="bit",Mh="data_type",Rh="effect_3d",Eh="state_count",Wh="square_led",Bh="off_color",Ih="off_label",Hh="off_state",Dh="font",Nh="on_color",Fh="on_label",$h="on_state",Oh="bulb_border",Gh="bulb_border_color",zh="state_color_fallback",Uh="state_label_fallback",qh="show_boolean_label",qc=class extends G{areaRegion;states=[];constructor(t,e){super(t,e),this.properties.add(new b(kh)),this.properties.add(new b(Mh)),this.properties.add(new y(Rh)),this.properties.add(new y(Wh)),this.properties.add(new b(Eh,2)),this.properties.add(new R(Bh)),this.properties.add(new _(Ih)),this.properties.add(new _(Hh)),this.properties.add(new R(Nh)),this.properties.add(new _(Fh)),this.properties.add(new _($h)),this.properties.add(new O(Dh)),this.properties.add(new y(qh)),this.properties.add(new R(zh)),this.properties.add(new _(Uh)),this.properties.add(new b(Oh,3)),this.properties.add(new R(Gh,m.DARK_GRAY))}parseNode(t){if(super.parseNode(t),this.stateCount>2)for(let e=0;e<this.stateCount;e++){let i=new R(`state_color_${e}`);i.value=t.getColor(`state_color_${e}`),this.properties.add(i);let r=new _(`state_label_${e}`);r.value=t.getString(`state_label_${e}`),this.properties.add(r);let s=new H(`state_value_${e}`);s.value=t.getFloat(`state_value_${e}`),this.properties.add(s),this.states.push({label:this.properties.getValue(r.name),color:this.properties.getValue(i.name),value:this.properties.getValue(s.name)})}}init(){this.areaRegion={id:`${this.wuid}-area`,click:()=>{let t={pvName:this.pvName};this.display.fireEvent("openpv",t)},cursor:"pointer",tooltip:()=>this.tooltip}}get booleanValue(){return this.dataType===0?this.bit<0?!!(this.pv?.toNumber()??this.value):this.pv?.value!==void 0?(this.pv?.value>>this.bit&1)>0:this.value!==void 0?(this.value>>this.bit&1)>0:!1:this.dataType===1?(this.pv?.toString()??this.value)===this.onState:!1}get bulbColor(){if(this.stateCount<=2)return this.booleanValue?this.onColor:this.offColor;for(let t of this.states)if(t.value===(this.pv?.value??this.value))return t.color;return this.stateColorFallback}get label(){if(this.stateCount===2)return this.booleanValue?this.onLabel:this.offLabel;for(let t of this.states)if(t.value===(this.pv?.value??this.value))return t.label;return this.stateLabelFallback}draw(t){let e=U(this.bounds,3*this.scale);if(this.squareLed?this.effect3d?this.drawSquare3d(t,e):this.drawSquare2d(t,e):this.effect3d?this.drawCircle3d(t,e):this.drawCircle2d(t,e),this.showBooleanLabel){let i=this.bulbColor;i.red*299+i.green*587+i.blue*114>105e3?i=m.BLACK:i=m.WHITE,t.fillText({x:e.x+e.width/2,y:e.y+e.height/2,font:this.font,baseline:"middle",align:"center",color:i,text:this.label})}}drawCircle2d(t,e){let i=e.x+e.width/2,r=e.y+e.height/2,s=e.width/2,o=e.height/2;this.bulbBorder>0&&(s-=this.bulbBorder/2,o-=this.bulbBorder/2),t.fillEllipse({cx:i,cy:r,rx:s,ry:o,color:this.bulbColor}),t.strokeEllipse({cx:i,cy:r,rx:s,ry:o,color:this.bulbBorderColor,lineWidth:this.bulbBorder}),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addEllipse(i,r,s,o,0,0,2*Math.PI)}drawCircle3d(t,e){let i=e.x+e.width/2,r=e.y+e.height/2,s=e.width/2,o=e.height/2;t.fillEllipse({cx:i,cy:r,rx:s,ry:o,color:m.WHITE});let a=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);a.addColorStop(0,this.bulbBorderColor.toString()),a.addColorStop(1,this.bulbBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:i,cy:r,rx:s,ry:o,gradient:a});let h=e.width-2*this.bulbBorder,l=e.height-2*this.bulbBorder;s=h/2,o=l/2,t.fillEllipse({cx:i,cy:r,rx:s,ry:o,color:this.bulbColor}),a=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),a.addColorStop(0,m.WHITE.toString()),a.addColorStop(1,this.bulbBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:i,cy:r,rx:s,ry:o,gradient:a}),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addEllipse(i,r,s,o,0,0,2*Math.PI)}drawSquare2d(t,e){let i=Ft(e.x,e.y,e.width,e.height,this.bulbBorder);t.fillRect(A(C({},i),{color:this.bulbColor})),t.strokeRect(A(C({},i),{color:this.bulbBorderColor,lineWidth:this.bulbBorder})),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height)}drawSquare3d(t,e){t.fillRect(A(C({},e),{color:this.bulbBorderColor})),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height);let i=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y);i.addColorStop(0,"rgba(0,0,0,0.078)"),i.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:i,path:new S(e.x,e.y).lineTo(e.x+this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x,e.y+e.height)}),i=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),i.addColorStop(0,"rgba(0,0,0,0.078)"),i.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:i,path:new S(e.x,e.y).lineTo(e.x+this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+e.width-this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+e.width,e.y)}),i=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y),i.addColorStop(0,"rgba(255,255,255,0.078)"),i.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:i,path:new S(e.x+e.width,e.y).lineTo(e.x+e.width-this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+e.width-this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x+e.width,e.y+e.height)}),i=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),i.addColorStop(0,"rgba(255,255,255,0.078)"),i.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:i,path:new S(e.x,e.y+e.height).lineTo(e.x+this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x+e.width-this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x+e.width,e.y+e.height)});let r=e.x+this.bulbBorder,s=e.y+this.bulbBorder,o=e.width-2*this.bulbBorder,a=e.height-2*this.bulbBorder;t.fillRect({x:r,y:s,width:o,height:a,color:this.bulbColor}),i=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),i.addColorStop(0,"rgba(255,255,255,0.784)"),i.addColorStop(1,this.bulbColor.withAlpha(0).toString()),t.fillRect({x:r,y:s,width:o,height:a,gradient:i})}get bit(){return this.properties.getValue(kh)}get dataType(){return this.properties.getValue(Mh)}get squareLed(){return this.properties.getValue(Wh)}get showBooleanLabel(){return this.properties.getValue(qh)}get font(){return this.properties.getValue(Dh).scale(this.scale)}get effect3d(){return this.properties.getValue(Rh)}get stateCount(){return this.properties.getValue(Eh)}get bulbBorder(){return this.scale*this.properties.getValue(Oh)}get bulbBorderColor(){return this.properties.getValue(Gh)}get offLabel(){return this.properties.getValue(Ih)}get offColor(){return this.properties.getValue(Bh)}get offState(){return this.properties.getValue(Hh)}get onLabel(){return this.properties.getValue(Fh)}get onColor(){return this.properties.getValue(Nh)}get onState(){return this.properties.getValue($h)}get stateLabelFallback(){return this.properties.getValue(Uh)}get stateColorFallback(){return this.properties.getValue(zh)}},Yc=16,Xc=12,Kc=-5,jc=45,le=$(jc),Yh=(1-Math.sin(le)/2)/(2*Math.cos(le)),Xh="color_hi",Kh="color_hihi",jh="color_lo",Zh="color_lolo",Jh="font",Qh="level_hi",tl="level_hihi",el="level_lo",il="level_lolo",rl="log_scale",sl="minimum",ol="maximum",al="needle_color",hl="ramp_gradient",ll="scale_font",nl="show_hi",dl="show_hihi",ul="show_lo",pl="show_lolo",cl="show_ramp",gl="value_label_format",Zc=class extends G{areaRegion;constructor(t,e){super(t,e),this.properties.add(new R(Xh)),this.properties.add(new R(Kh)),this.properties.add(new R(jh)),this.properties.add(new R(Zh)),this.properties.add(new O(Jh)),this.properties.add(new b(Qh)),this.properties.add(new b(tl)),this.properties.add(new b(el)),this.properties.add(new b(il)),this.properties.add(new y(rl)),this.properties.add(new b(ol)),this.properties.add(new b(sl)),this.properties.add(new R(al)),this.properties.add(new y(hl)),this.properties.add(new O(ll)),this.properties.add(new y(nl)),this.properties.add(new y(dl)),this.properties.add(new y(ul)),this.properties.add(new y(pl)),this.properties.add(new y(cl,!0)),this.properties.add(new _(gl))}init(){this.areaRegion={id:`${this.wuid}-area`,click:()=>{let t={pvName:this.pvName};this.display.fireEvent("openpv",t)},tooltip:()=>this.tooltip,cursor:"pointer"}}draw(t){t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.backgroundColor}),this.showRamp&&this.drawRamp(t),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height)}drawRamp(t){let e=String(this.minimum),i=t.measureText(e,this.scaleFont),r=String(this.maximum),s=t.measureText(r,this.scaleFont),o=Math.max(i.width,s.width)/2,a=this.height,h=this.width;a>Yh*(h-2*o)&&(a=Math.floor(Yh*(h-2*o)));let l=a/(1-Math.sin(le)/2),d=Math.floor(this.x-l*(1-Math.cos(le))+o),n=this.y,p={x:d,y:n,width:Math.floor(2*l),height:Math.floor(2*l)},{rampWidth:g}=this,v=U(p,p.width/4-g,p.height/4-g);v.width=Math.min(v.width,v.height),v.height=v.width;let w=new Ud(g,135,45);w.lolo=this.levelLoLo,w.loloColor=this.colorLoLo,w.showLoLo=!0,w.lo=this.levelLo,w.loColor=this.colorLo,w.showLo=!0,w.hi=this.levelHi,w.hiColor=this.colorHi,w.showHi=!0,w.hihi=this.levelHiHi,w.hihiColor=this.colorHiHi,w.showHiHi=!0,w.minimum=this.minimum,w.maximum=this.maximum,w.gradient=this.rampGradient,w.logScale=this.logScale,w.draw(t,p,v),this.drawNeedle(t,p,w);let T=it.ARIAL_12_BOLD.scale(this.scale);if(this.pv&&this.pv.value!==void 0){let B=this.format(this.pv.value),M=t.measureText(B,T);t.fillText({x:p.x+p.width/2-M.width/2,y:p.y+p.height/2-p.height/4-(w.getRadius()-p.height/4)/2-M.height/2,align:"left",baseline:"top",font:T,text:B,color:this.foregroundColor})}}drawNeedle(t,e,i){let r=e.x+e.width/2,s=e.y+e.height/2,o;if(this.pv&&this.pv.value!==void 0){let v=i.getValueInRange(this.pv.value);o=360-i.getValuePosition(v),this.maximum>this.minimum?v>this.maximum?o+=8:v<this.minimum&&(o-=8):v>this.minimum?o-=8:v<this.maximum&&(o+=8)}else o=360-i.getValuePosition(this.minimum+this.maximum/2);let a=$(o),{needleWidth:h,gapBetweenNeedleScale:l,scale:d}=this,n=$t(r+e.width/4,s-h/2+3*d,r,s,a),p=$t(r+i.getRadius()-l,s,r,s,a),g=$t(r+e.width/4,s+h/2-3*d,r,s,a);t.fillPath({color:this.needleColor,path:new S(n.x,n.y).lineTo(p.x,p.y).lineTo(g.x,g.y).closePath()})}get needleWidth(){return this.scale*Yc}get gapBetweenNeedleScale(){return this.scale*Kc}get rampWidth(){return this.scale*Xc}format(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(2)))}get colorLo(){return this.properties.getValue(jh)}get colorLoLo(){return this.properties.getValue(Zh)}get colorHi(){return this.properties.getValue(Xh)}get colorHiHi(){return this.properties.getValue(Kh)}get font(){return this.properties.getValue(Jh).scale(this.scale)}get levelLo(){return this.properties.getValue(el)}get levelLoLo(){return this.properties.getValue(il)}get levelHi(){return this.properties.getValue(Qh)}get levelHiHi(){return this.properties.getValue(tl)}get logScale(){return this.properties.getValue(rl)}get minimum(){return this.properties.getValue(sl)}get maximum(){return this.properties.getValue(ol)}get needleColor(){return this.properties.getValue(al)}get rampGradient(){return this.properties.getValue(hl)}get scaleFont(){return this.properties.getValue(ll).scale(this.scale)}get showLo(){return this.properties.getValue(ul)}get showLoLo(){return this.properties.getValue(pl)}get showHi(){return this.properties.getValue(nl)}get showHiHi(){return this.properties.getValue(dl)}get showRamp(){return this.properties.getValue(cl)}get valueLabelFormat(){return this.properties.getValue(gl)}},ml="color_hi",fl="color_hihi",xl="color_lo",wl="color_lolo",yl="color_fillbackground",vl="effect_3d",bl="fill_color",Tl="fillcolor_alarm_sensitive",Sl="font",Vl="horizontal",Cl="indicator_mode",Al="level_hi",_l="level_hihi",Ll="level_lo",Pl="level_lolo",kl="limits_from_pv",Ml="log_scale",Rl="maximum",El="major_tick_step_hint",Wl="minimum",Bl="origin",Il="origin_ignored",Hl="scale_font",Dl="scale_format",Nl="show_hi",Fl="show_hihi",$l="show_label",Ol="show_lo",Gl="show_lolo",zl="show_markers",Ul="show_minor_ticks",ql="show_scale",Yl="transparent_background",Xl="value_label_format",Jc=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(ml)),this.properties.add(new R(fl)),this.properties.add(new R(xl)),this.properties.add(new R(wl)),this.properties.add(new R(yl)),this.properties.add(new y(vl)),this.properties.add(new R(bl)),this.properties.add(new y(Tl,!1)),this.properties.add(new O(Sl)),this.properties.add(new y(Vl)),this.properties.add(new y(Cl)),this.properties.add(new H(Al)),this.properties.add(new H(_l)),this.properties.add(new H(Ll)),this.properties.add(new H(Pl)),this.properties.add(new y(kl)),this.properties.add(new y(Ml)),this.properties.add(new H(Rl)),this.properties.add(new H(El)),this.properties.add(new H(Wl)),this.properties.add(new H(Bl,0)),this.properties.add(new y(Il,!0)),this.properties.add(new O(Hl)),this.properties.add(new _(Dl)),this.properties.add(new y(Nl)),this.properties.add(new y(Fl)),this.properties.add(new y($l)),this.properties.add(new y(Ol)),this.properties.add(new y(Gl)),this.properties.add(new y(zl)),this.properties.add(new y(Ul)),this.properties.add(new y(ql)),this.properties.add(new y(Yl)),this.properties.add(new _(Xl))}draw(t){let e=this.area;this.borderAlarmSensitive&&(e=U(this.area,2*this.scale));let i=this.alarmSensitiveBackgroundColor;this.transparentBackground||t.fillRect(A(C({},e),{color:i})),this.horizontal?this.drawHorizontal(t,e):this.drawVertical(t,e)}drawVertical(t,e){let i=this.alarmSensitiveForegroundColor,r=new Tt(this.display.formatter,this.scale,this.scaleFont,this.min,this.max,this.logScale,this.majorTickStepHint,i,this.showMinorTicks,this.showScale);r.scaleFormat=this.scaleFormat;let s=r.drawVertical(t,e.x,e.y,e.height,!0),o=0;this.showMarkers&&(o=this.drawVerticalMarkers(t,r,e)),this.drawVerticalBar(t,r,{x:e.x+s,y:e.y+r.margin,width:e.width-s-o,height:e.height-2*r.margin})}drawVerticalMarkers(t,e,i){let{lolo:r,lo:s,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=0;if(this.showLoLo&&r!==void 0){let n=t.measureText("LOLO",h);l=Math.max(l,n.width)}if(this.showLo&&s!==void 0){let n=t.measureText("LO",h);l=Math.max(l,n.width)}if(this.showHi&&o!==void 0){let n=t.measureText("HI",h);l=Math.max(l,n.width)}if(this.showHiHi&&a!==void 0){let n=t.measureText("HIHI",h);l=Math.max(l,n.width)}let d=i.x+i.width;if(this.showLoLo&&r!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(r));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"LOLO",align:"left",baseline:"middle",color:this.colorLoLo,font:h})}if(this.showLo&&s!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(s));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"LO",align:"left",baseline:"middle",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(o));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"HI",align:"left",baseline:"middle",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(a));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"HIHI",align:"left",baseline:"middle",color:this.colorHiHi,font:h})}return this.markerTickLength+this.markerGap+l}drawVerticalBar(t,e,i){let{outlineWidth:r}=this;if(t.fillRect(A(C({},i),{color:this.colorFillbackground})),this.effect3d){let a=t.createLinearGradient(i.x,0,i.x+i.width,0);a.addColorStop(0,m.WHITE.toString()),a.addColorStop(1,this.colorFillbackground.withAlpha(0).toString()),t.fillRect(A(C({},i),{gradient:a}));let h=U(i,r/2);t.strokeRect(A(C({},h),{color:m.GRAY,lineWidth:r}))}let s=this.alarmSensitiveFillColor;if(this.indicatorMode){let a=Math.round(e.getValuePosition(this.getFillValue())),h=i.width,l=this.thumbBreadth,d=se([{x:0,y:l/2},{x:h/2,y:0},{x:h-1,y:l/2},{x:h/2,y:l}],i.x,a-l/2),n=S.fromPoints(d);if(this.effect3d){let{x:p,y:g}=d[0],{x:v,y:w}=d[2],T=t.createLinearGradient(p,g,v,w);T.addColorStop(0,m.WHITE.toString()),T.addColorStop(1,s.toString()),t.fillPath({path:n,gradient:T}),t.strokePath({path:n,color:m.GRAY,lineWidth:r})}else t.fillPath({path:n,color:s})}else{let a=this.originIgnored?this.min:this.origin,h=this.getFillValue();if(h<a){let p=a;a=h,h=p}let l=Math.round(e.getValuePosition(a)),d=Math.round(e.getValuePosition(h)),n=U(A(C({},i),{y:l,height:d-l}),r);if(t.fillRect(A(C({},n),{color:s})),this.effect3d){let p=t.createLinearGradient(n.x,0,n.x+n.width,0);p.addColorStop(0,m.WHITE.toString()),p.addColorStop(1,s.withAlpha(0).toString()),t.fillRect(A(C({},n),{gradient:p}))}}let o=this.pv?.value;this.showLabel&&o!==void 0&&t.fillText({x:i.x+i.width/2,y:i.y+i.height/2,align:"center",baseline:"middle",color:this.alarmSensitiveForegroundColor,font:this.font,text:this.format(o)})}drawHorizontal(t,e){let i=this.alarmSensitiveForegroundColor,r=new Tt(this.display.formatter,this.scale,this.scaleFont,this.min,this.max,this.logScale,this.majorTickStepHint,i,this.showMinorTicks,this.showScale);r.scaleFormat=this.scaleFormat;let s=r.drawHorizontal(t,e.x,e.y+e.height,e.width),o=0;this.showMarkers&&(o=this.drawHorizontalMarkers(t,r,e)),this.drawHorizontalBar(t,r,{x:e.x+r.margin,y:e.y+o,width:e.width-2*r.margin,height:e.height-s-o})}drawHorizontalMarkers(t,e,i){let{lolo:r,lo:s,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=0;if(this.showLoLo&&r!==void 0){let n=t.measureText("LOLO",h);l=Math.max(l,n.height)}if(this.showLo&&s!==void 0){let n=t.measureText("LO",h);l=Math.max(l,n.height)}if(this.showHi&&o!==void 0){let n=t.measureText("HI",h);l=Math.max(l,n.height)}if(this.showHiHi&&a!==void 0){let n=t.measureText("HIHI",h);l=Math.max(l,n.height)}let d=i.y;if(this.showLoLo&&r!==void 0){let n=Math.round(e.getValuePosition(r)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"LOLO",align:"center",baseline:"top",color:this.colorLoLo,font:h})}if(this.showLo&&s!==void 0){let n=Math.round(e.getValuePosition(s)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"LO",align:"center",baseline:"top",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let n=Math.round(e.getValuePosition(o)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"HI",align:"center",baseline:"top",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let n=Math.round(e.getValuePosition(a)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"HIHI",align:"center",baseline:"top",color:this.colorHiHi,font:h})}return this.markerTickLength+this.markerGap+l}drawHorizontalBar(t,e,i){let{outlineWidth:r}=this;if(t.fillRect(A(C({},i),{color:this.colorFillbackground})),this.effect3d){let a=t.createLinearGradient(0,i.y,0,i.y+i.height);a.addColorStop(0,m.WHITE.toString()),a.addColorStop(1,this.colorFillbackground.withAlpha(0).toString()),t.fillRect(A(C({},i),{gradient:a}));let h=U(i,r/2);t.strokeRect(A(C({},h),{color:m.GRAY,lineWidth:r}))}let s=this.alarmSensitiveFillColor;if(this.indicatorMode){let a=Math.round(e.getValuePosition(this.getFillValue())),h=i.height,l=this.thumbBreadth,d=se([{x:l/2,y:0},{x:l,y:h/2},{x:l/2,y:h-1},{x:0,y:h/2}],a-l/2,i.y),n=S.fromPoints(d);if(this.effect3d){let{x:p,y:g}=d[0],{x:v,y:w}=d[2],T=t.createLinearGradient(p,g,v,w);T.addColorStop(0,m.WHITE.toString()),T.addColorStop(1,s.toString()),t.fillPath({path:n,gradient:T}),t.strokePath({path:n,color:m.GRAY,lineWidth:r})}else t.fillPath({path:n,color:s})}else{let a=this.originIgnored?this.min:this.origin,h=this.getFillValue();if(h<a){let p=a;a=h,h=p}let l=Math.round(e.getValuePosition(a)),d=Math.round(e.getValuePosition(h)),n=U(A(C({},i),{x:l,width:d-l}),r);if(t.fillRect(A(C({},n),{color:s})),this.effect3d){let p=t.createLinearGradient(0,n.y,0,n.y+n.height);p.addColorStop(0,m.WHITE.toString()),p.addColorStop(1,s.withAlpha(0).toString()),t.fillRect(A(C({},n),{gradient:p}))}}let o=this.pv?.value;this.showLabel&&o!==void 0&&t.fillText({x:i.x+i.width/2,y:i.y+i.height/2,align:"center",baseline:"middle",color:this.alarmSensitiveForegroundColor,font:this.font,text:this.format(o)})}get min(){return this.limitsFromPv?this.pv?.lowerDisplayLimit??this.minimum:this.minimum}get max(){return this.limitsFromPv?this.pv?.upperDisplayLimit??this.maximum:this.maximum}get lolo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerAlarmLimit:this.levelLoLo}get lo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerWarningLimit:this.levelLo}get hi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperWarningLimit:this.levelHi}get hihi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperAlarmLimit:this.levelHiHi}get markerTickLength(){return this.scale*10}get markerTickLineWidth(){return this.scale*2}get markerGap(){return this.scale*3}get thumbBreadth(){return this.scale*13}get outlineWidth(){return this.scale*1}get alarmSensitiveFillColor(){if(this.fillColorAlarmSensitive){if(this.isMajorSeverity())return m.RED;if(this.isMinorSeverity())return m.ORANGE}return this.fillColor}getFillValue(){let t=this.pv?.value??this.min;return t=Math.max(this.min,t),t=Math.min(this.max,t),t}format(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(2)))}get colorLo(){return this.properties.getValue(xl)}get colorLoLo(){return this.properties.getValue(wl)}get colorHi(){return this.properties.getValue(ml)}get colorHiHi(){return this.properties.getValue(fl)}get colorFillbackground(){return this.properties.getValue(yl)}get effect3d(){return this.properties.getValue(vl)}get fillColorAlarmSensitive(){return this.properties.getValue(Tl)}get fillColor(){return this.properties.getValue(bl)}get font(){return this.properties.getValue(Sl).scale(this.scale)}get horizontal(){return this.properties.getValue(Vl)}get indicatorMode(){return this.properties.getValue(Cl)}get levelLo(){return this.properties.getValue(Ll)}get levelLoLo(){return this.properties.getValue(Pl)}get levelHi(){return this.properties.getValue(Al)}get levelHiHi(){return this.properties.getValue(_l)}get limitsFromPv(){return this.properties.getValue(kl)}get logScale(){return this.properties.getValue(Ml)}get minimum(){return this.properties.getValue(Wl)}get majorTickStepHint(){return this.scale*this.properties.getValue(El)}get maximum(){return this.properties.getValue(Rl)}get origin(){return this.properties.getValue(Bl)}get originIgnored(){return this.properties.getValue(Il)}get scaleFont(){return this.properties.getValue(Hl).scale(this.scale)}get scaleFormat(){return this.properties.getValue(Dl)}get showHi(){return this.properties.getValue(Nl)}get showHiHi(){return this.properties.getValue(Fl)}get showLabel(){return this.properties.getValue($l)}get showLo(){return this.properties.getValue(Ol)}get showLoLo(){return this.properties.getValue(Gl)}get showMarkers(){return this.properties.getValue(zl)}get showMinorTicks(){return this.properties.getValue(Ul)}get showScale(){return this.properties.getValue(ql)}get transparentBackground(){return this.properties.getValue(Yl)}get valueLabelFormat(){return this.properties.getValue(Xl)}},Kl="color_hi",jl="color_hihi",Zl="color_lo",Jl="color_lolo",Ql="color_fillbackground",tn="fill_color",en="fillcolor_alarm_sensitive",rn="effect_3d",sn="level_hi",on="level_hihi",an="level_lo",hn="level_lolo",ln="limits_from_pv",nn="log_scale",dn="maximum",un="major_tick_step_hint",pn="minimum",cn="scale_font",gn="scale_format",mn="show_hi",fn="show_hihi",xn="show_lo",wn="show_lolo",yn="show_markers",vn="show_minor_ticks",bn="show_scale",Tn="transparent_background",Qc=new m(160,160,160),tg=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(Kl)),this.properties.add(new R(jl)),this.properties.add(new R(Zl)),this.properties.add(new R(Jl)),this.properties.add(new R(Ql)),this.properties.add(new y(rn)),this.properties.add(new R(tn)),this.properties.add(new y(en,!1)),this.properties.add(new H(sn)),this.properties.add(new H(on)),this.properties.add(new H(an)),this.properties.add(new H(hn)),this.properties.add(new y(ln)),this.properties.add(new y(nn)),this.properties.add(new H(dn)),this.properties.add(new H(un)),this.properties.add(new H(pn)),this.properties.add(new O(cn)),this.properties.add(new _(gn)),this.properties.add(new y(mn)),this.properties.add(new y(fn)),this.properties.add(new y(xn)),this.properties.add(new y(wn)),this.properties.add(new y(yn)),this.properties.add(new y(vn)),this.properties.add(new y(bn)),this.properties.add(new y(Tn))}draw(t){let{scale:e,min:i,max:r}=this,s=this.area;this.borderAlarmSensitive&&(s=U(s,2*e));let o=this.alarmSensitiveBackgroundColor;this.transparentBackground||t.fillRect(A(C({},s),{color:o}));let a=this.alarmSensitiveForegroundColor,h=new Tt(this.display.formatter,e,this.scaleFont,i,r,this.logScale,this.majorTickStepHint,a,this.showMinorTicks,this.showScale);h.scaleFormat=this.scaleFormat;let l=h.drawVertical(t,s.x,s.y,s.height,!0),d=0;this.showMarkers&&(d=this.drawMarkers(t,s,h)),this.drawTank(t,s,l,d,h)}drawMarkers(t,e,i){let{lolo:r,lo:s,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=0;if(this.showLoLo&&r!==void 0){let n=t.measureText("LOLO",h);l=Math.max(l,n.width)}if(this.showLo&&s!==void 0){let n=t.measureText("LO",h);l=Math.max(l,n.width)}if(this.showHi&&o!==void 0){let n=t.measureText("HI",h);l=Math.max(l,n.width)}if(this.showHiHi&&a!==void 0){let n=t.measureText("HIHI",h);l=Math.max(l,n.width)}let d=e.x+e.width-l-this.markerGap-this.markerTickLength;if(this.showLoLo&&r!==void 0){let n=Math.round(i.getValuePosition(r));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"LOLO",align:"left",baseline:"middle",color:this.colorLoLo,font:h})}if(this.showLo&&s!==void 0){let n=Math.round(i.getValuePosition(s));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"LO",align:"left",baseline:"middle",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let n=Math.round(i.getValuePosition(o));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"HI",align:"left",baseline:"middle",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let n=Math.round(i.getValuePosition(a));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"HIHI",align:"left",baseline:"middle",color:this.colorHiHi,font:h})}return this.markerTickLength+this.markerGap+l}drawTank(t,e,i,r,s){let o=this.alarmSensitiveForegroundColor,{scale:a,outlineWidth:h}=this,l=e.x+i,d=e.y+s.margin,n=e.width-i-r,p=e.height-2*s.margin,g=this.defaultCorner,v=11/20;n<2*g&&(v=12/20);let w=Math.floor(n*v);g>2*w-n-2*h&&(g=2*w-n);let T=s.getValuePosition(this.getFillValue()),B=this.alarmSensitiveFillColor;if(this.effect3d){t.fillRect({x:l,y:d,width:n,height:p,rx:g/2,ry:g/2,color:m.WHITE});let k=t.createLinearGradient(l,d,l+w+2*a,d);k.addColorStop(0,this.colorFillbackground.toString()),k.addColorStop(1,m.WHITE.withAlpha(0).toString()),t.fillRect({x:l,y:d,width:w,height:p,rx:g/2,ry:g/2,gradient:k}),k=t.createLinearGradient(l+n-w-2*a,d,l+n,d),k.addColorStop(0,m.WHITE.withAlpha(0).toString()),k.addColorStop(1,this.colorFillbackground.toString()),t.fillRect({x:l+n-w,y:d,width:w,height:p,rx:g/2,ry:g/2,gradient:k});let W=T,D=d+p-T;k=t.createLinearGradient(l,W,l+w+2*a,W),k.addColorStop(0,B.toString()),k.addColorStop(1,m.WHITE.withAlpha(0).toString()),t.fillRect({x:l,y:W,width:w,height:D,rx:g/2,ry:g/2,gradient:k}),k=t.createLinearGradient(l+n-w-2*a,W,l+n,W),k.addColorStop(0,m.WHITE.withAlpha(0).toString()),k.addColorStop(1,B.toString()),t.fillRect({x:l+n-w,y:W,width:w,height:D,rx:g/2,ry:g/2,gradient:k})}else t.fillRect({x:l,y:d,width:n,height:p,rx:g/2,ry:g/2,color:this.colorFillbackground}),t.fillRect({x:l,y:T,width:n,height:d+p-T,rx:g/2,ry:g/2,color:B});let M=U({x:l,y:d,width:n,height:p},h/2);t.strokeRect(A(C({},M),{rx:g/2,ry:g/2,color:this.effect3d?Qc:o,lineWidth:h}))}get min(){return this.limitsFromPv?this.pv?.lowerDisplayLimit??this.minimum:this.minimum}get max(){return this.limitsFromPv?this.pv?.upperDisplayLimit??this.maximum:this.maximum}get lolo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerAlarmLimit:this.levelLoLo}get lo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerWarningLimit:this.levelLo}get hi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperWarningLimit:this.levelHi}get hihi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperAlarmLimit:this.levelHiHi}get defaultCorner(){return this.scale*15}get markerTickLength(){return this.scale*10}get markerTickLineWidth(){return this.scale*2}get markerGap(){return this.scale*3}get outlineWidth(){return this.scale*1}get alarmSensitiveFillColor(){if(this.fillColorAlarmSensitive){if(this.isMajorSeverity())return m.RED;if(this.isMinorSeverity())return m.ORANGE}return this.fillColor}getFillValue(){let t=this.pv?.value??this.min;return t=Math.max(this.min,t),t=Math.min(this.max,t),t}get colorLo(){return this.properties.getValue(Zl)}get colorLoLo(){return this.properties.getValue(Jl)}get colorHi(){return this.properties.getValue(Kl)}get colorHiHi(){return this.properties.getValue(jl)}get colorFillbackground(){return this.properties.getValue(Ql)}get fillColorAlarmSensitive(){return this.properties.getValue(en)}get fillColor(){return this.properties.getValue(tn)}get effect3d(){return this.properties.getValue(rn)}get levelLo(){return this.properties.getValue(an)}get levelLoLo(){return this.properties.getValue(hn)}get levelHi(){return this.properties.getValue(sn)}get levelHiHi(){return this.properties.getValue(on)}get limitsFromPv(){return this.properties.getValue(ln)}get logScale(){return this.properties.getValue(nn)}get minimum(){return this.properties.getValue(pn)}get majorTickStepHint(){return this.scale*this.properties.getValue(un)}get maximum(){return this.properties.getValue(dn)}get scaleFont(){return this.properties.getValue(cn).scale(this.scale)}get scaleFormat(){return this.properties.getValue(gn)}get showLo(){return this.properties.getValue(xn)}get showLoLo(){return this.properties.getValue(wn)}get showHi(){return this.properties.getValue(mn)}get showHiHi(){return this.properties.getValue(fn)}get showMarkers(){return this.properties.getValue(yn)}get showMinorTicks(){return this.properties.getValue(vn)}get showScale(){return this.properties.getValue(bn)}get transparentBackground(){return this.properties.getValue(Tn)}},Sn="font",Vn="format_type",Cn="horizontal_alignment",An="precision",_n="precision_from_pv",Ln="show_units",Pn="vertical_alignment",eg=class extends G{areaRegion;constructor(t,e){super(t,e),this.properties.add(new O(Sn)),this.properties.add(new b(Vn)),this.properties.add(new b(Cn)),this.properties.add(new b(An)),this.properties.add(new y(_n)),this.properties.add(new y(Ln,!0)),this.properties.add(new b(Pn))}init(){this.areaRegion={id:`${this.wuid}-area`,click:()=>{let t={pvName:this.pvName};this.display.fireEvent("openpv",t)},tooltip:()=>this.tooltip,cursor:"pointer"}}draw(t){let e=t.ctx;this.backgroundAlarmSensitive&&this.alarm?t.fillRect(A(C({},this.area),{color:this.alarmSensitiveBackgroundColor})):this.transparent||t.fillRect(A(C({},this.area),{color:this.backgroundColor})),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height),e.fillStyle=this.alarmSensitiveForegroundColor.toString(),e.font=this.font.getFontString();let{scale:i}=this,r=this.area;this.borderAlarmSensitive&&(r=U(r,2*i,2*i));let s=r.x;this.horizAlignment===0?e.textAlign="start":this.horizAlignment===1?(s+=r.width/2,e.textAlign="center"):this.horizAlignment===2&&(s+=r.width,e.textAlign="end");let o=r.y;this.vertAlignment===0?e.textBaseline="top":this.vertAlignment===1?(o=o+r.height/2,e.textBaseline="middle"):this.vertAlignment===2&&(o=o+r.height,e.textBaseline="bottom");let a=this.text;if(this.pv?.value!==void 0){let h=this.precisionFromPV?this.pv.precision:this.precision;h===-1&&(h=this.pv.precision??-1),a=ae(this.pv.value,this.formatType,h)}else this.value!==void 0&&(a=ae(this.value,this.formatType,this.precision));this.showUnits&&this.pv?.units&&(a+=" "+this.pv.units),e.fillText(a,s,o)}get font(){return this.properties.getValue(Sn).scale(this.scale)}get formatType(){return this.properties.getValue(Vn)}get horizAlignment(){return this.properties.getValue(Cn)}get precision(){return this.properties.getValue(An)}get precisionFromPV(){return this.properties.getValue(_n)}get showUnits(){return this.properties.getValue(Ln)}get vertAlignment(){return this.properties.getValue(Pn)}},kn="color_hi",Mn="color_hihi",Rn="color_lo",En="color_lolo",Wn="color_fillbackground",Bn="fill_color",In="fillcolor_alarm_sensitive",Hn="font",Dn="effect_3d",Nn="level_hi",Fn="level_hihi",$n="level_lo",On="level_lolo",Gn="limits_from_pv",zn="log_scale",Un="maximum",qn="major_tick_step_hint",Yn="minimum",Xn="scale_font",Kn="scale_format",jn="show_bulb",Zn="show_hi",Jn="show_hihi",Qn="show_lo",td="show_lolo",ed="show_markers",id="show_minor_ticks",rd="show_scale",sd="transparent_background",od="unit",ad="value_label_format",hd=new m(160,160,160),ig=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(kn)),this.properties.add(new R(Mn)),this.properties.add(new R(Rn)),this.properties.add(new R(En)),this.properties.add(new R(Wn)),this.properties.add(new R(Bn)),this.properties.add(new y(In,!1)),this.properties.add(new y(Dn)),this.properties.add(new H(Nn)),this.properties.add(new H(Fn)),this.properties.add(new H($n)),this.properties.add(new H(On)),this.properties.add(new y(Gn)),this.properties.add(new O(Hn)),this.properties.add(new y(zn)),this.properties.add(new H(Un)),this.properties.add(new H(qn)),this.properties.add(new H(Yn)),this.properties.add(new O(Xn)),this.properties.add(new _(Kn)),this.properties.add(new y(jn)),this.properties.add(new y(Zn)),this.properties.add(new y(Jn)),this.properties.add(new y(Qn)),this.properties.add(new y(td)),this.properties.add(new y(ed)),this.properties.add(new y(id)),this.properties.add(new y(rd)),this.properties.add(new y(sd)),this.properties.add(new b(od)),this.properties.add(new _(ad))}draw(t){let{scale:e,min:i,max:r}=this,s=this.area;this.borderAlarmSensitive&&(s=U(this.area,2*this.scale));let o=this.alarmSensitiveBackgroundColor,a=this.alarmSensitiveForegroundColor,h=this.alarmSensitiveFillColor;this.transparentBackground||t.fillRect(A(C({},s),{color:o}));let l=s.height;if(this.showBulb){let M=Math.min(s.width/2,this.bulbMaxDiameter);l=s.height<M?0:s.height-M}let d=A(C({},s),{height:l}),n=new Tt(this.display.formatter,e,this.scaleFont,i,r,this.logScale,this.majorTickStepHint,a,this.showMinorTicks,this.showScale);n.scaleFormat=this.scaleFormat;let p=0,g="";if(this.unit===0?g="\xB0C":this.unit===1?g="\xB0F":this.unit===2&&(g="K"),g){let M=it.ARIAL_9.scale(e),k=t.measureText(g,M),W=2*e;p=k.height+2*W,t.fillText({x:s.x+s.width/2-this.pipeWidth/2-W,y:s.y+W,baseline:"top",align:"right",color:a,font:M,text:g})}let v=d.x+d.width/2-this.pipeWidth/2-1*e,w=A(C({},d),{y:d.y+p,height:d.height-p+n.calculateMargin(t,!1)}),T=n.drawVertical(t,v,w.y,w.height,!1),B=Math.floor(this.pipeWidth/2);if(d=A(C({},d),{y:n.getValuePosition(r)-B,height:n.scaleLength+2*B}),this.drawPipe(t,d,n),this.showMarkers&&this.drawMarkers(t,s,n),this.showBulb){let M=Math.min(s.width/2,this.bulbMaxDiameter),k=1*e,W=s.x+s.width/2,D=s.y+l+M/2,N=M/2,K=M/2;if(t.fillEllipse({cx:W,cy:D,rx:N,ry:K,color:h}),this.effect3d){let tt=t.createLinearGradient(W-N,D-K,W+N,D+K);tt.addColorStop(0,m.WHITE.toString()),tt.addColorStop(1,h.withAlpha(0).toString()),t.fillEllipse({cx:W,cy:D,rx:N,ry:K,gradient:tt})}t.strokeEllipse({cx:W,cy:D,rx:N-k/2,ry:K-k/2,color:this.effect3d?hd:a,lineWidth:k});let J={x:Math.round(d.x+d.width/2-this.pipeWidth/2)+this.outlineWidth,y:Math.floor(n.getValuePosition(i)),width:this.pipeWidth-2*this.outlineWidth,height:e*3};if(this.effect3d){let tt=Math.round(d.x+d.width/2-this.pipeWidth/2),lt=tt+this.pipeWidth,st=t.createLinearGradient(tt,J.y,lt,J.y);st.addColorStop(0,m.WHITE.toString()),st.addColorStop(1,h.toString()),t.fillRect(A(C({},J),{gradient:st}))}else t.fillRect(A(C({},J),{color:h}));let ht=this.pv?.value;ht&&t.fillText({x:W,y:D,align:"center",baseline:"middle",color:h.contrast(),font:this.font,text:this.format(ht)})}}drawPipe(t,e,i){let{scale:r,outlineWidth:s,min:o,max:a}=this,h=this.alarmSensitiveForegroundColor,l=this.alarmSensitiveFillColor,d={x:Math.round(e.x+e.width/2-this.pipeWidth/2),y:e.y,width:this.pipeWidth,height:e.height},n=this.getFillValue(),p=i.getValuePosition(n);a>o?n>a?p-=10*r:n<o&&(p+=10*r):n>o?p+=10*r:n<a&&(p-=10*r);let g=this.pipeWidth/2,{x:v,y:w,width:T,height:B}=d;if(this.effect3d){let k=t.createLinearGradient(v,w,v+T,w);k.addColorStop(0,m.WHITE.toString()),k.addColorStop(1,this.colorFillbackground.toString()),t.fillRect(A(C({},d),{rx:g/2,ry:g/2,gradient:k})),k=t.createLinearGradient(v,w,v+T,w),k.addColorStop(0,m.WHITE.toString()),k.addColorStop(1,l.toString()),t.fillRect({x:v,y:p,width:T,height:w+B-p,rx:g/2,ry:g/2,gradient:k})}else t.fillRect(A(C({},d),{rx:g/2,ry:g/2,color:this.colorFillbackground})),t.fillRect({x:v,y:p,width:T,height:w+B-p,rx:g/2,ry:g/2,color:l});let M=U(d,s/2);t.strokeRect(A(C({},M),{rx:g/2,ry:g/2,color:this.effect3d?hd:h,lineWidth:s}))}drawMarkers(t,e,i){let{lolo:r,lo:s,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=e.x+e.width/2+this.pipeWidth/2;if(this.showLoLo&&r!==void 0){let d=Math.round(i.getValuePosition(r));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"LOLO",align:"left",baseline:"middle",color:this.colorLoLo,font:h})}if(this.showLo&&s!==void 0){let d=Math.round(i.getValuePosition(s));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"LO",align:"left",baseline:"middle",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let d=Math.round(i.getValuePosition(o));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"HI",align:"left",baseline:"middle",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let d=Math.round(i.getValuePosition(a));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"HIHI",align:"left",baseline:"middle",color:this.colorHiHi,font:h})}}get min(){return this.limitsFromPv?this.pv?.lowerDisplayLimit??this.minimum:this.minimum}get max(){return this.limitsFromPv?this.pv?.upperDisplayLimit??this.maximum:this.maximum}get lolo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerAlarmLimit:this.levelLoLo}get lo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerWarningLimit:this.levelLo}get hi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperWarningLimit:this.levelHi}get hihi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperAlarmLimit:this.levelHiHi}get pipeWidth(){return this.scale*15}get bulbMaxDiameter(){return this.scale*40}get outlineWidth(){return this.scale*1}get markerTickLength(){return this.scale*10}get markerTickLineWidth(){return this.scale*2}get markerGap(){return this.scale*3}get alarmSensitiveFillColor(){if(this.fillColorAlarmSensitive){if(this.isMajorSeverity())return m.RED;if(this.isMinorSeverity())return m.ORANGE}return this.fillColor}getFillValue(){let t=this.pv?.value??this.min;return t=Math.max(this.min,t),t=Math.min(this.max,t),t}format(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(3)))}get colorLo(){return this.properties.getValue(Rn)}get colorLoLo(){return this.properties.getValue(En)}get colorHi(){return this.properties.getValue(kn)}get colorHiHi(){return this.properties.getValue(Mn)}get colorFillbackground(){return this.properties.getValue(Wn)}get fillColorAlarmSensitive(){return this.properties.getValue(In)}get fillColor(){return this.properties.getValue(Bn)}get font(){return this.properties.getValue(Hn).scale(this.scale)}get effect3d(){return this.properties.getValue(Dn)}get levelLo(){return this.properties.getValue($n)}get levelLoLo(){return this.properties.getValue(On)}get levelHi(){return this.properties.getValue(Nn)}get levelHiHi(){return this.properties.getValue(Fn)}get limitsFromPv(){return this.properties.getValue(Gn)}get logScale(){return this.properties.getValue(zn)}get minimum(){return this.properties.getValue(Yn)}get majorTickStepHint(){return this.scale*this.properties.getValue(qn)}get maximum(){return this.properties.getValue(Un)}get scaleFont(){return this.properties.getValue(Xn).scale(this.scale)}get scaleFormat(){return this.properties.getValue(Kn)}get showBulb(){return this.properties.getValue(jn)}get showMarkers(){return this.properties.getValue(ed)}get showMinorTicks(){return this.properties.getValue(id)}get showLo(){return this.properties.getValue(Qn)}get showLoLo(){return this.properties.getValue(td)}get showHi(){return this.properties.getValue(Zn)}get showHiHi(){return this.properties.getValue(Jn)}get showScale(){return this.properties.getValue(rd)}get transparentBackground(){return this.properties.getValue(sd)}get unit(){return this.properties.getValue(od)}get valueLabelFormat(){return this.properties.getValue(ad)}},ld=-323.3062,nd=308.2547,rg=class{constructor(t,e){this.widget=t,this.index=e}linearScale;_effectiveMinimum;_effectiveMaximum;get scale(){return this.widget.scale}getValue(t){return this.widget.properties.getValue(`axis_${this.index}_${t}`)}isDateEnabled(){return this.timeFormat!==0}isHorizontal(){return this.index===0||this.index!==1&&!this.yAxis}isVertical(){return!this.isHorizontal()}isPrimary(){return this.index<=1}get effectiveMinimum(){return this._effectiveMinimum??this.minimum}set effectiveMinimum(t){this._effectiveMinimum=t}get effectiveMaximum(){return this._effectiveMaximum??this.maximum}set effectiveMaximum(t){this._effectiveMaximum=t}performAutoScale(){let t={start:this.minimum,stop:this.maximum},e=this.widget.calculateAutoscaledRange(this,t);e&&(this.effectiveMinimum=e.start,this.effectiveMaximum=e.stop,this.widget.requestRepaint())}applyZoom(t,e){let i=this.effectiveMinimum,r=this.effectiveMaximum,s,o;if(this.logScale){r=Math.log10(r),i=Math.log10(i);let a=Math.log10(t)*e,h=1-e;s=a+i*h,o=a+r*h,s<ld&&(s=ld),s=Math.pow(10,s),o>nd&&(o=nd),o=Math.pow(10,o)}else{let a=Math.max(Math.abs(i),Math.abs(r));i/=a,r/=a;let h=t/a*e,l=1-e;s=(h+i*l)*a,o=(h+r*l)*a}this.effectiveMinimum=s,this.effectiveMaximum=o,this.widget.requestRepaint()}get autoScale(){return this.getValue("auto_scale")}get autoScaleTreshold(){return this.getValue("auto_scale_treshold")}get axisColor(){return this.getValue("axis_color")}get axisTitle(){return this.getValue("axis_title")}get dashGridLine(){return this.getValue("dash_grid_line")}get gridColor(){return this.getValue("grid_color")}get leftBottomSide(){return this.getValue("left_bottom_side")}get logScale(){return this.getValue("log_scale")}get maximum(){return this.getValue("maximum")}get minimum(){return this.getValue("minimum")}get scaleFont(){return this.getValue("scale_font").scale(this.scale)}get scaleFormat(){return this.getValue("scale_format")}get showGrid(){return this.getValue("show_grid")}get timeFormat(){return this.getValue("time_format")}get titleFont(){return this.getValue("title_font").scale(this.scale)}get visible(){return this.getValue("visible")}get yAxis(){return this.getValue("y_axis")}},At=class{constructor(t,e){this.xAxis=t,this.yAxis=e;for(let i of t)this.beforeXRanges.push({min:i.effectiveMinimum,max:i.effectiveMaximum});for(let i of e)this.beforeYRanges.push({min:i.effectiveMinimum,max:i.effectiveMaximum})}beforeXRanges=[];beforeYRanges=[];afterXRanges=[];afterYRanges=[];saveState(){for(let t of this.xAxis)this.afterXRanges.push({min:t.effectiveMinimum,max:t.effectiveMaximum});for(let t of this.yAxis)this.afterYRanges.push({min:t.effectiveMinimum,max:t.effectiveMaximum})}undo(){for(let t=0;t<this.xAxis.length;t++){let e=this.xAxis[t],i=this.beforeXRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}for(let t=0;t<this.yAxis.length;t++){let e=this.yAxis[t],i=this.beforeYRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}}redo(){for(let t=0;t<this.xAxis.length;t++){let e=this.xAxis[t],i=this.afterXRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}for(let t=0;t<this.yAxis.length;t++){let e=this.yAxis[t],i=this.afterYRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}}},sg=class{undoStack=[];redoStack=[];canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}add(t){this.undoStack.push(t),this.redoStack.length=0}undo(){let t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t))}redo(){let t=this.redoStack.pop();t&&(t.redo(),this.undoStack.push(t))}},og=class{constructor(t,e){this.widget=e,this.id=t}id;cursor;selection;grabStart;prevGrabEvent;grabZoomCommand;tooltip(){return this.widget.tooltip}mouseDown(t){let{widget:e}=this;switch(e.toolbar?.currentTool){case"rubberband-zoom":case"horizontal-zoom":case"vertical-zoom":this.grabStart=t;break;case"panning":this.grabZoomCommand=new At(e.getXAxes(),e.getYAxes());break}}grab(t){switch(this.widget.toolbar?.currentTool){case"rubberband-zoom":case"horizontal-zoom":case"vertical-zoom":this.grabStart&&(this.selection=A(C({},this.grabStart.point),{width:t.dx,height:t.dy}),this.widget.requestRepaint());break;case"panning":this.pan(t),this.prevGrabEvent=t,this.widget.requestRepaint();break}}grabEnd(){let{grabZoomCommand:t,selection:e,widget:i}=this;switch(i.toolbar?.currentTool){case"rubberband-zoom":if(e){let r=new At(i.getXAxes(),i.getYAxes());this.rangeZoomXAxes(e),this.rangeZoomYAxes(e),r.saveState(),i.toolbar.addCommand(r)}break;case"horizontal-zoom":if(e){let r=new At(i.getXAxes(),i.getYAxes());this.rangeZoomXAxes(e),r.saveState(),i.toolbar.addCommand(r)}break;case"vertical-zoom":if(e){let r=new At(i.getXAxes(),i.getYAxes());this.rangeZoomYAxes(e),r.saveState(),i.toolbar.addCommand(r)}break;case"panning":t&&(t.saveState(),i.toolbar.addCommand(t));break}this.selection=void 0,this.prevGrabEvent=void 0,this.grabZoomCommand=void 0,this.widget.requestRepaint()}click(t){let{widget:e}=this;switch(e.toolbar?.currentTool){case"zoom-in":let i=new At(e.getXAxes(),e.getYAxes());for(let s of e.getAxes()){let o=s.isHorizontal()?t.point.x:t.point.y,a=s.linearScale.getPositionValue(o);s.applyZoom(a,.1)}i.saveState(),e.toolbar.addCommand(i);break;case"zoom-out":let r=new At(e.getXAxes(),e.getYAxes());for(let s of e.getAxes()){let o=s.isHorizontal()?t.point.x:t.point.y,a=s.linearScale.getPositionValue(o);s.applyZoom(a,-.1)}r.saveState(),e.toolbar.addCommand(r);break}}rangeZoomXAxes(t){for(let e of this.widget.getXAxes()){let i=e.linearScale.getPositionValue(t.x),r=e.linearScale.getPositionValue(t.x+t.width);if(i>r){let o=i;i=r,r=o}let s=e.linearScale.getMinMax();i=Math.max(s.start,i),r=Math.min(s.stop,r),e.effectiveMinimum=i,e.effectiveMaximum=r}}rangeZoomYAxes(t){for(let e of this.widget.getYAxes()){let i=e.linearScale.getPositionValue(t.y),r=e.linearScale.getPositionValue(t.y+t.height);if(i>r){let o=i;i=r,r=o}let s=e.linearScale.getMinMax();i=Math.max(s.start,i),r=Math.min(s.stop,r),e.effectiveMinimum=i,e.effectiveMaximum=r}}pan(t){let{prevGrabEvent:e,widget:i}=this;if(e){let r=e.dx-t.dx;if(r!==0)for(let o of i.getXAxes()){let a=o.linearScale,h=a.getMinMax(),l=a.getValuePosition(h.start)+r,d=a.getValuePosition(h.stop)+r;o.effectiveMinimum=a.getPositionValue(l),o.effectiveMaximum=a.getPositionValue(d)}let s=e.dy-t.dy;if(s!==0)for(let o of i.getYAxes()){let a=o.linearScale,h=a.getMinMax(),l=a.getValuePosition(h.start)+s,d=a.getValuePosition(h.stop)+s;o.effectiveMinimum=a.getPositionValue(l),o.effectiveMaximum=a.getPositionValue(d)}}}},ag=class{pointer=0;samples=[];constructor(t){this.samples=Array(t).fill(void 0)}push(t,e){this.samples[this.pointer]={x:t,y:e},this.pointer=(this.pointer+1)%this.samples.length}clear(){this.samples.fill(void 0),this.pointer=0}isFull(){let t=(this.pointer+1)%this.samples.length;return this.samples[t]!==void 0}isEmpty(){return this.tail()===void 0}tail(){return this.pointer===0?this.samples[this.samples.length-1]:this.samples[this.pointer-1]}snapshot(t=!1){if(t)return this.samples.filter(e=>e!==void 0).sort((e,i)=>e.x-i.x);{let e=this.samples.slice(this.pointer).filter(r=>r!==void 0),i=this.samples.slice(0,this.pointer).filter(r=>r!==void 0);return e.concat(i)}}},hg=class{constructor(t,e,i,r,s,o){this.bufferSize=t,this.plotMode=e,this.updateMode=i,this.concatenateData=r,this.chronological=s,this.historicalDataProvider=o,this.traceData=new ag(t)}traceData;x=0;xPending=!1;y=0;yTimestamp=0;yPending=!1;xArray=[];xArrayPending=!1;yArray=[];yArrayPending=!1;clear(){this.traceData.clear(),this.x=0,this.xPending=!1,this.y=0,this.yPending=!1,this.yTimestamp=0,this.xArray=[],this.xArrayPending=!1,this.yArray=[],this.yArrayPending=!1}snapshot(){return this.historicalDataProvider?this.historicalDataProvider.getSamples():this.traceData.snapshot()}updateX(t){this.x=t,this.xPending=!0,this.maybeAddPoint()}updateY(t,e){this.y=t,this.yTimestamp=e,this.yPending=!0,this.maybeAddPoint()}updateXArray(t){this.xArray=t,this.xArrayPending=!0,this.maybeAddArray()}updateYArray(t){this.yArray=t,this.yArrayPending=!0,this.maybeAddArray()}maybeAddPoint(){if(this.plotMode===1&&this.traceData.isFull())return;let{xPending:t,yPending:e,chronological:i,updateMode:r}=this;r===0?(i&&e||!i&&(t||e))&&this.addPoint():r===1?(i&&e||!i&&t&&e)&&this.addPoint():r===2?(i&&e||!i&&t)&&this.addPoint():r===3&&this.yPending&&this.addPoint()}maybeAddArray(){if(this.plotMode===1&&this.traceData.isFull())return;let{xArrayPending:t,yArrayPending:e,chronological:i,updateMode:r}=this;r===0?(i&&e||!i&&(t||e))&&this.addArray():r===1?(i&&e||!i&&t&&e)&&this.addArray():r===2?(i&&e||!i&&t)&&this.addArray():r===3&&this.yArrayPending&&this.addArray()}addPoint(){this.concatenateData||this.traceData.clear();let t=this.x;if(this.chronological)if(this.updateMode===5)t=new Date().getTime();else if(this.yTimestamp!==void 0)t=this.yTimestamp;else{let e=this.traceData.tail();t=e?e.x+1:0}this.traceData.push(t,this.y),this.xPending=!1,this.yPending=!1}addArray(){this.concatenateData||this.traceData.clear();let{xArray:t,yArray:e}=this;if(this.chronological)if(t=Array(e.length),this.traceData.isEmpty())for(let s=0;s<e.length;s++)t[s]=s;else{let s=this.traceData.tail();for(let o=1;o<e.length;o++)t[o-1]=s.x+o}let i=Math.min(t.length,e.length),r=Math.min(i,this.bufferSize);for(let s=0;s<r;s++)this.traceData.push(t[s],e[s]);this.xArrayPending=!1,this.yArrayPending=!1}},lg=class{constructor(t,e){this.widget=t,this.i=e}traceData;historicalDataProvider;xPVInstance;yPVInstance;xPVListener=()=>{let t=this.xPVInstance;if(t)if(Array.isArray(t.value))this.traceData?.updateXArray(t.value);else{let e=t.toNumber();e!=null&&this.traceData?.updateX(e)}};yPVListener=()=>{let t=this.yPVInstance;if(t)if(Array.isArray(t.value))this.traceData?.updateYArray(t.value);else{let e=this.widget.getAxis(this.xAxisIndex),i=t.toNumber();if(i!=null)if(e.isDateEnabled()){let r=(t.time||new Date).getTime();this.traceData?.updateY(i,r)}else this.traceData?.updateY(i)}};init(){let{bufferSize:t,plotMode:e,updateMode:i,concatenateData:r,widget:s}=this,o=!this.xPV,{pvEngine:a}=s.display;this.historicalDataProvider=void 0,o&&this.yPV&&(this.historicalDataProvider=a.createHistoricalDataProvider(this.yPV,s)||void 0),this.traceData=new hg(t,e,i,r,o,this.historicalDataProvider),this.xPV&&(this.xPVInstance=a.createPV(this.xPV),this.xPVInstance.addListener(this.xPVListener)),this.yPV&&(this.yPVInstance=a.createPV(this.yPV),this.yPVInstance.addListener(this.yPVListener)),s.addPropertyListener(`trace_${this.i}_x_pv`,()=>{let h=a.createPV(this.xPV);h!==this.xPVInstance&&(this.xPVInstance?.removeListener(this.xPVListener),this.xPVInstance=h,this.xPVInstance.addListener(this.xPVListener))}),s.addPropertyListener(`trace_${this.i}_y_pv`,()=>{let h=a.createPV(this.yPV);h!==this.yPVInstance&&(this.yPVInstance?.removeListener(this.yPVListener),this.yPVInstance=h,this.yPVInstance.addListener(this.yPVListener))})}snapshot(){return this.traceData?.snapshot()||[]}drawTrace(t,e){let{lineWidth:i}=this;if(this.traceType===0)t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i});else if(this.traceType===1)t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[6*this.scale,2*this.scale]});else if(this.traceType!==2){if(this.traceType===3){let r=this.widget.getAxis(this.yAxisIndex).linearScale.getValuePosition(0);for(let s of e)s.y!==null&&t.strokePath({path:new S(s.x,s.y).lineTo(s.x,r),lineWidth:i,color:this.traceColor,opacity:100/255})}else if(this.traceType===4||this.traceType===5){let r=this.widget.getAxis(this.yAxisIndex).linearScale.getValuePosition(0);for(let s=1;s<e.length;s++){let o=e[s-1],a=e[s];o.y!==null&&a.y!==null&&t.fillPath({path:new S(o.x,o.y).lineTo(o.x,r).lineTo(a.x,r).lineTo(a.x,a.y),color:this.traceColor,opacity:100/255})}this.traceType===5&&t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i})}else if(this.traceType===6)for(let r=1;r<e.length;r++){let s=e[r-1],o=e[r];s.y!==null&&o.y!==null&&t.strokePath({path:new S(s.x,s.y).lineTo(s.x,o.y).lineTo(o.x,o.y),color:this.traceColor,lineWidth:i})}else if(this.traceType===7)for(let r=1;r<e.length;r++){let s=e[r-1],o=e[r];s.y!==null&&o.y!==null&&t.strokePath({path:new S(s.x,s.y).lineTo(o.x,s.y).lineTo(o.x,o.y),color:this.traceColor,lineWidth:i})}else if(this.traceType===8){let{scale:r}=this;t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[6*r,2*r,2*r,2*r]})}else if(this.traceType===9){let{scale:r}=this;t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[6*r,2*r,2*r,2*r,2*r,2*r]})}else if(this.traceType===10){let{scale:r}=this;t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[2*r,2*r]})}}}drawPoint(t,e){t.ctx.fillStyle=this.traceColor.toString(),t.ctx.strokeStyle=this.traceColor.toString(),t.ctx.lineWidth=1*this.scale;let i=this.pointSize/2,r=e.x,s=e.y;switch(this.pointStyle){case 1:t.ctx.beginPath(),t.ctx.ellipse(r,s,i,i,0,0,2*Math.PI),t.ctx.fill();break;case 2:t.ctx.beginPath(),t.ctx.ellipse(r,s,i,i,0,0,2*Math.PI),t.ctx.stroke();break;case 3:t.ctx.beginPath(),t.ctx.ellipse(r,s,i,i,0,0,2*Math.PI),t.ctx.fill();break;case 4:t.ctx.lineWidth=1*this.scale,t.ctx.beginPath(),t.ctx.moveTo(r-i,s+i),t.ctx.lineTo(r,s-i),t.ctx.lineTo(r+i,s+i),t.ctx.closePath(),t.ctx.stroke();break;case 5:t.ctx.lineWidth=1*this.scale,t.ctx.beginPath(),t.ctx.moveTo(r-i,s+i),t.ctx.lineTo(r,s-i),t.ctx.lineTo(r+i,s+i),t.ctx.closePath(),t.ctx.fill();break;case 6:t.ctx.strokeRect(r-i,s-i,2*i,2*i);break;case 7:t.ctx.fillRect(r-i,s-i,2*i,2*i);break;case 8:t.ctx.beginPath(),t.ctx.moveTo(r-i,s),t.ctx.lineTo(r,s-i),t.ctx.lineTo(r+i,s),t.ctx.lineTo(r,s+i),t.ctx.closePath(),t.ctx.stroke();break;case 9:t.ctx.beginPath(),t.ctx.moveTo(r-i,s),t.ctx.lineTo(r,s-i),t.ctx.lineTo(r+i,s),t.ctx.lineTo(r,s+i),t.ctx.closePath(),t.ctx.stroke();break;case 10:t.ctx.beginPath(),t.ctx.moveTo(r-i,s-i),t.ctx.lineTo(r+i,s+i),t.ctx.moveTo(r+i,s-i),t.ctx.lineTo(r-i,s+i),t.ctx.stroke();break;case 11:t.ctx.beginPath(),t.ctx.moveTo(r-i,s),t.ctx.lineTo(r+i,s),t.ctx.moveTo(r,s-i),t.ctx.lineTo(r,s+i),t.ctx.stroke();break;case 12:t.ctx.beginPath(),t.ctx.moveTo(r,s-i),t.ctx.lineTo(r,s+i),t.ctx.stroke()}}clearData(){this.traceData?.clear()}get scale(){return this.widget.scale}getValue(t){return this.widget.properties.getValue(`trace_${this.i}_${t}`)}get antiAlias(){return this.getValue("anti_alias")}get bufferSize(){return this.getValue("buffer_size")}get concatenateData(){return this.getValue("concatenate_data")}get lineWidth(){return this.scale*this.getValue("line_width")}get name(){return this.getValue("name")}get plotMode(){return this.getValue("plot_mode")}get pointSize(){return this.scale*this.getValue("point_size")}get pointStyle(){return this.getValue("point_style")}get traceColor(){return this.getValue("trace_color")}get traceType(){return this.getValue("trace_type")}get updateDelay(){return this.getValue("update_delay")}get updateMode(){return this.getValue("update_mode")}get visible(){return this.getValue("visible")}get xAxisIndex(){return this.getValue("x_axis_index")}get xPV(){return this.getValue("x_pv")}get yAxisIndex(){return this.getValue("y_axis_index")}get yPV(){return this.getValue("y_pv")}destroy(){this.historicalDataProvider?.disconnect()}},ng=new m(236,236,236),dg=new m(130,130,130),ug=class{constructor(t,e,i,r,s){this.imageFile=e,this.disabledImageFile=i,this.action=s,this.loadPromise=new Promise((o,a)=>{this.imageElement.onload=()=>o()}),this.disabledLoadPromise=new Promise((o,a)=>{this.disabledImageElement.onload=()=>o()}),this.region={id:`${t.xyGraph.wuid}-${e}`,mouseDown:()=>{this.toggleButton||(this.pushed=!0,t.xyGraph.requestRepaint())},mouseOut:()=>{this.toggleButton||(this.pushed=!1),t.xyGraph.requestRepaint()},mouseUp:()=>{this.toggleButton||(this.pushed=!1,t.xyGraph.requestRepaint())},click:()=>{this.toggleButton&&(this.pushed=!this.pushed,this.toolButton&&t.toggleTool(this)),this.action(),t.updateState()},tooltip:()=>r}}imageElement=new Image;disabledImageElement=new Image;loadPromise;disabledLoadPromise;toggleButton=!1;toolButton=!1;pushed=!1;disabled=!1;region;loadImage(t){this.imageElement.src=t+this.imageFile,this.disabledImageElement.src=t+this.disabledImageFile}},pg=class{constructor(t){this.xyGraph=t,this.showLegend=this.createToggleButton("ShowLegend.png","Show Legend",()=>{t.properties.setValue("show_legend",this.showLegend.pushed)}),this.showLegend.pushed=t.showLegend,t.addPropertyListener("show_legend",i=>{this.showLegend.pushed=i}),this.autoScale=this.createButton("AutoScale.png","AutoScale.png","Perform Auto Scale",()=>{let i=new At(t.getXAxes(),t.getYAxes());t.performAutoScale(),i.saveState(),this.addCommand(i)}),this.rubberbandZoom=this.createToolButton("RubberbandZoom.png","Rubberband Zoom",()=>{this.rubberbandZoom.pushed?(this.currentTool="rubberband-zoom",t.setCursor("crosshair"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.horizontalZoom=this.createToolButton("HorizontalZoom.png","Horizontal Zoom",()=>{this.horizontalZoom.pushed?(this.currentTool="horizontal-zoom",t.setCursor("col-resize"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.verticalZoom=this.createToolButton("VerticalZoom.png","Vertical Zoom",()=>{this.verticalZoom.pushed?(this.currentTool="vertical-zoom",t.setCursor("row-resize"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.zoomIn=this.createToolButton("ZoomIn.png","Zoom In",()=>{this.zoomIn.pushed?(this.currentTool="zoom-in",t.setCursor("zoom-in"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.zoomOut=this.createToolButton("ZoomOut.png","Zoom Out",()=>{this.zoomOut.pushed?(this.currentTool="zoom-out",t.setCursor("zoom-out"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.panning=this.createToolButton("Panning.png","Panning",()=>{this.panning.pushed?(this.currentTool="panning",t.setCursor("grab"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.mouseArrow=this.createToolButton("MouseArrow.png","None",()=>{this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0}),this.undo=this.createButton("Undo.png","Undo_Gray.png","Undo",()=>{this.commandBuffer.undo()}),this.undo.disabled=!0,this.redo=this.createButton("Redo.png","Redo_Gray.png","Redo",()=>{this.commandBuffer.redo()}),this.redo.disabled=!0,this.camera=this.createButton("camera.png","camera.png","Save Snapshot to PNG File",()=>{let i=document.createElement("a");try{i.href=t.toDataURL(),i.download=`${t.name}_export.png`,document.body.appendChild(i),i.click()}finally{document.body.removeChild(i)}}),this.toggleTool(this.mouseArrow);let e=this.buttons.map(i=>i.loadPromise).concat(this.buttons.map(i=>i.disabledLoadPromise));Promise.all(e).finally(()=>{this.imagesLoaded=!0,t.requestRepaint()});for(let i of this.buttons)i.loadImage(t.display.imagesPrefix)}buttons=[];showLegend;autoScale;rubberbandZoom;horizontalZoom;verticalZoom;zoomIn;zoomOut;panning;mouseArrow;undo;redo;camera;imagesLoaded=!1;currentTool="default";commandBuffer=new sg;updateState(){this.undo.disabled=!this.commandBuffer.canUndo(),this.redo.disabled=!this.commandBuffer.canRedo(),this.xyGraph.requestRepaint()}addCommand(t){this.commandBuffer.add(t),this.updateState()}toggleTool(t){let e=t.pushed;for(let i of this.buttons)i.toolButton&&(i.pushed=!1);e?t.pushed=!0:this.mouseArrow.pushed=!0,this.xyGraph.requestRepaint()}createToolButton(t,e,i){let r=this.createToggleButton(t,e,i);return r.toolButton=!0,r}createToggleButton(t,e,i){let r=this.createButton(t,t,e,i);return r.toggleButton=!0,r}createButton(t,e,i,r){let s=new ug(this,t,e,i,r);return this.buttons.push(s),s}draw(t,e){let{buttonSize:i}=this,r={x:e.x,y:e.y};return this.drawButton(t,r.x,r.y,this.showLegend),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.autoScale),r.x+=i,this.maybeWrap(r,e,i/2),this.drawSeparator(t,r.x,r.y),r.x+=i/2,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.rubberbandZoom),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.horizontalZoom),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.verticalZoom),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.zoomIn),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.zoomOut),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.panning),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.mouseArrow),r.x+=i,this.maybeWrap(r,e,i/2),this.drawSeparator(t,r.x,r.y),r.x+=i/2,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.undo),r.x+=i,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.redo),r.x+=i,this.maybeWrap(r,e,i/2),this.drawSeparator(t,r.x,r.y),r.x+=i/2,this.maybeWrap(r,e),this.drawButton(t,r.x,r.y,this.camera),r.x+=i,r.y+i-e.y}maybeWrap(t,e,i){i=i??this.buttonSize,t.x+i>e.x+e.width&&(t.x=e.x,t.y+=this.buttonSize)}drawSeparator(t,e,i){let{buttonSize:r}=this,s=1*this.scale,o=Math.round(e+r/4)-s/2;t.strokePath({path:new S(o,i).lineTo(o,i+r),color:dg,lineWidth:s})}drawButton(t,e,i,r){let{buttonSize:s,scale:o}=this;t.fillRect({x:e,y:i,width:s,height:s,color:ng}),this.xyGraph.enabled&&!r.disabled&&t.addHitRegion(r.region).addRect(e,i,s,s);let a=1*o,h=Math.round(i+a/2)-.5,l=Math.round(e+a/2)-.5,d=Math.round(i+s-a+a/2)-.5,n=Math.round(e+s-a+a/2)-.5;if(t.strokePath({color:r.pushed?m.WHITE:m.BLACK,path:new S(n,d).lineTo(n,h).moveTo(n,d).lineTo(l,d),lineWidth:a}),t.strokePath({color:r.pushed?m.BLACK:m.WHITE,path:new S(l,h).lineTo(n-a,h).moveTo(l,h).lineTo(l,d-a),lineWidth:a}),this.imagesLoaded){let p=r.disabled?r.disabledImageElement:r.imageElement,g=p.naturalHeight*o,v=p.naturalWidth*o,w=Math.round(e+(s-v)/2),T=Math.round(i+(s-g)/2);t.ctx.drawImage(p,w,T,v,g)}}get scale(){return this.xyGraph.scale}get buttonSize(){return 25*this.scale}},Me="axis_count",dd="plot_area_background_color",ud="show_legend",pd="show_plot_area_border",cd="show_toolbar",gd="title",md="title_font",Re="trace_count",fd="transparent",cg=class extends G{toolbar;plotAreaRegion;axes=[];traces=[];autoScaleAllowed=!0;constructor(t,e){super(t,e),this.properties.add(new b(Me)),this.properties.add(new R(dd)),this.properties.add(new y(ud)),this.properties.add(new y(pd)),this.properties.add(new y(cd)),this.properties.add(new _(gd)),this.properties.add(new O(md)),this.properties.add(new b(Re)),this.properties.add(new y(fd)),this.properties.addGenerator(()=>{let i=[];this.axes=[];let r=this.properties.getValue(Me);for(let o=0;o<r;o++)this.axes.push(new rg(this,o)),i.push(new y(`axis_${o}_auto_scale`),new H(`axis_${o}_auto_scale_treshold`),new R(`axis_${o}_axis_color`),new _(`axis_${o}_axis_title`),new y(`axis_${o}_dash_grid_line`),new R(`axis_${o}_grid_color`),new y(`axis_${o}_log_scale`),new H(`axis_${o}_maximum`),new H(`axis_${o}_minimum`),new O(`axis_${o}_scale_font`),new _(`axis_${o}_scale_format`),new y(`axis_${o}_show_grid`),new b(`axis_${o}_time_format`),new O(`axis_${o}_title_font`),new y(`axis_${o}_visible`)),o>1&&i.push(new y(`axis_${o}_left_bottom_side`),new y(`axis_${o}_y_axis`));this.traces=[];let s=this.properties.getValue(Re);for(let o=0;o<s;o++)this.traces.push(new lg(this,o)),i.push(new y(`trace_${o}_anti_alias`),new b(`trace_${o}_buffer_size`),new y(`trace_${o}_concatenate_data`),new b(`trace_${o}_line_width`),new _(`trace_${o}_name`),new b(`trace_${o}_plot_mode`),new b(`trace_${o}_point_size`),new b(`trace_${o}_point_style`),new R(`trace_${o}_trace_color`),new b(`trace_${o}_trace_type`),new b(`trace_${o}_update_delay`),new b(`trace_${o}_update_mode`),new y(`trace_${o}_visible`),new b(`trace_${o}_x_axis_index`),new _(`trace_${o}_x_pv`),new Jt(`trace_${o}_x_pv_value`,`trace_${o}_x_pv`),new b(`trace_${o}_y_axis_index`),new _(`trace_${o}_y_pv`),new Jt(`trace_${o}_y_pv_value`,`trace_${o}_y_pv`));return i})}init(){this.plotAreaRegion=new og(`${this.wuid}-plotarea`,this),this.traces.forEach(t=>t.init())}draw(t){let{scale:e}=this,i=this.area;if(this.borderAlarmSensitive&&(i=U(this.area,2*e)),!this.transparent){let o=this.alarmSensitiveBackgroundColor;t.fillRect(A(C({},i),{color:o}))}this.showToolbar&&this.drawToolbar(t,i),this.title&&this.drawTitle(t,i);for(let o of this.axes){if(o.autoScale&&this.autoScaleAllowed){let l={start:o.minimum,stop:o.maximum},d=this.calculateAutoscaledRange(o,l);d&&(o.effectiveMinimum=d.start,o.effectiveMaximum=d.stop)}let a=o.effectiveMinimum,h=o.effectiveMaximum;o.linearScale=new Tt(this.display.formatter,e,o.scaleFont,a,h,o.logScale,50*e,o.axisColor,!0,o.visible),o.linearScale.scaleFormat=o.scaleFormat,o.linearScale.timeFormat=o.timeFormat}this.showLegend&&this.drawLegend(t,i),t.addHitRegion(this.plotAreaRegion).addRect(i.x,i.y,i.width,i.height);let r=this.drawAxes(t,i);this.drawPlotArea(t,r);let s=this.plotAreaRegion?.selection;s&&this.drawZoomSelection(t,r,tp(r,s))}drawToolbar(t,e){this.toolbar||(this.toolbar=new pg(this));let i=3*this.scale,r=U(e,i),s=this.toolbar.draw(t,r);e.y+=i+s+i,e.height-=i+s+i}drawTitle(t,e){let i=t.measureText(this.title,this.titleFont).height;t.fillText({x:e.x+e.width/2,y:e.y+i/2,align:"center",baseline:"middle",color:this.alarmSensitiveForegroundColor,font:this.titleFont,text:this.title});let r=2*this.scale;e.y+=i+r,e.height-=i+r}drawAxes(t,e){let{scale:i}=this,r=5*i,s=C({},e),o=0,a=0;for(let n of this.getXAxes())if(n.visible){let p=0;n.axisTitle&&(p=r+t.measureText(n.axisTitle,n.titleFont).height),o+=p,a+=p+n.linearScale.measureHorizontalHeight(t)}let h=0,l=0;for(let n of this.getYAxes().reverse()){let p=n.linearScale;if(n.visible){let g=p.calculateMargin(t,!1),v=s.height-a+(a>0?g:0),w=0;n.axisTitle&&(w=t.measureText(n.axisTitle,n.titleFont).height,t.ctx.save(),t.ctx.translate(s.x+r+w/2,e.y+v/2),t.ctx.rotate(-Math.PI/2),t.fillText({x:0,y:0,align:"center",baseline:"middle",font:n.titleFont,color:n.axisColor,text:n.axisTitle}),t.ctx.restore(),w+=r);let T=w+p.drawVertical(t,s.x+w,e.y,v,!0,!1);s.x+=T,s.width-=T,h+=T;let B=p.margin;l=l===0?B:Math.min(l,B);let M=i*1,k=Math.round(s.x)-M/2,W=Math.round(e.y+g)-M/2;t.strokePath({path:new S(k,W).lineTo(k,W+v-2*g),color:n.axisColor,opacity:100/255,lineWidth:M})}else{let g=s.height-a;p.setDimensions(0,e.y,g,!1)}}let d=0;for(let n of this.getXAxes().reverse()){let p=n.linearScale;if(n.visible){let g=p.calculateMargin(t,!0),v=h-g,w=0;if(n.axisTitle){w=t.measureText(n.axisTitle,n.titleFont).height;let D=e.x+h+(e.width-h)/2;t.fillText({x:D,y:s.y+s.height-w/2,align:"center",baseline:"middle",font:n.titleFont,color:n.axisColor,text:n.axisTitle}),w+=r}let T=w+p.drawHorizontal(t,e.x+v,s.y+s.height-w,e.width-v);s.height-=T;let B=p.margin;d=d===0?B:Math.min(d,B);let M=i*1,k=Math.round(e.x+v+g)-M/2,W=Math.round(s.y+s.height)-M/2;t.strokePath({path:new S(k,W).lineTo(k+s.width-g,W),color:n.axisColor,opacity:100/255,lineWidth:M})}else{let g=e.x+h,v=e.width-h;p.setDimensions(g,0,v,!0)}}return s.y+=l,s.width-=d,a>0?s.height-=l:s.height-=2*l,s}drawPlotArea(t,e){let{scale:i}=this,r=1*i;if(this.transparent||t.fillRect(A(C({},e),{color:this.plotAreaBackgroundColor})),this.showPlotAreaBorder){let{x:s,y:o,width:a,height:h}=U(e,r/2);t.strokePath({path:new S(s,o).lineTo(s+a,o).lineTo(s+a,o+h),color:m.BLACK,lineWidth:r})}for(let s of this.axes.filter(o=>o.visible&&o.showGrid)){let o=s.linearScale;if(s.isHorizontal())for(let a of o.getGridPositions()){let h=Math.round(o.getX()+a)-r/2;t.strokePath({path:new S(h,e.y).lineTo(h,e.y+e.height),color:s.gridColor,lineWidth:r,dash:s.dashGridLine?[6*i,2*i]:void 0})}else for(let a of o.getGridPositions()){let h=Math.round(o.getY()+a)-r/2;t.strokePath({path:new S(e.x,h).lineTo(e.x+e.width,h),color:s.gridColor,lineWidth:r,dash:s.dashGridLine?[6*i,2*i]:void 0})}}t.ctx.save(),t.ctx.beginPath(),t.ctx.rect(e.x,e.y,e.width,e.height),t.ctx.clip();for(let s of this.traces.filter(o=>o.visible)){let o=this.getAxis(s.xAxisIndex).linearScale,a=this.getAxis(s.yAxisIndex).linearScale,h=[];for(let l of s.snapshot()){let d=o.getValuePosition(l.x),n=l.y!==null?a.getValuePosition(l.y):null;h.push({x:d,y:n})}if(h.length){s.drawTrace(t,h);for(let l of h)l.y!==null&&s.drawPoint(t,l)}}t.ctx.restore()}drawZoomSelection(t,e,i){let{scale:r}=this;switch(this.toolbar?.currentTool){case"rubberband-zoom":t.strokeRect(A(C({},i),{color:m.BLACK,lineWidth:1*r}));break;case"horizontal-zoom":let s=i;s.y=e.y,s.height=e.height,t.strokeRect(A(C({},xi(s)),{color:m.BLACK,lineWidth:1*r}));break;case"vertical-zoom":let o=i;o.x=e.x,o.width=e.width,t.strokeRect(A(C({},xi(o)),{color:m.BLACK,lineWidth:1*r}));break}}drawLegend(t,e){let{scale:i}=this,r=25*i,s=2*i,o=5*i,a=it.ARIAL_10.scale(i);for(let h of this.getYAxes()){let l=this.traces.filter(M=>M.visible&&M.yAxisIndex===h.index),d=[],n=[],p=0,g=0;for(let M of l){let k=r+s+o;M.name&&(k+=t.measureText(M.name,a).width),p+k<e.width?(n.push(M),p+=k):(d.push(n),k=Math.max(k,p),n=[M],p=k)}if(n.length&&(d.push(n),g=Math.max(g,p)),!d.length)continue;let v=r*d.length,w={x:Math.round(e.x+(e.width-g)/2),y:Math.round(e.y+e.height-v),width:g,height:v};e.height-=w.height,this.transparent||t.fillRect(A(C({},w),{color:this.plotAreaBackgroundColor})),t.strokeRect(A(C({},U(w,1*i/2)),{color:h.axisColor}));let T=w.x,B=w.y;for(let M=0;M<d.length;M++){let k=d[M],W=B+M*r,D=W+r/2;for(let N of k){let K=N.pointSize>Math.floor((r-o)/2)?Math.floor(r-o):N.pointSize;switch(N.traceType){case 3:let J=T+r/2;t.strokePath({path:new S(J,W+K).lineTo(J,W+r),lineWidth:N.lineWidth,color:N.traceColor,opacity:100/255}),N.drawPoint(t,{x:J,y:W+K});break;case 4:case 5:let ht=[{x:T,y:W+r/2},{x:T+r/2,y:W+K},{x:T+r,y:W+r/2},{x:T+r,y:W+r},{x:T,y:W+r}];t.fillPath({path:S.fromPoints(ht),color:N.traceColor,opacity:100/255}),N.traceType===5&&t.strokePath({path:S.fromPoints(ht.slice(0,3)),color:N.traceColor,lineWidth:1*i}),N.drawPoint(t,{x:T+r/2,y:W+K});break;default:N.drawTrace(t,[{x:T,y:D},{x:T+r,y:D}]),N.drawPoint(t,{x:T+r/2,y:D})}T+=r+s,N.name&&(t.fillText({x:T,y:D,align:"left",baseline:"middle",color:N.traceColor,font:a,text:N.name}),T+=t.measureText(N.name,a).width),T+=o}}}}setCursor(t){this.plotAreaRegion.cursor=t}calculateAutoscaledRange(t,e){let i,r,s=t.logScale;for(let o of this.traces)if(o.visible&&!(this.axes[o.xAxisIndex]!==t&&this.axes[o.yAxisIndex]!==t))for(let a of o.snapshot()){let h=t.isHorizontal()?a.x:a.y;h!==null&&((i===void 0||i>h)&&(!s||h>0)&&(i=h),(r===void 0||r<h)&&(!s||h>0)&&(r=h))}if(i!==void 0&&r!==void 0)return i===r?{start:Math.min(i,e.start),stop:Math.max(r,e.stop)}:{start:i,stop:r}}performAutoScale(){for(let t of this.axes)t.visible&&t.performAutoScale()}clearGraph(){for(let t of this.traces)t.clearData();this.requestRepaint()}getAxes(){return[...this.axes]}getXAxes(){return this.axes.filter(t=>t.isHorizontal())}getYAxes(){return this.axes.filter(t=>t.isVertical())}getAxis(t){return this.axes[t]}getTrace(t){return this.traces[t]}get axisCount(){return this.properties.getValue(Me)}get plotAreaBackgroundColor(){return this.properties.getValue(dd)}get showLegend(){return this.properties.getValue(ud)}get showPlotAreaBorder(){return this.properties.getValue(pd)}get showToolbar(){return this.properties.getValue(cd)}get title(){return this.properties.getValue(gd)}get titleFont(){return this.properties.getValue(md).scale(this.scale)}get traceCount(){return this.properties.getValue(Re)}get transparent(){return this.properties.getValue(fd)}destroy(){for(let t of this.traces)t.destroy()}},gg=class extends ue{parseNode(t){super.parseNode(t);for(let e of t.getNodes("widget")){let i=e.getString("widget_type"),r=this.display.createWidget(i,this);r&&(r.parseNode(e),this.widgets.push(r))}}beforeDrawBorder(t){this.transparent||t.fillRect({x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight,color:this.backgroundColor})}draw(t){let e=t.createChild(this.width,this.height);for(let i of this.widgets.filter(r=>r.visible))i.drawHolder(e),i.draw(e),i.drawDecoration(e);for(let i of this.widgets.filter(r=>r.visible))i.drawOverlay(e);t.copy(e,this.x,this.y)}},xd="minimum_tab_height",Ne="active_tab",wd="horizontal_tabs",Ee="tab_count",mg=class{constructor(t,e){this.widget=t,this.i=e,this.headerRegion={id:`${t.wuid}-header-${e}`,click:()=>{t.activeTab!==e&&(t.properties.setValue(Ne,e),t.requestRepaint())},cursor:"pointer"}}headerRegion;get scale(){return this.widget.scale}getValue(t){return this.widget.properties.getValue(`tab_${this.i}_${t}`)}get title(){return this.getValue("title")}get backgroundColor(){return this.getValue("background_color")}get foregroundColor(){return this.getValue("foreground_color")}get enabled(){return this.getValue("enabled")}get font(){return this.getValue("font").scale(this.scale)}},yd=class extends ue{tabs=[];constructor(t,e){super(t,e),this.properties.add(new b(xd)),this.properties.add(new b(Ne)),this.properties.add(new y(wd)),this.properties.add(new b(Ee)),this.properties.addGenerator(()=>{this.tabs=[];let i=this.properties.getValue(Ee),r=[];for(let s=0;s<i;s++)this.tabs.push(new mg(this,s)),r.push(new _(`tab_${s}_title`),new R(`tab_${s}_background_color`),new R(`tab_${s}_foreground_color`),new y(`tab_${s}_enabled`),new O(`tab_${s}_font`));return r})}parseNode(t){super.parseNode(t);for(let e of t.getNodes("widget")){let i=e.getString("widget_type"),r=this.display.createWidget(i,this);r&&(r.parseNode(e),this.widgets.push(r))}}draw(t){this.horizontalTabs?this.drawHorizontalTabs(t):this.drawVerticalTabs(t)}measureTabOffset(t){return this.horizontalTabs?{x:0,y:this.measureLabelHeight(t)}:{x:this.measureLabelWidth(t),y:0}}measureLabelHeight(t){let{scale:e}=this,i=1*e,r=this.minimumTabHeight;for(let s=0;s<this.tabs.length;s++){let o=this.tabs[s],a=t.measureText(o.title,o.font).height+i;a>r&&(r=a)}return r+this.margin}measureLabelWidth(t){let{scale:e}=this,i=1*e,r=this.minimumTabWidth;for(let s=0;s<this.tabs.length;s++){let o=this.tabs[s],a=t.measureText(o.title,o.font).width+i;a>r&&(r=a)}return r+this.margin}drawHorizontalTabs(t){let{margin:e,gap:i,scale:r}=this,s=this.measureLabelHeight(t),o=1*r,a=this.x;for(let h=0;h<this.tabs.length;h++){let l=this.tabs[h],d=t.measureText(l.title,l.font),n,p,g,v,w;this.activeTab===h?(n=a,p=this.y,g=d.width+o+e+i,v=s,w=l.backgroundColor):(n=a+i,p=this.y+2*r,g=d.width+o+e-i,v=s-2*r,w=this.darken(l.backgroundColor)),t.fillRect({x:n,y:p,width:g,height:v,color:w}),t.addHitRegion(l.headerRegion).addRect(n,p,g,v);let T=t.createLinearGradient(n,p,n,p+v);if(T.addColorStop(0,m.WHITE.toString()),T.addColorStop(1,m.WHITE.withAlpha(0).toString()),t.fillRect({x:n,y:p,width:g,height:v,gradient:T}),t.fillText({x:n+g/2,y:p+v/2,baseline:"middle",align:"center",font:l.font,color:l.foregroundColor,text:l.title}),a+=d.width+o+e-1*r,this.activeTab===h){let B=this.x,M=this.y+s,k=this.width,W=this.height-s;t.fillRect({x:B,y:M,width:k,height:W,color:l.backgroundColor});let D=this.widgets[h],N=t.createChild(k,W);D.drawHolder(N),D.draw(N),D.drawDecoration(N),D.drawOverlay(N),t.copy(N,B,M)}else this.widgets[h].hide()}}drawVerticalTabs(t){let{margin:e,gap:i,scale:r}=this,s=this.measureLabelWidth(t),o=1*r,a=this.y;for(let h=0;h<this.tabs.length;h++){let l=this.tabs[h],d=t.measureText(l.title,l.font),n=Math.max(d.height+o+o,this.minimumTabHeight),p,g,v,w,T;this.activeTab===h?(p=this.x,g=a,v=s,w=n+e+i,T=l.backgroundColor):(p=this.x+2*r,g=a+i,v=s-2*r,w=n+e-i,T=this.darken(l.backgroundColor)),t.fillRect({x:p,y:g,width:v,height:w,color:T}),t.addHitRegion(l.headerRegion).addRect(p,g,v,w);let B=t.createLinearGradient(p,g,p+v,g);if(B.addColorStop(0,m.WHITE.toString()),B.addColorStop(1,m.WHITE.withAlpha(0).toString()),t.fillRect({x:p,y:g,width:v,height:w,gradient:B}),t.fillText({x:p+v/2,y:g+w/2,baseline:"middle",align:"center",font:l.font,color:l.foregroundColor,text:l.title}),a+=n+e-1*r,this.activeTab===h){let M=this.x+s-1*r,k=this.y,W=this.width-s,D=this.height-1*r;t.fillRect({x:M,y:k,width:W,height:D,color:l.backgroundColor});let N=this.widgets[h],K=t.createChild(W,D);N.drawHolder(K),N.draw(K),N.drawDecoration(K),N.drawOverlay(K),t.copy(K,M,k)}else this.widgets[h].destroy()}}darken(t){let e=Math.max(0,t.red-30),i=Math.max(0,t.green-30),r=Math.max(0,t.blue-30);return new m(e,i,r)}get margin(){return this.scale*10}get gap(){return this.scale*2}get minimumTabWidth(){return this.scale*20}get minimumTabHeight(){return this.scale*this.properties.getValue(xd)}get activeTab(){return this.properties.getValue(Ne)}get tabCount(){return this.properties.getValue(Ee)}get horizontalTabs(){return this.properties.getValue(wd)}},fg=class{constructor(t){this.table=t}columnCount=0;cells=[];selectedRowIndex;dirty=!1;modifiedListeners=[];selectionChangedListeners=[];isEmpty(){return!this.cells.length}refresh(){this.dirty=!0}getCells(){return this.cells}getContent(){let t=[];for(let e of this.cells)t.push(e.map(i=>i.text||""));return t}setContent(t){this.cells.length=0;for(let e=0;e<t.length;e++)e===0&&(this.columnCount=t[e].length),this.cells.push(t[e].map(i=>({text:i})));this.dirty=!0}getColumnCount(){return this.columnCount}getRowCount(){return this.cells.length}setSelectedRowIndex(t){this.selectedRowIndex=t,this.selectionChangedListeners.forEach(e=>e()),this.dirty=!0}getSelection(){return this.selectedRowIndex===void 0?[]:[[...this.cells[this.selectedRowIndex].map(t=>t.text??null)]]}getCellText(t,e){let i=this.cells[t];return i?i[e]?.text??null:null}setColumnsCount(t){if(t<this.columnCount)for(let e of this.cells)e.length=t;if(t>this.columnCount){let e=t-this.columnCount;for(let i of this.cells)for(let r=0;r<e;r++)i.push({text:""})}this.columnCount=t,this.dirty=!0}addModifiedListener(t){this.modifiedListeners.push(t)}addSelectionChangedListener(t){this.selectionChangedListeners.push(t)}appendRow(){let t=[];for(let e=0;e<this.columnCount;e++)t[e]={text:""};return this.cells.push(t),this.dirty=!0,this.cells.length-1}deleteRow(t){this.cells.splice(t,1),this.dirty=!0}deleteColumn(t){for(let e of this.cells)e.splice(t,1);this.columnCount--,this.dirty=!0}insertRow(t){let e=[];for(let i=0;i<this.columnCount;i++)e.push({text:""});this.cells.splice(t,0,e),this.dirty=!0}insertColumn(t){for(let e of this.cells)e.splice(t,0,{text:""});this.columnCount++,this.dirty=!0}getCell(t,e){this.cells[t]=this.cells[t]??[];let i=this.cells[t][e]??{};return this.cells[t][e]=i,i}setCellText(t,e,i){let r=this.getCell(t,e);r.text=i,this.dirty=!0}setRowBackground(t,e){let i=this.cells[t];for(let r of i)r.backgroundColor=e;this.dirty=!0}setRowForeground(t,e){let i=this.cells[t];for(let r of i)r.foregroundColor=e;this.dirty=!0}setCellBackground(t,e,i){let r=this.getCell(t,e);r.backgroundColor=i,this.dirty=!0}setCellForeground(t,e,i){let r=this.getCell(t,e);r.foregroundColor=i,this.dirty=!0}setColumnCellEditorData(t,e){}},vd="columns_count",bd="column_headers",Td="column_header_visible",Sd="default_content",Vd="font",xg=class extends G{tableWrapper;table;spreadsheet;constructor(t,e){super(t,e),this.properties.add(new b(vd)),this.properties.add(new Ie(bd)),this.properties.add(new y(Td)),this.properties.add(new Ie(Sd)),this.properties.add(new O(Vd)),this.spreadsheet=new fg(this)}init(){this.tableWrapper=document.createElement("div"),this.tableWrapper.style.display="none",this.tableWrapper.style.overflow="auto",this.table=document.createElement("table"),this.table.style.tableLayout="fixed",this.table.style.borderSpacing="0",this.table.style.borderCollapse="collapse",this.tableWrapper.appendChild(this.table),this.display.rootPanel.appendChild(this.tableWrapper),this.table.addEventListener("click",t=>{let e=t.target;if(e.tagName==="TD"){let i=e.parentElement;i.rowIndex>0&&this.spreadsheet.setSelectedRowIndex(i.rowIndex-1)}else this.spreadsheet.setSelectedRowIndex(void 0);this.requestRepaint()}),this.spreadsheet.setContent(this.defaultContent)}draw(t){if(this.tableWrapper){let{x:e,y:i,width:r,height:s}=this.display.measureAbsoluteArea(this);this.tableWrapper.style.backgroundColor="white",this.tableWrapper.style.position="absolute",this.tableWrapper.style.display="block",this.tableWrapper.style.left=`${e}px`,this.tableWrapper.style.top=`${i}px`,this.tableWrapper.style.width=`${r}px`,this.tableWrapper.style.height=`${s}px`,this.tableWrapper.style.border="1px solid rgba(0, 0, 0, 0.1)",this.table.style.font=this.font.getFontString(),this.spreadsheet.dirty&&(this.generateTableContent(),this.spreadsheet.dirty=!1)}}generateTableContent(){let t=this.table.rows.length;for(let i=t-1;i>=0;i--)this.table.deleteRow(i);if(this.columnHeaderVisible){let i=this.table.insertRow();for(let r=0;r<this.columnsCount;r++){let s=this.columnHeaders[r],o=i.insertCell();o.style.color="#aaa",o.style.textAlign="left",o.style.width=Number(s[1])*this.scale+"px",o.style.overflow="hidden",o.style.padding=`${4*this.scale}px`,o.style.borderBottom="1px solid rgba(0, 0, 0, 0.1)",r!==0&&(o.style.borderLeft="1px solid rgba(0, 0, 0, 0.1)");let a=document.createTextNode(s[0]);o.appendChild(a)}i.insertCell()}let e=this.spreadsheet.getCells();for(let i=0;i<e.length;i++){let r=e[i],s=i===this.spreadsheet.selectedRowIndex,o=this.table.insertRow();for(let a=0;a<this.columnsCount;a++){let h=o.insertCell();if(h.style.textAlign="left",h.style.overflow="hidden",h.style.wordWrap="break-word",h.style.textOverflow="ellipsis",h.style.padding=`${4*this.scale}px`,a!==0&&(h.style.borderLeft="1px solid rgba(0, 0, 0, 0.1)"),r[a]!==void 0){let l=s?m.BLUE:r[a].backgroundColor;l&&(h.style.backgroundColor=l.toString());let d=s?m.WHITE:r[a].foregroundColor;d&&(h.style.color=d.toString());let n=document.createTextNode(r[a].text||"");h.appendChild(n)}}o.insertCell()}}hide(){this.tableWrapper&&(this.tableWrapper.style.display="none")}destroy(){this.tableWrapper&&(this.display.rootPanel.removeChild(this.tableWrapper),this.tableWrapper=void 0,this.table=void 0)}get columnsCount(){return this.properties.getValue(vd)}get columnHeaders(){return this.properties.getValue(bd)}get columnHeaderVisible(){return this.properties.getValue(Td)}get defaultContent(){return this.properties.getValue(Sd)}get font(){return this.properties.getValue(Vd).scale(this.scale)}},Cd="url",wg=class extends G{iframe;prevUrl;constructor(t,e){super(t,e),this.properties.add(new _(Cd))}init(){this.iframe=document.createElement("iframe"),this.iframe.src="",this.iframe.style.display="none",this.iframe.style.border="0",this.display.rootPanel.appendChild(this.iframe)}draw(t){if(this.iframe){let{x:e,y:i,width:r,height:s}=this.display.measureAbsoluteArea(this);this.iframe.style.position="absolute",this.iframe.style.display="block",this.iframe.style.left=`${e}px`,this.iframe.style.top=`${i}px`,this.iframe.style.width=`${r}px`,this.iframe.style.height=`${s}px`,this.url&&this.prevUrl!==this.url&&(this.iframe.src=this.url,this.prevUrl=this.url)}}hide(){this.iframe&&(this.iframe.style.display="none")}destroy(){this.iframe&&(this.display.rootPanel.removeChild(this.iframe),this.iframe=void 0)}get url(){return this.properties.getValue(Cd)}},yg="Action Button",vg="Arc",bg="Boolean Button",Tg="Boolean Switch",Sg="Byte Monitor",Vg="Check Box",Cg="Choice Button",Ag="Combo",_g="Combo Box",Lg="Ellipse",Pg="Gauge",kg="Grouping Container",Mg="Image",Rg="Image Boolean Button",Eg="Image Boolean Indicator",Wg="Intensity Graph",Bg="Label",Ig="LED",Hg="Linking Container",Dg="Menu Button",Ng="Meter",Fg="Button",$g="Polygon",Og="Polyline",Gg="Progress Bar",zg="Radio Box",Ug="Rectangle",qg="Rounded Rectangle",Yg="Scrollbar",Xg="Tabbed Container",Kg="Table",jg="Tank",Zg="Text Input",Jg="Text Update",Qg="Thermometer",tm="Web Browser",em="XY Graph",lm=class{constructor(t){this.targetElement=t,this.rootPanel=document.createElement("div"),this.rootPanel.className="display-root",this.rootPanel.style.overflow="hidden",this.rootPanel.style.position="relative",this.rootPanel.style.fontSize="0",t.appendChild(this.rootPanel);let e=document.createElement("canvas");this.rootPanel.appendChild(e),this.g=new ep(e),this.ctx=this.g.ctx,this.formatter=new Zu(!1),this.pvEngine=new Yp(this),this.pvEngine.addProvider(new Jp),this.pvEngine.addProvider(new ec(this.formatter)),this.pvEngine.addProvider(new zp),this.displayRegion={id:"display-root",click:()=>{for(let i of this.rootPanel.getElementsByTagName("input"))i.blur();for(let i of this.rootPanel.getElementsByTagName("textarea"))i.blur();for(let i of this.rootPanel.getElementsByTagName("select"))i.blur()}},this.pathResolver=new Np(this),this.consoleHandler=new Yu,this.dialogHandler=new Xu,window.setTimeout(()=>this.step()),new ju(this,e,this.g.hitCanvas)}rootPanel;g;ctx;pvEngine;pathResolver;fontResolver;consoleHandler;dialogHandler;formatter;repaintRequested=!1;_editMode=!1;_showGrid=!1;_showOutline=!1;_showRuler=!1;_selection=[];_scale=1;_transparent=!1;refreshCycle=100;imagesPrefix="";absPrefix="";relPrefix="";instance;eventListeners={closedisplay:[],opendisplay:[],openpv:[],runcommand:[],runprocedure:[],selection:[],scale:[]};displayRegion;addProvider(t){this.pvEngine.addProvider(t)}addScriptLibrary(t,e){this.pvEngine.addScriptLibrary(t,e)}setPathResolver(t){this.pathResolver=t}getPathResolver(){return this.pathResolver}setConsoleHandler(t){this.consoleHandler=t}getConsoleHandler(){return this.consoleHandler}setDialogHandler(t){this.dialogHandler=t}getDialogHandler(){return this.dialogHandler}setFontResolver(t){this.fontResolver=t}getFontResolver(){return this.fontResolver}step(){this.repaintRequested&&(this.g.clearHitCanvas(),this.drawScreen(),this.repaintRequested=!1),window.setTimeout(()=>this.step(),this.refreshCycle)}drawScreen(){if(this.instance?(this.rootPanel.style.height=this.instance.holderHeight+"px",this.rootPanel.style.width=this.instance.holderWidth+"px"):(this.rootPanel.style.height="0px",this.rootPanel.style.width="0px"),this.g.resize(this.rootPanel.clientWidth,this.rootPanel.clientHeight),this.transparent&&this.g.clearCanvas(),this.editMode){let t=document.createElement("canvas"),e=t.getContext("2d");t.width=16,t.height=16,e.fillStyle="#d6d6d6",e.fillRect(0,0,8,8),e.fillRect(8,8,8,8),this.ctx.fillStyle=this.ctx.createPattern(t,"repeat"),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.instance&&this.g.fillRect(A(C({},this.instance.bounds),{color:this.instance.backgroundColor}))}else this.transparent||this.g.fillCanvas(this.instance?.backgroundColor||m.WHITE);if(this.g.addHitRegion(this.displayRegion).addRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.showGrid&&this.instance){let t=document.createElement("canvas"),e=t.getContext("2d");t.width=25,t.height=25,e.fillStyle=this.instance.foregroundColor.toString(),e.fillRect(0,0,2,1),this.ctx.fillStyle=this.ctx.createPattern(t,"repeat"),this.ctx.fillRect(25,25,this.ctx.canvas.width-50,this.ctx.canvas.height-50)}if(this.showRuler){this.ctx.lineWidth=1,this.ctx.strokeStyle="grey",this.ctx.textBaseline="bottom",this.ctx.textAlign="center",this.ctx.fillStyle="grey",this.ctx.font="12px Arial";let t=0;for(;t<=this.ctx.canvas.width;)t+=100,this.ctx.beginPath(),this.ctx.moveTo(t-75+.5,this.ctx.canvas.height),this.ctx.lineTo(t-75+.5,this.ctx.canvas.height-4),this.ctx.moveTo(t-50+.5,this.ctx.canvas.height),this.ctx.lineTo(t-50+.5,this.ctx.canvas.height-6),this.ctx.moveTo(t-25+.5,this.ctx.canvas.height),this.ctx.lineTo(t-25+.5,this.ctx.canvas.height-4),this.ctx.moveTo(t+.5,this.ctx.canvas.height),this.ctx.lineTo(t+.5,this.ctx.canvas.height-8),this.ctx.stroke(),this.ctx.fillText(String(t),t,this.ctx.canvas.height-8);this.ctx.textAlign="right",this.ctx.textBaseline="middle";let e=0;for(;e<=this.ctx.canvas.height;)e+=100,this.ctx.beginPath(),this.ctx.moveTo(this.ctx.canvas.width,e-75+.5),this.ctx.lineTo(this.ctx.canvas.width-4,e-75+.5),this.ctx.moveTo(this.ctx.canvas.width,e-50+.5),this.ctx.lineTo(this.ctx.canvas.width-6,e-50+.5),this.ctx.moveTo(this.ctx.canvas.width,e-25+.5),this.ctx.lineTo(this.ctx.canvas.width-4,e-25+.5),this.ctx.moveTo(this.ctx.canvas.width,e+.5),this.ctx.lineTo(this.ctx.canvas.width-8,e+.5),this.ctx.stroke(),this.ctx.fillText(String(e),this.ctx.canvas.width-8,e)}this.showOutline&&this.instance&&(this.ctx.lineWidth=1,this.ctx.setLineDash([10,5]),this.ctx.strokeStyle="black",this.ctx.strokeRect(-.5,-.5,this.instance.holderWidth+1,this.instance.holderHeight+1),this.ctx.setLineDash([])),this.instance&&this.instance.draw(this.g);for(let t of this.selection){let e=this.findWidget(t);e&&e.drawSelection(this.ctx)}}requestRepaint(){this.repaintRequested=!0}setTooltip(t){this.rootPanel.title=t?.trim()??""}createWidget(t,e){switch(t){case yg:return new zd(this,e);case vg:return new Ac(this,e);case bg:return new rc(this,e);case Tg:return new sc(this,e);case Sg:return new Wc(this,e);case Vg:return new nc(this,e);case Cg:return new dc(this,e);case Ag:case _g:return new cc(this,e);case Lg:return new _c(this,e);case Pg:return new Oc(this,e);case kg:return new gg(this,e);case Mg:return new Lc(this,e);case Rg:return new gc(this,e);case Eg:return new Gc(this,e);case Wg:return new Uc(this,e);case Bg:return new Pc(this,e);case Ig:return new qc(this,e);case Hg:return new $d(this,e);case Dg:return new mc(this,e);case Ng:return new Zc(this,e);case Fg:return new fc(this,e);case $g:return new kc(this,e);case Og:return new Mc(this,e);case Gg:return new Jc(this,e);case zg:return new Tc(this,e);case Ug:return new Rc(this,e);case qg:return new Ec(this,e);case Yg:return new Sc(this,e);case Xg:return new yd(this,e);case Kg:return new xg(this,e);case jg:return new tg(this,e);case Zg:return new Cc(this,e);case Jg:return new eg(this,e);case Qg:return new ig(this,e);case tm:return new wg(this,e);case em:return new cg(this,e);default:console.warn(`Unsupported widget type: ${t}`)}}destroy(){this.instance?.destroy(),this.instance=void 0,this.pvEngine.clearState(),this.requestRepaint()}resolvePath(t,e){return this.pathResolver.resolve(t,e)}setSource(t,e){this.reset();let i=t.lastIndexOf("/")+1;return this.relPrefix=t.substring(0,i),new Promise((r,s)=>{fetch(t,{credentials:"same-origin"}).then(o=>{o.ok&&o.text().then(a=>{this.setSourceString(a,e),r()}).catch(a=>s(a))}).catch(o=>s(o))})}setSourceString(t,e){this.reset(),this.instance=new Fd(this,void 0,e);let i=Nd.parseFromXML(t);this.instance.parseNode(i),this.pvEngine.init(),this.requestRepaint()}getRefreshCycle(){return this.refreshCycle}setRefreshCycle(t){this.refreshCycle=t}reset(){this.instance&&(this.clearSelection(),this.pvEngine.clearState(),this.instance.destroy(),this.instance=void 0)}measureAbsoluteArea(t){let e=t.bounds,i=t.parent;for(;i;){if(e.x+=i.x,e.y+=i.y,i instanceof yd){let{x:r,y:s}=i.measureTabOffset(this.g);e.x+=r,e.y+=s}i=i.parent}return e.x+=t.x-t.holderX,e.y+=t.y-t.holderY,e.width+=t.width-t.holderWidth,e.height+=t.height-t.holderHeight,e.x+=this.scale*1,e.y+=this.scale*1,e}addEventListener(t,e){if(!(t in this.eventListeners))throw new Error(`Unknown event '${t}'`);this.eventListeners[t].push(e)}removeEventListener(t,e){if(!(t in this.eventListeners))throw new Error(`Unknown event '${t}'`);this.eventListeners[t]=this.eventListeners[t].filter(i=>i!==e)}fireEvent(t,e){this.eventListeners[t].forEach(i=>i(e))}get showGrid(){return this._showGrid}set showGrid(t){this._showGrid=t,this.requestRepaint()}get showOutline(){return this._showOutline}set showOutline(t){this._showOutline=t,this.requestRepaint()}get showRuler(){return this._showRuler}set showRuler(t){this._showRuler=t,this.requestRepaint()}get selection(){return this._selection}set selection(t){this._selection=t,this.requestRepaint();let e={selected:this._selection.slice()};this.fireEvent("selection",e)}get editMode(){return this._editMode}set editMode(t){this._editMode=t,this.requestRepaint()}get scale(){return this._scale}set scale(t){this._scale=t,this.requestRepaint();let e={scale:t};this.fireEvent("scale",e)}get transparent(){return this._transparent}set transparent(t){this._transparent=t,this.requestRepaint()}get utc(){return this.formatter.utc}set utc(t){this.formatter.utc=t,this.requestRepaint()}get widgets(){return this.instance?this.instance.widgets:[]}clearSelection(){this.selection.length&&(this.selection=[])}findWidget(t){if(this.instance)return this.instance.findWidget(t)}findWidgetByName(t){if(this.instance)return this.instance.findWidgetByName(t)}getPVNames(){return this.pvEngine.getPVNames()}getPV(t){return this.pvEngine.getPV(t)}setValues(t){this.pvEngine.setValues(t)}copyCanvas(t){t||(t={x:0,y:0,width:this.g.canvas.width,height:this.g.canvas.height});let e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(this.g.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),e}toDataURL(t="image/png",e){return this.g.ctx.canvas.toDataURL(t,e)}};export{xp as a,Np as b,Gp as c,lm as d};
